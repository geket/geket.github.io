const t={canvas:null,ctx:null,isActive:!1,isPaused:!1,camera:{x:0,y:5,z:0,rotX:0,rotY:0,sneaking:!1,normalHeight:.6,sneakHeight:.2},velocity:{x:0,y:0,z:0},world:{},keys:{},isJumping:!1,gravity:-.035,lastPos:{x:0,z:0},pointerLocked:!1,inWater:!1,inLava:!1,swimming:!1,headSubmergedWater:!1,headSubmergedLava:!1,lastSwimTime:0,swimDebugInfo:null,playerEyeHeight:1.2,playerHeight:1.8,birds:[],pestBirds:[],blueBirds:[],fish:[],cats:[],creepers:[],dialogueOpen:!1,currentDialogueNPC:null,journalOpen:!1,quests:[],questData:{meet_gunsmith:{id:"meet_gunsmith",title:"The Mysterious Wizard",description:"A wandering gunsmith has appeared! Perhaps he knows something about the bird invasion?",objectives:["Speak with the Gunsmith"],status:"active",stage:0,reward:null},birds_origin:{id:"birds_origin",title:"Origin of the Feathered Menace",description:"The Gunsmith believes there's a source to this madness. Find clues about where these birds are coming from.",objectives:["Survive 3 bird waves","Collect 50 bird drops","Return to the Gunsmith"],status:"locked",stage:0,progress:{waves:0,drops:0,returned:!1},reward:"Ancient Map Fragment"}},gunsmithDialogueStage:0,gunsmithMetBefore:!1,selectedSlot:0,selectedBlock:"grass",selectedItem:null,hotbarTooltip:{visible:!1,text:"",timestamp:0},inventory:{hotbar:[{type:"block",id:"grass",count:64},{type:"block",id:"dirt",count:64},{type:"block",id:"stone",count:64},{type:"block",id:"wood",count:64},{type:"block",id:"brick",count:64},{type:"bucket",id:"water_bucket",count:5},{type:"bucket",id:"lava_bucket",count:5},{type:"weapon",id:"ka69",count:1,durability:100,maxDurability:100},null],main:[{type:"block",id:"leaves",count:64},{type:"block",id:"sand",count:64},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],craftingResult:null},recipes:[{ingredients:[{id:"wood",count:4}],result:{type:"block",id:"wood",count:16},name:"Planks"},{ingredients:[{id:"stone",count:8}],result:{type:"block",id:"brick",count:4},name:"Bricks"},{ingredients:[{id:"sand",count:4}],result:{type:"block",id:"stone",count:2},name:"Sandstone"},{ingredients:[{id:"wood",count:8}],result:{type:"block",id:"chest",count:1},name:"Chest"},{ingredients:[{id:"wood",count:6}],result:{type:"block",id:"barrel",count:1},name:"Barrel"},{ingredients:[{id:"wood",count:4}],result:{type:"block",id:"crate",count:1},name:"Crate"},{ingredients:[{id:"stone",count:8},{id:"deepslate",count:4}],result:{type:"block",id:"furnace",count:1},name:"Furnace"},{ingredients:[{id:"moonstone",count:2},{id:"stone",count:4}],result:{type:"block",id:"alchemyTable",count:1},name:"Alchemy Table"},{ingredients:[{id:"glowstone",count:4}],result:{type:"block",id:"glowstone",count:8},name:"Refined Glowstone"},{ingredients:[{id:"sakuraite",count:4},{id:"wood",count:8}],result:{type:"block",id:"storageShrine",count:1},name:"Storage Shrine"}],fluidUpdates:[],fluidLevels:{},fluidUpdateTimer:0,birdPruneTimer:0,shootCooldown:0,muzzleFlash:0,particles:[],inventoryOpen:!1,draggedItem:null,dragSource:null,lastMouseX:0,lastMouseY:0,craftingCollapsed:!0,containerOpen:!1,openContainerPos:null,openContainerType:null,containerSlots:27,stats:{blocksPlaced:0,blocksBroken:0,distance:0,jumps:0,startTime:0},settings:{brightness:100,filter:"none",renderDistance:20,shadows:!0,lighting:!0,antialiasing:!1,showFps:!0,targetFps:60,treeStyle:"simple",textureMode:"fixed"},fpsCounter:{frames:0,lastTime:0,fps:0},noise2D:function(){const t=[];for(let o=0;o<512;o++)t[o]=Math.floor(256*Math.random());function e(t){return t*t*t*(t*(6*t-15)+10)}function i(t,e,i){return t+i*(e-t)}function s(t,e,i){const s=3&t,o=s<2?e:i,a=s<2?i:e;return(1&s?-o:o)+(2&s?-a:a)}return function(o,a){const n=255&Math.floor(o),l=255&Math.floor(a);o-=Math.floor(o),a-=Math.floor(a);const r=e(o),h=e(a),c=t[n]+l,d=t[n+1]+l;return i(i(s(t[c],o,a),s(t[d],o-1,a),r),i(s(t[c+1],o,a-1),s(t[d+1],o-1,a-1),r),h)}}(),fbm(t,e,i=4){let s=0,o=1,a=1,n=0;for(let l=0;l<i;l++)s+=this.noise2D(t*a,e*a)*o,n+=o,o*=.5,a*=2;return s/n},blockColors:{grass:{top:"#7cba5f",side:"#8b6b4a",bottom:"#6b4423",useTexture:!0,texture:"grass"},dirt:{top:"#8b6b4a",side:"#8b6b4a",bottom:"#8b6b4a",useTexture:!0,texture:"dirt"},stone:{top:"#888888",side:"#777777",bottom:"#666666"},wood:{top:"#a0825a",side:"#6b4423",bottom:"#6b4423",useTexture:!0,texture:"wood"},leaves:{top:"#32b432",side:"#28a028",bottom:"#1e8c1e",transparent:!1,useTexture:!0,texture:"leaves"},appleLeaves:{top:"#32b432",side:"#28a028",bottom:"#1e8c1e",transparent:!1,useTexture:!0,texture:"leaves"},water:{top:"rgba(74, 144, 217, 0.7)",side:"rgba(58, 128, 201, 0.7)",bottom:"rgba(42, 112, 185, 0.7)",transparent:!0,animated:!0,useTexture:!0,texture:"water"},sand:{top:"#e6d9a0",side:"#d9cc93",bottom:"#ccbf86"},brick:{top:"#b35050",side:"#a04040",bottom:"#903030",useTexture:!0,texture:"brick"},lava:{top:"#ff6600",side:"#ff4400",bottom:"#cc3300",animated:!0,useTexture:!0,texture:"lava"},obsidian:{top:"#1a0a2e",side:"#140820",bottom:"#0a0410"},cherryWood:{top:"#c4a07a",side:"#8b5a5a",bottom:"#8b5a5a",useTexture:!0,texture:"wood"},cherryLeaves:{top:"#ffb7c5",side:"#ffc0cb",bottom:"#ff90a5",transparent:!1,useTexture:!0,texture:"sakuraLeaves"},chest:{top:"#8b6914",side:"#a0780a",bottom:"#705010"},ritualChest:{top:"#daa520",side:"#cd853f",bottom:"#8b4513"},buildingChest:{top:"#a0825a",side:"#8b6914",bottom:"#705010"},bedrock:{top:"#1a1a1a",side:"#0f0f0f",bottom:"#050505"},deepslate:{top:"#3a3a3a",side:"#2a2a2a",bottom:"#1a1a1a"},mossyStone:{top:"#6a8866",side:"#5a7856",bottom:"#4a6846"},sakuraite:{top:"#ff69b4",side:"#ff1493",bottom:"#c71585",glow:!0},moonstone:{top:"#e6e6fa",side:"#d8bfd8",bottom:"#dda0dd",glow:!0},jadite:{top:"#00a86b",side:"#009060",bottom:"#007850"},crimsonite:{top:"#dc143c",side:"#b22222",bottom:"#8b0000"},voidstone:{top:"#2d1b4e",side:"#1a0d2e",bottom:"#0d0617",glow:!0},spirite:{top:"#87ceeb",side:"#6bb3d9",bottom:"#4f98c7"},dungeonBrick:{top:"#4a4a5a",side:"#3a3a4a",bottom:"#2a2a3a"},dungeonMossy:{top:"#4a5a4a",side:"#3a4a3a",bottom:"#2a3a2a"},dungeonChest:{top:"#8b4513",side:"#a0522d",bottom:"#654321"},spikeTrap:{top:"#5a5a5a",side:"#4a4a4a",bottom:"#3a3a3a"},barrel:{top:"#8b6914",side:"#a0780a",bottom:"#8b6914"},crate:{top:"#c4a07a",side:"#a08060",bottom:"#806040"},furnace:{top:"#555555",side:"#666666",bottom:"#444444"},furnaceActive:{top:"#555555",side:"#886644",bottom:"#444444"},alchemyTable:{top:"#4a3a3a",side:"#3a2a2a",bottom:"#2a1a1a"},storageShrine:{top:"#ffd700",side:"#daa520",bottom:"#b8860b"},ritualStone:{top:"#4a4a6a",side:"#3a3a5a",bottom:"#2a2a4a"},petalSocket:{top:"#ffb7c5",side:"#8b5a5a",bottom:"#5a3a3a"},ropeSocket:{top:"#8b7355",side:"#6b5a45",bottom:"#4b3a25"},charmSocket:{top:"#ffd700",side:"#daa520",bottom:"#b8860b"},plaqueSocket:{top:"#deb887",side:"#c4a07a",bottom:"#8b7355"},incenseSocket:{top:"#9370db",side:"#7b68ee",bottom:"#6a5acd"},petalSocketFilled:{top:"#ff69b4",side:"#ff1493",bottom:"#c71585"},ropeSocketFilled:{top:"#daa520",side:"#b8860b",bottom:"#8b6914"},charmSocketFilled:{top:"#fff700",side:"#ffd700",bottom:"#ffb700"},plaqueSocketFilled:{top:"#f4a460",side:"#d2691e",bottom:"#a0522d"},incenseSocketFilled:{top:"#da70d6",side:"#ba55d3",bottom:"#9932cc"},whiteBrick:{top:"#f0f0f0",side:"#e0e0e0",bottom:"#d0d0d0"},redBrick:{top:"#b35050",side:"#a04040",bottom:"#903030"},glowstone:{top:"#ffdd88",side:"#eebb66",bottom:"#ddaa44"},table:{top:"#a0825a",side:"#6b4423",bottom:"#5a3a1a",useTexture:!0,texture:"wood"},chair:{top:"#8b6914",side:"#705010",bottom:"#5a400a"},bed:{top:"#c04040",side:"#a03030",bottom:"#802020"},bedPillow:{top:"#f0f0f0",side:"#e0e0e0",bottom:"#d0d0d0"},cashRegister:{top:"#404040",side:"#303030",bottom:"#202020"},stool:{top:"#c04040",side:"#a03030",bottom:"#802020"},counter:{top:"#e0e0e0",side:"#c0c0c0",bottom:"#a0a0a0"},lamp:{top:"#ffee88",side:"#ffdd66",bottom:"#eebb44"},bookshelf:{top:"#6b4423",side:"#8b6914",bottom:"#5a3a1a"},plant:{top:"#32b432",side:"#28a028",bottom:"#1e8c1e"},sink:{top:"#d0d0d0",side:"#b0b0b0",bottom:"#909090"},stove:{top:"#404040",side:"#303030",bottom:"#ff4400"},fridge:{top:"#e0e0e0",side:"#d0d0d0",bottom:"#c0c0c0"}},textureCache:{},blockModels:{table:[.1,0,.1,.8,.5,.8],chair:[.15,0,.15,.7,.6,.7],stool:[.2,0,.2,.6,.5,.6],bed:[.05,0,.05,.9,.4,.9],bedPillow:[.25,.4,.25,.5,.25,.5],counter:[0,0,0,1,.6,1],cashRegister:[.2,0,.2,.6,.5,.6],lamp:[.35,0,.35,.3,.7,.3],plant:[.3,0,.3,.4,.6,.4],sink:[.1,0,.1,.8,.5,.8],stove:[0,0,0,1,.6,1],fridge:[.05,0,.05,.9,1,.9],bookshelf:[0,0,0,1,1,.8],chest:[.1,0,.1,.8,.7,.8],ritualChest:[.1,0,.1,.8,.7,.8],buildingChest:[.1,0,.1,.8,.7,.8],dungeonChest:[.1,0,.1,.8,.7,.8],barrel:[.1,0,.1,.8,.9,.8],crate:[.05,0,.05,.9,.8,.9],furnace:[0,0,0,1,.9,1],alchemyTable:[0,0,0,1,.7,1],storageShrine:[.15,0,.15,.7,.8,.7]},itemTypes:{grass:{stackable:!0,maxStack:64},dirt:{stackable:!0,maxStack:64},stone:{stackable:!0,maxStack:64},wood:{stackable:!0,maxStack:64},leaves:{stackable:!0,maxStack:64},appleLeaves:{stackable:!0,maxStack:64},sand:{stackable:!0,maxStack:64},brick:{stackable:!0,maxStack:64},cherryWood:{stackable:!0,maxStack:64},cherryLeaves:{stackable:!0,maxStack:64},chest:{stackable:!0,maxStack:16},obsidian:{stackable:!0,maxStack:64},whiteBrick:{stackable:!0,maxStack:64},redBrick:{stackable:!0,maxStack:64},glowstone:{stackable:!0,maxStack:64},ritualStone:{stackable:!0,maxStack:64},lava:{stackable:!1,maxStack:1},water:{stackable:!1,maxStack:1},deepslate:{stackable:!0,maxStack:64},mossyStone:{stackable:!0,maxStack:64},dungeonBrick:{stackable:!0,maxStack:64},dungeonMossy:{stackable:!0,maxStack:64},barrel:{stackable:!0,maxStack:16,description:"Wooden storage barrel"},crate:{stackable:!0,maxStack:16,description:"Sturdy storage crate"},furnace:{stackable:!0,maxStack:16,description:"Smelt ores into ingots"},alchemyTable:{stackable:!0,maxStack:8,description:"Brew mysterious potions"},storageShrine:{stackable:!0,maxStack:4,description:"Sacred storage with extra capacity"},dungeonChest:{stackable:!0,maxStack:8,description:"Ancient treasure chest"},ritualChest:{stackable:!0,maxStack:8,description:"Mystical chest"},buildingChest:{stackable:!0,maxStack:16,description:"Standard storage chest"},sakuraite:{stackable:!0,maxStack:64,description:"Rare pink crystal ore - glows faintly"},moonstone:{stackable:!0,maxStack:64,description:"Lunar ore that shimmers in darkness"},jadite:{stackable:!0,maxStack:64,description:"Precious jade ore from deep caverns"},crimsonite:{stackable:!0,maxStack:64,description:"Volcanic ore pulsing with heat"},voidstone:{stackable:!0,maxStack:64,description:"Mysterious ore from the deepest depths"},spirite:{stackable:!0,maxStack:64,description:"Crystallized spirit essence"},apple:{stackable:!0,maxStack:64,throwable:!0,description:"Throw at birds to knock them away"},water_bucket:{stackable:!0,maxStack:16},lava_bucket:{stackable:!0,maxStack:16},ka69:{stackable:!1,maxStack:1,durability:100,maxDurability:100,description:"Shoots bullets at birds"},seeds:{stackable:!0,maxStack:64,description:"Calms angry birds temporarily"},berdger:{stackable:!1,maxStack:1,invincible:!0,description:"The legendary bird repellent - infinite uses!"},sakuraPetal:{stackable:!0,maxStack:16,description:"Sacred cherry blossom petal",ritual:!0},shimenawa:{stackable:!0,maxStack:1,description:"Sacred rope",ritual:!0},omamori:{stackable:!0,maxStack:1,description:"Protective charm base",ritual:!0},ema:{stackable:!0,maxStack:1,description:"Wooden wish plaque",ritual:!0},incense:{stackable:!0,maxStack:1,description:"Purifying incense",ritual:!0},table:{stackable:!0,maxStack:16,description:"Wooden dining table"},chair:{stackable:!0,maxStack:16,description:"Comfortable chair"},bed:{stackable:!0,maxStack:8,description:"Cozy bed for resting"},bedPillow:{stackable:!0,maxStack:8,description:"Soft pillow"},cashRegister:{stackable:!0,maxStack:8,description:"Store cash register"},stool:{stackable:!0,maxStack:16,description:"Simple stool"},counter:{stackable:!0,maxStack:16,description:"Kitchen counter"},lamp:{stackable:!0,maxStack:16,description:"Light source"},bookshelf:{stackable:!0,maxStack:8,description:"Filled with books"},plant:{stackable:!0,maxStack:16,description:"Decorative plant"},sink:{stackable:!0,maxStack:8,description:"Kitchen sink"},stove:{stackable:!0,maxStack:8,description:"Cooking stove"},fridge:{stackable:!0,maxStack:8,description:"Refrigerator"}},fluidBlocks:["water","lava"],ritualItems:["sakuraPetal","shimenawa","omamori","ema","incense"],ritualComplete:!1,ritualBlessingActive:!1,ritualBlessingTimer:0,ritualFlight:!1,ritualFlightTimer:0,ritualBarrierActive:!1,init(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.initialized=!1,this.gameLoopId=null,this.lastFrameTime=0},async fullInit(){this.initialized||(await this.generateWorld(),this.setupControls(),this.setupMenus(),this.setupDebugConsole(),this.initialized=!0,this.updateHotbarDisplay(),setTimeout(()=>this.updateHotbarDisplay(),50),setTimeout(()=>this.updateHotbarDisplay(),150),setTimeout(()=>this.updateHotbarDisplay(),300))},async generateWorld(){this.world={},this.fluidLevels={},this.droppedItems=[],this.cherryTrees=[],this.petalParticles=[],this.buildings=[],this.structureQueue=[],this.biomeMap={},this.biomeRegions=[];const t=150;this.worldBounds={minX:-150,maxX:151,minZ:-150,maxZ:151,minY:0,maxY:60},this.wind={x:0,z:0,targetX:0,targetZ:0,gustTimer:0,strength:.02};const e=["üí° Tip: Press E to open your inventory","üí° Tip: Hold SHIFT to sneak and not fall off edges","üí° Tip: Collect ritual items to complete the Omamori blessing","üí° Tip: Watch out for pest birds - they attack!","üí° Tip: Find the WcDonald's for a tasty Berdger","üí° Tip: Cherry trees drop sakura petals in the wind","üí° Tip: Press ` (backtick) to open debug console","üí° Tip: Different biomes have unique terrain features","üí° Tip: Mountains have the best views!","üí° Tip: Explore to find hidden ritual chests"],i={plains:{icon:"üåæ",name:"Plains",color:"#7cba5f",treeChance:.05,heightMod:0},forest:{icon:"üå≤",name:"Forest",color:"#2d5a27",treeChance:.35,heightMod:2},sakuraForest:{icon:"üå∏",name:"Sakura Forest",color:"#ffb7c5",treeChance:.4,heightMod:1},desert:{icon:"üèúÔ∏è",name:"Desert",color:"#e6d9a0",treeChance:0,heightMod:-1},mountains:{icon:"‚õ∞Ô∏è",name:"Mountains",color:"#888888",treeChance:.08,heightMod:12},ocean:{icon:"üåä",name:"Ocean",color:"#4a90d9",treeChance:0,heightMod:-8}},s=document.getElementById("loadingTips");let o=Math.floor(Math.random()*e.length);s&&(s.innerHTML=`<div class="tip-text">${e[o]}</div>`);const a=setInterval(()=>{s&&(o=(o+1)%e.length,s.innerHTML=`<div class="tip-text">${e[o]}</div>`)},3e3),n=(t,e,i="",s="üåç",o="World")=>{const a=document.getElementById("loadingPhase"),n=document.getElementById("loadingBar"),l=document.getElementById("loadingPercent"),r=document.getElementById("loadingDetails"),h=document.getElementById("biomeIcon"),c=document.getElementById("biomeName");a&&(a.textContent=t),n&&(n.style.width=e+"%"),l&&(l.textContent=Math.floor(e)+"%"),r&&(r.textContent=i),h&&(h.textContent=s),c&&(c.textContent=o)},l=()=>new Promise(t=>setTimeout(t,0));n("Generating Biomes...",0,"Creating biome seeds","üåç","World"),await l();const r=[],h=Object.keys(i),c=[{x:-90,z:-90},{x:90,z:-90},{x:-90,z:90},{x:90,z:90},{x:0,z:-105},{x:0,z:105}];h.forEach((t,e)=>{const i=c[e%c.length];r.push({x:i.x+40*(Math.random()-.5),z:i.z+40*(Math.random()-.5),type:t})});for(let $=0;$<25;$++)r.push({x:(Math.random()-.5)*t*1.8,z:(Math.random()-.5)*t*1.8,type:h[Math.floor(Math.random()*h.length)]});r.push({x:0,z:0,type:"plains"}),this.biomeSeeds=r;const d=(t,e)=>{let i=1/0,s="plains";for(const o of r){const a=t-o.x,n=e-o.z,l=20*this.noise2D(.02*t+o.x,.02*e+o.z),r=Math.sqrt(a*a+n*n)+l;r<i&&(i=r,s=o.type)}return s};n("Generating Terrain...",5,"Calculating height map","‚õ∞Ô∏è","Mountains"),await l();const u={},g={};for(let $=-150;$<=t;$++){for(let e=-150;e<=t;e++){const s=`${$},${e}`,o=d($,e);g[s]=o;const a=i[o],n=8*this.fbm(.02*$,.02*e,3),l=4*this.fbm(.05*$+100,.05*e+100,2);let r=0;"mountains"===o&&(r=15*Math.abs(this.fbm(.03*$,.03*e,4)));let h=0;"ocean"===o&&(h=4*-Math.abs(this.fbm(.04*$,.04*e,2)));const c=Math.sqrt($*$+e*e)/t,f=Math.max(0,1-.3*Math.pow(c,2));let m=Math.floor(8+(n+l+a.heightMod+r+h)*f);m=Math.max(1,Math.min(35,m)),u[s]=m}if($%20==0){n("Generating Terrain...",5+($+t)/300*25,`Column ${$+t} of 300`,"üó∫Ô∏è","Terrain"),await l()}}n("Placing Blocks...",30,"Building terrain","üß±","Terrain"),await l();const f=(t,e,i,s=.08)=>.6*this.noise2D(t*s+.5*e,i*s)+.3*this.noise2D(e*s*.7,t*s+.3*i)+.1*this.noise2D(i*s+.2*t,e*s*.5),m=(t,e,i)=>{const s=10*this.noise2D(.04*t,.04*i);this.noise2D(.04*t+100,.04*i+100);const o=8+6*this.noise2D(.02*t,.02*i);return Math.sqrt((e-o)**2+(3*Math.sin(.1*t+s))**2)<2.5+1.5*this.noise2D(.1*t,.1*i)},p=[{type:"jadite",minY:5,maxY:25,chance:.008,veinSize:3},{type:"spirite",minY:8,maxY:30,chance:.006,veinSize:4},{type:"crimsonite",minY:2,maxY:15,chance:.005,veinSize:3},{type:"moonstone",minY:10,maxY:35,chance:.004,veinSize:2},{type:"sakuraite",minY:5,maxY:20,chance:.003,veinSize:2},{type:"voidstone",minY:1,maxY:8,chance:.001,veinSize:1}],y=[];for(let $=-150;$<=t;$++){for(let e=-150;e<=t;e++){const t=`${$},${e}`,i=u[t],s=g[t],o=i<=7&&i>=5;for(let a=0;a<=i;a++){const t=f($,a,e),n=a>3&&a<i-4&&m($,a,e);if((t>.35&&a>2&&a<i-3||n)&&"ocean"!==s)continue;let l;if(l=0===a||a<=2&&Math.random()<.7?"bedrock":a<6?"deepslate":a<i-3?this.noise2D(.3*$,.3*e+.2*a)>.6?"mossyStone":"stone":a<i?"ocean"===s||"desert"===s||o?"sand":"mountains"===s&&i>20?"stone":a===i-1?"dirt":"stone":"ocean"===s||i<6||"desert"===s||o?"sand":"mountains"===s&&i>20?"stone":"grass",this.setBlock($,a,e,l),("stone"===l||"deepslate"===l)&&a>0&&a<i-2)for(const i of p)a>=i.minY&&a<=i.maxY&&Math.random()<i.chance&&y.push({x:$,y:a,z:e,type:i.type,size:i.veinSize})}if(i<6)for(let a=i+1;a<=6;a++)this.setBlock($,a,e,"water"),this.setFluidLevel($,a,e,8)}if($%25==0){n("Carving Caves...",30+($+t)/300*20,`Column ${$+t}`,"‚õèÔ∏è","Underground"),await l()}}n("Generating Ores...",50,`Placing ${y.length} ore veins`,"üíé","Ores"),await l();for(const $ of y)for(let t=0;t<$.size;t++){const t=$.x+Math.floor(3*Math.random())-1,e=$.y+Math.floor(3*Math.random())-1,i=$.z+Math.floor(3*Math.random())-1,s=this.getBlock(t,e,i);"stone"!==s&&"deepslate"!==s||this.setBlock(t,e,i,$.type)}n("Building Dungeons...",55,"Creating treasure rooms","üèõÔ∏è","Dungeons"),await l();const b=Math.floor(10),v=[];for(let $=0;$<b;$++){const e=Math.floor(Math.random()*t*1.5)-112.5,i=Math.floor(Math.random()*t*1.5)-112.5,s=5+Math.floor(15*Math.random()),o=u[`${Math.floor(e)},${Math.floor(i)}`];if(!o||s>=o-5)continue;const a=5+Math.floor(4*Math.random()),n=4+Math.floor(2*Math.random()),l=5+Math.floor(4*Math.random());for(let t=0;t<a;t++)for(let o=0;o<n;o++)for(let r=0;r<l;r++){const h=Math.floor(e)+t,c=s+o,d=Math.floor(i)+r;if(0===o)this.setBlock(h,c,d,Math.random()<.3?"dungeonMossy":"dungeonBrick");else if(0===t||t===a-1||0===r||r===l-1)o<n-1&&this.setBlock(h,c,d,Math.random()<.2?"dungeonMossy":"dungeonBrick");else if(o===n-1)this.setBlock(h,c,d,"dungeonBrick");else{const t=this.getBlock(h,c,d);t&&"water"!==t&&"lava"!==t&&delete this.world[`${h},${c},${d}`]}}const r=Math.floor(e)+Math.floor(a/2),h=s+1,c=Math.floor(i)+Math.floor(l/2);this.setBlock(r,h,c,"dungeonChest");const d=[{type:"sakuraite",count:2+Math.floor(4*Math.random())},{type:"moonstone",count:1+Math.floor(3*Math.random())},{type:"jadite",count:3+Math.floor(5*Math.random())},{type:"apple",count:5+Math.floor(5*Math.random())},{type:"glowstone",count:4+Math.floor(8*Math.random())},{type:"crimsonite",count:1+Math.floor(3*Math.random())},{type:"voidstone",count:1+Math.floor(2*Math.random())},{type:"spirite",count:2+Math.floor(4*Math.random())}];this.chestContents=this.chestContents||{};const g=[],f=2+Math.floor(3*Math.random());for(let t=0;t<f;t++){const t=d[Math.floor(Math.random()*d.length)];g.push({type:t.type,count:t.count})}if(this.chestContents[`${r},${h},${c}`]=g,a>=7&&Math.random()<.6){const t=Math.floor(e)+1,o=Math.floor(i)+1;this.setBlock(t,s+1,o,"barrel"),this.chestContents[`${t},${s+1},${o}`]=[{type:"apple",count:3+Math.floor(5*Math.random())}]}if(a>=6&&Math.random()<.4){const t=Math.floor(e)+a-2,o=Math.floor(i)+1;this.setBlock(t,s+1,o,"furnace"),this.chestContents[`${t},${s+1},${o}`]=[{type:Math.random()<.5?"crimsonite":"deepslate",count:1+Math.floor(3*Math.random())}]}if(Math.random()<.2){const t=Math.floor(e)+Math.floor(a/2)-1,o=Math.floor(i)+l-2;this.setBlock(t,s+1,o,"alchemyTable"),this.chestContents[`${t},${s+1},${o}`]=[{type:"moonstone",count:1},{type:"spirite",count:2}]}this.setBlock(Math.floor(e)+1,s+n-1,Math.floor(i)+1,"glowstone"),this.setBlock(Math.floor(e)+a-2,s+n-1,Math.floor(i)+l-2,"glowstone"),v.push({x:e,y:s,z:i})}console.log(`Generated ${v.length} dungeons, ${y.length} ore veins`),n("Constructing Buildings...",60,"Planning structures","üè†","Village"),await l();const x=["church","house1","house2","house3","grocery","wcdonalds"],k=25;let M=0,S=0;const w=[];for(let $=-Math.floor(6);$<=Math.floor(6);$++){for(let t=-Math.floor(6);t<=Math.floor(6);t++){if(Math.abs($)<=1&&Math.abs(t)<=1)continue;const e=$*k,i=t*k,s=d(e+12.5,i+12.5);if("ocean"===s||"mountains"===s)continue;const o=2+Math.floor(4*Math.random());for(let t=0;t<o;t++){const t=e+5+Math.floor(13*Math.random()),s=i+5+Math.floor(13*Math.random());S<4&&Math.random()<.15&&this.tryPlaceBuilding(t,s,["wcdonalds"],u)?(S++,M++,w.push({x:t-2,z:s-2,w:20,d:18})):this.tryPlaceBuilding(t,s,x,u)&&(M++,w.push({x:t-2,z:s-2,w:14,d:14}))}}n("Constructing Buildings...",60+($+Math.floor(6))/(2*Math.floor(6))*10,`${M} structures built`,"üèóÔ∏è","Construction"),await l()}for(;S<2;){for(let t=0;t<50;t++){const t=40+Math.floor(80*Math.random())*(Math.random()<.5?1:-1),e=40+Math.floor(80*Math.random())*(Math.random()<.5?1:-1);if(this.tryPlaceBuilding(t,e,["wcdonalds"],u)){S++,w.push({x:t-2,z:e-2,w:20,d:18});break}}if(S<2)break}console.log(`Generated ${M} buildings, ${S} WcDonalds`),n("Planting Trees...",72,"Growing forests","üå≤","Forest"),await l();let T=0;const B=(t,e,i=8)=>{for(const s of w)if(t>=s.x-i&&t<=s.x+s.w+i&&e>=s.z-i&&e<=s.z+s.d+i)return!0;return!1};for(let $=-150;$<=t;$+=3){for(let e=-150;e<=t;e+=3){const t=`${$},${e}`,s=u[t],o=g[t],a=i[o];if(s>7&&a.treeChance>0){if(this.noise2D(.3*$+300,.3*e+300)>.3&&Math.random()<a.treeChance){const t=5,i=$-2,a=e-2;!(i>=this.worldBounds.minX+2&&i+t<=this.worldBounds.maxX-2&&a>=this.worldBounds.minZ+2&&a+t<=this.worldBounds.maxZ-2)||B($,e)||this.checkStructureCollision(i,s+1,a,t,8,t)||("sakuraForest"===o||"forest"===o&&Math.random()<.15?this.generateCherryTree($,s+1,e):Math.random()<.2?this.generateTree($,s+1,e,!0):this.generateTree($,s+1,e),T++)}}}if($%30==0){const e=i[g[`${$},0`]||"plains"];n("Planting Trees...",72+($+t)/300*12,`${T} trees planted`,e.icon,e.name),await l()}}let P,C;n("Adding Special Locations...",85,"Placing ritual temple","‚õ©Ô∏è","Temple"),await l();do{P=Math.floor(120*Math.random())+20,C=Math.floor(120*Math.random())+20,Math.random()<.5&&(P=-P),Math.random()<.5&&(C=-C)}while(Math.abs(P)<30||Math.abs(C)<30);const I=u[`${P},${C}`]||8;this.generateRitualTemple(P,I+1,C),n("Hiding Treasures...",88,"Placing ritual chests","üì¶","Treasures"),await l();for(let $=0;$<8;$++){const e=Math.floor(Math.random()*t*2)-t,i=Math.floor(Math.random()*t*2)-t,s=u[`${e},${i}`]||8;if(s>6){this.setBlock(e,s+1,i,"ritualChest");const t=this.ritualItems[$%this.ritualItems.length];this.chestContents=this.chestContents||{};const o=[{type:t,count:1}];Math.random()<.01&&o.push({type:"berdger",count:1});const a=[{type:"seeds",count:2+Math.floor(4*Math.random())},{type:"apple",count:1+Math.floor(3*Math.random())},{type:"jadite",count:1+Math.floor(2*Math.random())},{type:"sakuraite",count:1},{type:"moonstone",count:1},{type:"glowstone",count:2+Math.floor(3*Math.random())}],n=1+Math.floor(3*Math.random());for(let e=0;e<n;e++){const t=a[Math.floor(Math.random()*a.length)];o.push({type:t.type,count:t.count})}this.chestContents[`${e},${s+1},${i}`]=o}}n("Scattering Items...",92,"Dropping seeds and apples","üçé","Items"),await l();for(let $=0;$<60;$++){const e=Math.floor(Math.random()*t*2)-t,i=Math.floor(Math.random()*t*2)-t,s=u[`${e},${i}`]||8;s>6&&this.droppedItems.push({x:e+.5,y:s+1.2,z:i+.5,vy:0,type:"seeds",count:1+Math.floor(3*Math.random()),bobPhase:Math.random()*Math.PI*2,pickupDelay:0,age:0})}if(this.appleTrees)for(const $ of this.appleTrees)if(Math.random()<.5){const t=1+Math.floor(3*Math.random());for(let e=0;e<t;e++)this.droppedItems.push({x:$.x+4*(Math.random()-.5),y:$.y-3,z:$.z+4*(Math.random()-.5),vy:0,type:"apple",count:1,bobPhase:Math.random()*Math.PI*2,pickupDelay:0,age:0})}n("Spawning Wildlife...",96,"Releasing birds and fish","üê¶","Wildlife"),await l(),this.initBirds(),this.initPestBirds(),n("Finalizing World...",99,"Almost ready!","‚ú®","Complete"),await l(),this.worldBiomes=g,this.worldHeights=u;const z={};for(const $ of Object.values(g))z[$]=(z[$]||0)+1;console.log("Biome distribution:",z),console.log(`World generated: ${Object.keys(this.world).length} blocks, ${T} trees, ${M} buildings`),n("World Ready!",100,"Click to play!","üå∏","SakuraCraft"),clearInterval(a),await l(),setTimeout(()=>{const t=document.getElementById("loadingScreen"),e=document.getElementById("clickToPlay");t&&t.classList.remove("active"),e&&e.classList.add("active")},500)},tryPlaceBuilding(t,e,i,s=null){if(this.worldBounds){const i=10,s=this.worldBounds;if(t<s.minX+i||t>s.maxX-i||e<s.minZ+i||e>s.maxZ-i)return!1}const o=s&&s[`${t},${e}`]||this.getHighestBlock(t,e);if(!o||o<7)return!1;const a=this.getBlock(t,o,e);if("water"===a||"sand"===a)return!1;const n=s?s[`${t+3},${e}`]||o:this.getHighestBlock(t+3,e)||o,l=s?s[`${t-3},${e}`]||o:this.getHighestBlock(t-3,e)||o,r=s?s[`${t},${e+3}`]||o:this.getHighestBlock(t,e+3)||o,h=s?s[`${t},${e-3}`]||o:this.getHighestBlock(t,e-3)||o;if(Math.max(Math.abs(n-o),Math.abs(l-o),Math.abs(r-o),Math.abs(h-o))>3)return!1;for(const u of this.buildings)if(Math.sqrt((t-u.x)**2+(e-u.z)**2)<18)return!1;if(this.checkStructureCollision(t-1,o,e-1,10,12,10))return!1;const c=i[Math.floor(Math.random()*i.length)],d=o+1;switch(this.buildings.push({x:t,z:e,type:c,y:d}),c){case"church":this.generateChurch(t,d,e);break;case"house1":this.generateHouse1(t,d,e);break;case"house2":this.generateHouse2(t,d,e);break;case"house3":this.generateHouse3(t,d,e);break;case"grocery":this.generateGrocery(t,d,e);break;case"wcdonalds":this.generateWcDonalds(t,d,e)}return!0},generateChurch(t,e,i){for(let n=0;n<7;n++)for(let s=0;s<12;s++)this.setBlock(t+n,e-1,i+s,"stone");for(let n=0;n<7;n++)for(let s=0;s<12;s++)for(let o=0;o<8;o++){if((0===n||6===n||0===s||11===s)&&Math.random()>.3){if(11===s&&n>=2&&n<=4&&o<3)continue;if((0===n||6===n)&&o>=2&&o<=4&&(3===s||8===s))continue;this.setBlock(t+n,e+o,i+s,"stone")}}const s=t+3,o=i+2;for(let n=8;n<13;n++)this.setBlock(s,e+n,o,"stone"),n<11&&(Math.random()>.3&&this.setBlock(s+1,e+n,o,"stone"),Math.random()>.3&&this.setBlock(s-1,e+n,o,"stone"));const a=e+8+5;this.setBlock(s,a,o,"stone"),this.setBlock(s,a+1,o,"stone"),this.setBlock(s,a+2,o,"stone"),this.setBlock(s-1,a+1,o,"stone"),this.setBlock(s+1,a+1,o,"stone")},generateHouse1(t,e,i){for(let s=0;s<5;s++)for(let o=0;o<6;o++)this.setBlock(t+s,e-1,i+o,"wood");for(let s=0;s<5;s++)for(let o=0;o<6;o++)for(let a=0;a<4;a++){if((0===s||4===s||0===o||5===o)&&Math.random()>.25){if(5===o&&2===s&&a<2)continue;if(0===s&&1===a&&2===o)continue;this.setBlock(t+s,e+a,i+o,"wood")}}for(let s=-1;s<=5;s++)for(let o=0;o<6;o++)Math.random()>.25&&this.setBlock(t+s,e+4,i+o,"leaves");this.setBlock(t+1,e,i+1,"bed"),this.setBlock(t+1,e,i+2,"bedPillow"),this.setBlock(t+3,e,i+2,"table"),this.setBlock(t+3,e,i+3,"chair"),this.setBlock(t+3,e+1,i+2,"lamp"),Math.random()<.7&&(this.setBlock(t+1,e,i+4,"barrel"),this.chestContents=this.chestContents||{},this.chestContents[`${t+1},${e},${i+4}`]=[{type:"apple",count:2+Math.floor(4*Math.random())}]),Math.random()<.5&&(this.setBlock(t+3,e,i+1,"crate"),this.chestContents=this.chestContents||{},this.chestContents[`${t+3},${e},${i+1}`]=[{type:"wood",count:4+Math.floor(8*Math.random())},{type:"seeds",count:1+Math.floor(3*Math.random())}])},generateHouse2(t,e,i){for(let s=0;s<6;s++)for(let o=0;o<7;o++)this.setBlock(t+s,e-1,i+o,"stone");for(let s=0;s<6;s++)for(let o=0;o<7;o++)for(let a=0;a<6;a++){if((0===s||5===s||0===o||6===o)&&Math.random()>.3){if(6===o&&s>=2&&s<=3&&a<2)continue;if(!(0!==s&&5!==s||1!==a&&4!==a||2!==o&&4!==o))continue;this.setBlock(t+s,e+a,i+o,"brick")}}for(let s=1;s<5;s++)for(let o=1;o<6;o++)Math.random()>.6&&this.setBlock(t+s,e+3,i+o,"wood")},generateHouse3(t,e,i){for(let s=0;s<5;s++)for(let o=0;o<8;o++){this.setBlock(t+s,e-1,i+o,"stone");for(let a=0;a<4;a++){if((0===s||4===s||0===o||7===o)&&Math.random()>.35){if(7===o&&2===s&&a<2)continue;this.setBlock(t+s,e+a,i+o,"brick")}}}for(let s=5;s<9;s++)for(let o=0;o<5;o++){this.setBlock(t+s,e-1,i+o,"stone");for(let a=0;a<4;a++){(8===s||0===o||4===o||5===s&&o>4)&&Math.random()>.35&&this.setBlock(t+s,e+a,i+o,"brick")}}},generateGrocery(t,e,i){for(let s=0;s<10;s++)for(let o=0;o<8;o++)this.setBlock(t+s,e-1,i+o,"stone");for(let s=0;s<10;s++)for(let o=0;o<8;o++)for(let a=0;a<4;a++){if((0===s||9===s||0===o||7===o)&&Math.random()>.25){if(7===o&&s>=3&&s<=6&&a<3)continue;if(7===o&&(1===s||8===s)&&a>=1&&a<=2)continue;this.setBlock(t+s,e+a,i+o,"stone")}}for(let s=0;s<2;s++)for(let o=2;o<6;o++)Math.random()>.4&&(this.setBlock(t+3+3*s,e,i+o,"wood"),Math.random()>.5&&this.setBlock(t+3+3*s,e+1,i+o,"wood"));for(let s=2;s<8;s++)Math.random()>.3&&this.setBlock(t+s,e+4,i+8-1,"stone")},generateWcDonalds(t,e,i){Math.random()<.5?this.generateWcDonaldsDriveThru(t,e,i):this.generateWcDonaldsDineIn(t,e,i)},generateWcDonaldsDriveThru(t,e,i){const s=12,o=10;for(let h=0;h<s;h++)for(let s=0;s<o;s++)for(let o=0;o<10;o++){const a=this.getBlock(t+h,e+o,i+s);a&&"water"!==a&&"lava"!==a&&this.setBlock(t+h,e+o,i+s,null)}for(let h=-3;h<15;h++)this.setBlock(t+h,e-1,i+o+1,"stone"),this.setBlock(t+h,e-1,i+o+2,"stone");for(let h=-3;h<13;h++)this.setBlock(t+s+1,e-1,i+h,"stone"),this.setBlock(t+s+2,e-1,i+h,"stone");for(let h=-3;h<15;h++)this.setBlock(t+h,e-1,i-2,"stone"),this.setBlock(t+h,e-1,i-1,"stone");for(let h=-3;h<13;h++)this.setBlock(t-2,e-1,i+h,"stone"),this.setBlock(t-1,e-1,i+h,"stone");for(let h=2;h<10;h+=2)this.setBlock(t+h,e-1,i+o+1,"whiteBrick"),this.setBlock(t+h,e-1,i+o+2,"whiteBrick");for(let h=0;h<s;h++)for(let s=0;s<o;s++)this.setBlock(t+h,e-1,i+s,(h+s)%2==0?"whiteBrick":"redBrick");for(let h=0;h<s;h++)for(let s=0;s<o;s++)for(let o=0;o<5;o++){if((0===h||11===h||0===s||9===s)&&Math.random()>.1){if(9===s&&h>=4&&h<=6&&o<3)continue;if(9===s&&(1===h||2===h||9===h||10===h)&&o>=1&&o<=2)continue;if(11===h&&s>=3&&s<=5&&o>=1&&o<=2)continue;this.setBlock(t+h,e+o,i+s,o<2?"redBrick":"whiteBrick")}}for(let h=0;h<s;h++)for(let s=0;s<o;s++)this.setBlock(t+h,e+5,i+s,"redBrick");this.setBlock(t+s+1,e,i+7,"wood"),this.setBlock(t+s+1,e+1,i+7,"wood"),this.setBlock(t+s+1,e+2,i+7,"obsidian"),this.setBlock(t+s+1,e+3,i+7,"obsidian"),this.setBlock(t+s+1,e,i+5,"stone"),this.setBlock(t+s+1,e+1,i+5,"cashRegister");const a=t+6,n=i+o,l=e+5;this.setBlock(a-3,l+0,n,"sand"),this.setBlock(a-3,l+1,n,"sand"),this.setBlock(a-3,l+2,n,"sand"),this.setBlock(a-3,l+3,n,"sand"),this.setBlock(a-2,l+3,n,"sand"),this.setBlock(a-2,l+4,n,"sand"),this.setBlock(a-1,l+4,n,"sand"),this.setBlock(a-1,l+3,n,"sand"),this.setBlock(a-1,l+2,n,"sand"),this.setBlock(a-1,l+1,n,"sand"),this.setBlock(a,l+0,n,"sand"),this.setBlock(a,l+1,n,"sand"),this.setBlock(a+1,l+1,n,"sand"),this.setBlock(a+1,l+2,n,"sand"),this.setBlock(a+1,l+3,n,"sand"),this.setBlock(a+1,l+4,n,"sand"),this.setBlock(a+2,l+4,n,"sand"),this.setBlock(a+2,l+3,n,"sand"),this.setBlock(a+3,l+3,n,"sand"),this.setBlock(a+3,l+2,n,"sand"),this.setBlock(a+3,l+1,n,"sand"),this.setBlock(a+3,l+0,n,"sand");for(let h=1;h<8;h++)this.setBlock(t+h,e,i+2,"counter"),h%2==0&&this.setBlock(t+h,e+1,i+2,"cashRegister");for(let h=1;h<4;h++)this.setBlock(t+h,e,i+1,"stove");for(let h=4;h<8;h++)this.setBlock(t+h,e,i+1,"counter");this.setBlock(t+8,e,i+1,"fridge"),this.setBlock(t+8,e+1,i+1,"fridge");for(let h=0;h<2;h++){const s=2+4*h,o=6+2*h;this.setBlock(t+s,e,i+o,"stool"),this.setBlock(t+s+1,e,i+o,"table"),this.setBlock(t+s+2,e,i+o,"stool")}this.setBlock(t+2,e+5-1,i+4,"glowstone"),this.setBlock(t+6,e+5-1,i+8,"glowstone"),this.setBlock(t+3,e+1,i+6,"lamp"),this.setBlock(t+4,e,i+1,"buildingChest"),this.chestContents=this.chestContents||{};const r=`${t+4},${e},${i+1}`;Math.random()<.35?this.chestContents[r]=[{type:"berdger",count:1}]:this.chestContents[r]=[{type:"apple",count:5+Math.floor(5*Math.random())},{type:"seeds",count:2+Math.floor(4*Math.random())}],this.setBlock(t+7,e,i+1,"barrel"),this.chestContents[`${t+7},${e},${i+1}`]=[{type:"apple",count:8+Math.floor(8*Math.random())}]},generateWcDonaldsDineIn(t,e,i){const s=16,o=14;for(let h=1;h<15;h++)for(let s=1;s<13;s++)for(let o=0;o<9;o++){const a=this.getBlock(t+h,e+o,i+s);a&&"water"!==a&&"lava"!==a&&this.setBlock(t+h,e+o,i+s,null)}for(let h=-1;h<17;h++)for(let s=-1;s<15;s++)this.setBlock(t+h,e-1,i+s,"brick");for(let h=0;h<s;h++)for(let s=0;s<o;s++)this.setBlock(t+h,e-1,i+s,(h+s)%2==0?"whiteBrick":"redBrick");for(let h=0;h<s;h++)for(let s=0;s<o;s++)for(let o=0;o<6;o++){if((0===h||15===h||0===s||13===s)&&Math.random()>.12){if(13===s&&h>=5&&h<=10&&o<4)continue;if(13===s&&(h<=3||h>=12)&&o>=1&&o<=3)continue;if(0===h&&s>=3&&s<=10&&o>=1&&o<=3)continue;if(15===h&&s>=3&&s<=10&&o>=1&&o<=3)continue;this.setBlock(t+h,e+o,i+s,o<3?"brick":"whiteBrick")}}for(let h=-1;h<17;h++)for(let s=-1;s<15;s++)Math.random()>.036&&(7!==h&&8!==h||6!==s&&7!==s?this.setBlock(t+h,e+6,i+s,"brick"):this.setBlock(t+h,e+6,i+s,"glowstone"));const a=t+8,n=i+o,l=e+6;this.setBlock(a-4,l+0,n,"sand"),this.setBlock(a-4,l+1,n,"sand"),this.setBlock(a-4,l+2,n,"sand"),this.setBlock(a-4,l+3,n,"sand"),this.setBlock(a-4,l+4,n,"sand"),this.setBlock(a-3,l+4,n,"sand"),this.setBlock(a-3,l+5,n,"sand"),this.setBlock(a-2,l+5,n,"sand"),this.setBlock(a-2,l+4,n,"sand"),this.setBlock(a-2,l+3,n,"sand"),this.setBlock(a-2,l+2,n,"sand"),this.setBlock(a-2,l+1,n,"sand"),this.setBlock(a-1,l+0,n,"sand"),this.setBlock(a,l+0,n,"sand"),this.setBlock(a,l+1,n,"sand"),this.setBlock(a+1,l+0,n,"sand"),this.setBlock(a+2,l+1,n,"sand"),this.setBlock(a+2,l+2,n,"sand"),this.setBlock(a+2,l+3,n,"sand"),this.setBlock(a+2,l+4,n,"sand"),this.setBlock(a+2,l+5,n,"sand"),this.setBlock(a+3,l+5,n,"sand"),this.setBlock(a+3,l+4,n,"sand"),this.setBlock(a+4,l+4,n,"sand"),this.setBlock(a+4,l+3,n,"sand"),this.setBlock(a+4,l+2,n,"sand"),this.setBlock(a+4,l+1,n,"sand"),this.setBlock(a+4,l+0,n,"sand");for(let h=2;h<14;h++)this.setBlock(t+h,e,i+2,"counter"),h%3==0&&this.setBlock(t+h,e+1,i+2,"cashRegister");for(let h=2;h<7;h++)this.setBlock(t+h,e,i+1,"stove");for(let h=7;h<12;h++)this.setBlock(t+h,e,i+1,"counter");this.setBlock(t+12,e,i+1,"fridge"),this.setBlock(t+12,e+1,i+1,"fridge"),this.setBlock(t+13,e,i+1,"fridge"),this.setBlock(t+13,e+1,i+1,"fridge"),this.setBlock(t+2,e,i+1,"sink");for(let h=0;h<3;h++)for(let s=0;s<2;s++){const o=2+4*h,a=5+3*s;this.setBlock(t+o,e,i+a,"stool"),this.setBlock(t+o+1,e,i+a,"table"),this.setBlock(t+o+2,e,i+a,"stool"),0===s&&this.setBlock(t+o+1,e+1,i+a,"lamp")}this.setBlock(t+13,e,i+5,"plant"),this.setBlock(t+13,e+1,i+5,"cherryLeaves"),this.setBlock(t+14,e,i+6,"plant"),this.setBlock(t+13,e,i+7,"chair"),this.setBlock(t+14,e,i+7,"table"),this.setBlock(t+13,e+1,i+8,"cherryLeaves");for(let h=3;h<14;h+=4)for(let s=4;s<12;s+=4)this.setBlock(t+h,e+6-1,i+s,"glowstone");this.setBlock(t+7,e,i+1,"buildingChest"),this.chestContents=this.chestContents||{};const r=`${t+7},${e},${i+1}`;Math.random()<.4?this.chestContents[r]=[{type:"berdger",count:1},{type:"apple",count:3}]:this.chestContents[r]=[{type:"apple",count:10+Math.floor(10*Math.random())},{type:"seeds",count:5+Math.floor(5*Math.random())}],this.setBlock(t+1,e,i+1,"barrel"),this.chestContents[`${t+1},${e},${i+1}`]=[{type:"apple",count:12}],this.setBlock(t+14,e,i+1,"crate"),this.chestContents[`${t+14},${e},${i+1}`]=[{type:"wood",count:8},{type:"brick",count:4}]},getHighestBlock(t,e){for(let i=30;i>=0;i--)if(this.getBlock(t,i,e))return i;return null},checkBirdCollision(t,e,i,s=.5){const o=Math.floor(t),a=Math.floor(e),n=Math.floor(i);for(let l=-1;l<=1;l++)for(let r=-1;r<=1;r++)for(let h=-1;h<=1;h++){const c=this.getBlock(o+l,a+r,n+h);if(c&&"water"!==c){const c=o+l+.5,d=a+r+.5,u=n+h+.5;if(Math.sqrt((t-c)**2+(e-d)**2+(i-u)**2)<s+.7)return!0}}return!1},checkStructureCollision(t,e,i,s,o,a){const n=["grass","dirt","sand","stone","leaves","cherryLeaves","appleLeaves","wood","cherryWood","water","lava","mossyStone","deepslate","snow","ice","flowers"];let l=0;for(let r=0;r<s;r++)for(let s=0;s<o;s++)for(let o=0;o<a;o++){const a=this.getBlock(t+r,e+s,i+o);if(a&&!n.includes(a)&&(l++,l>5))return!0}return!1},findClearSpot(t,e,i,s,o=20){for(let a=0;a<o;a++)for(let o=0;o<2*Math.PI;o+=Math.PI/8){const n=Math.floor(t+Math.cos(o)*a),l=Math.floor(e+Math.sin(o)*a),r=this.getGroundHeight(n,l);if(!this.checkStructureCollision(n,r,l,i,10,s))return{x:n,y:r,z:l}}return{x:t,y:this.getGroundHeight(t,e),z:e}},toggleSneak(){this.camera.sneaking=!this.camera.sneaking,console.log("Sneaking:",this.camera.sneaking)},getEyeHeight(){return this.camera.sneaking?this.camera.sneakHeight||.2:this.camera.normalHeight||.6},initBirds(){this.birds=[];for(let t=0;t<12;t++)this.birds.push({x:80*(Math.random()-.5),y:15+10*Math.random(),z:80*(Math.random()-.5),baseY:15+10*Math.random(),angle:Math.random()*Math.PI*2,radius:5+15*Math.random(),speed:.01+.02*Math.random(),wobble:Math.random()*Math.PI*2,wobbleSpeed:.05+.05*Math.random(),wingPhase:Math.random()*Math.PI*2,size:.3+.2*Math.random()})},initPestBirds(){this.pestBirds=[];for(let t=0;t<3;t++)this.pestBirds.push({x:0,y:12,z:0,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:100*Math.random(),angle:t/3*Math.PI*2,circleRadius:2+Math.random(),baseCircleRadius:2+Math.random(),circleSpeed:.08+.04*Math.random(),swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.15+.05*Math.random(),chirpTimer:60*Math.random(),knockbackSpin:0,anger:0,timesShot:0,spawnThreshold:4+Math.floor(4*Math.random())})},updatePestBirds(){const t=this.camera.x,e=this.camera.y,i=this.camera.z;this.seedCalmTimer||(this.seedCalmTimer=0),this.seedCalmTimer>0&&this.seedCalmTimer--;const s=this.seedCalmTimer>0;this.birdPruneTimer||(this.birdPruneTimer=0),this.birdPruneTimer++,this.birdPruneTimer>=1800&&(this.birdPruneTimer=0,this.pestBirds.length>15&&(this.pestBirds.sort((t,e)=>e.anger-t.anger),this.pestBirds=this.pestBirds.slice(0,15)));for(const o of this.pestBirds){o.rageMode&&o.rageTimer&&(o.rageTimer--,o.rageTimer<=0&&(o.rageMode=!1,o.speed=.06)),this.wind&&"knockback"!==o.state&&(o.x+=.5*this.wind.x,o.z+=.5*this.wind.z),s&&"knockback"!==o.state&&(o.state="retreating",o.stateTimer=Math.max(o.stateTimer,60),o.anger=Math.max(0,o.anger-.01)),o.stateTimer--;const a=.1*o.anger;o.wingPhase+=("knockback"===o.state?.8:.5)+a,o.chirpTimer--;const n=1+.3*o.anger,l=1-.1*o.anger,r=.3+.15*o.anger;if("knockback"===o.state){const t=o.x,e=o.y,i=o.z;o.x+=o.vx,o.y+=o.vy,o.z+=o.vz;const s=this.getBlock(Math.floor(o.x),Math.floor(o.y),Math.floor(o.z));if(s&&"water"!==s&&"lava"!==s){if(s.includes("Leaves")||s.includes("leaves"))o.vx*=.4,o.vy*=.4,o.vz*=.4,o.stateTimer=Math.min(o.stateTimer,90),o.caughtInLeaves=!0;else{const s=Math.floor(o.x),a=Math.floor(o.y),n=Math.floor(o.z);this.getBlock(s,Math.floor(e),Math.floor(i))?this.getBlock(Math.floor(t),a,Math.floor(i))?this.getBlock(Math.floor(t),Math.floor(e),n)?(o.vx*=-.5,o.vy*=-.5,o.vz*=-.5,o.x=t,o.y=e,o.z=i):(o.vz*=-.7,o.z=i):(o.vy*=-.7,o.y=e):(o.vx*=-.7,o.x=t),this.particles.push({x:o.x,y:o.y,z:o.z,vx:.1*(Math.random()-.5),vy:.1*Math.random(),vz:.1*(Math.random()-.5),life:20,type:"spark",size:2})}}o.caughtInLeaves?(o.vx*=.9,o.vy*=.9,o.vz*=.9,o.vy+=.01,Math.abs(o.vx)<.01&&Math.abs(o.vz)<.01&&(o.caughtInLeaves=!1)):(o.vx*=.95,o.vy*=.95,o.vy-=.01,o.vz*=.95),o.knockbackSpin+=.3;if(Math.sqrt(o.vx*o.vx+o.vy*o.vy+o.vz*o.vz)<.05+.02*o.anger||o.stateTimer<=0){if(o.anger=Math.min(5,o.anger+1),o.timesShot++,o.timesShot===o.spawnThreshold&&this.pestBirds.length<15){const t=2+Math.floor(2*Math.random());for(let e=0;e<t;e++){const t=Math.random()*Math.PI*2,e=3+2*Math.random();this.pestBirds.push({x:this.camera.x+Math.cos(t)*e,y:this.camera.y+1+Math.random(),z:this.camera.z+Math.sin(t)*e,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:20+30*Math.random(),angle:t,circleRadius:e,baseCircleRadius:e,circleSpeed:.06+.04*Math.random(),swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.2+.05*Math.random(),chirpTimer:60*Math.random(),knockbackSpin:0,anger:2+Math.floor(2*Math.random()),timesShot:0,spawnThreshold:4+Math.floor(4*Math.random())})}}o.state="retreating",o.stateTimer=Math.max(30,120-20*o.anger),o.circleRadius=(o.baseCircleRadius+4)*l,o.vx=o.vy=o.vz=0,o.knockbackSpin=0,o.caughtInLeaves=!1}continue}switch(o.state){case"circling":o.angle+=o.circleSpeed*n,o.targetOffsetX=Math.cos(o.angle)*o.circleRadius*l,o.targetOffsetZ=Math.sin(o.angle)*o.circleRadius*l,o.targetOffsetY=.5+.3*Math.sin(2*o.angle),o.circleRadius+=.01*(o.baseCircleRadius-o.circleRadius),o.stateTimer<=0&&(Math.random()<r?(o.state="swooping",o.swoopProgress=0,o.stateTimer=60):Math.random()<.2?(o.state="hovering",o.stateTimer=Math.max(20,40-5*o.anger)+40*Math.random()):o.stateTimer=Math.max(15,30-5*o.anger)+60*Math.random());break;case"swooping":o.swoopProgress+=.05*n;const t=o.swoopProgress;if(t<.5)o.targetOffsetX=Math.cos(o.angle)*o.circleRadius*(1-2*t),o.targetOffsetZ=Math.sin(o.angle)*o.circleRadius*(1-2*t),o.targetOffsetY=.5-t;else{const e=2*(t-.5);o.targetOffsetX=Math.cos(o.angle)*o.circleRadius*e,o.targetOffsetZ=Math.sin(o.angle)*o.circleRadius*e,o.targetOffsetY=-.5+e}o.swoopProgress>=1&&(o.state="retreating",o.stateTimer=30);break;case"retreating":o.angle+=.5*o.circleSpeed;const e=o.circleRadius+2;o.targetOffsetX=Math.cos(o.angle)*e,o.targetOffsetZ=Math.sin(o.angle)*e,o.targetOffsetY=1+.2*Math.sin(3*o.angle),o.circleRadius+=.02*(o.baseCircleRadius-o.circleRadius),o.stateTimer<=0&&(o.state="circling",o.stateTimer=60+60*Math.random());break;case"hovering":const i=.3*Math.sin(.01*Date.now());o.targetOffsetX=-1.5*Math.sin(this.camera.rotY+i),o.targetOffsetZ=-1.5*Math.cos(this.camera.rotY+i),o.targetOffsetY=.2+.1*Math.sin(.02*Date.now()),o.stateTimer<=0&&(o.state="circling",o.stateTimer=80+40*Math.random())}const h=t+o.targetOffsetX,c=e+o.targetOffsetY,d=i+o.targetOffsetZ,u="swooping"===o.state?.15:.08;let g=(h-o.x)*u,f=(c-o.y)*u,m=(d-o.z)*u;const p=.08,y=o.rageMode?.12:p,b=Math.sqrt(g*g+f*f+m*m);if(b>y){const t=y/b;g*=t,f*=t,m*=t}o.x+=g,o.y+=f,o.z+=m}},updateBirds(){for(const t of this.birds)if(t.swarmMode&&t.swarmTimer&&(t.swarmTimer--,t.swarmTimer<=0&&(t.swarmMode=!1)),t.swarmMode){const e=this.camera.x-t.x,i=this.camera.y-t.y,s=this.camera.z-t.z,o=Math.sqrt(e*e+i*i+s*s);if(o>3){const a=t.x+e/o*.15,n=t.y+i/o*.1,l=t.z+s/o*.15;this.checkBirdCollision(a,t.y,t.z,.3)?t.x+=s/o*.1:t.x=a,this.checkBirdCollision(t.x,n,t.z,.3)||(t.y=n),this.checkBirdCollision(t.x,t.y,l,.3)?t.z+=e/o*.1:t.z=l}else t.angle+=.1,t.x=this.camera.x+3*Math.cos(t.angle),t.z=this.camera.z+3*Math.sin(t.angle),t.y=this.camera.y+.5*Math.sin(t.wobble);t.wobble+=2*t.wobbleSpeed,t.wingPhase+=.5}else{t.angle+=t.speed,t.wobble+=t.wobbleSpeed;const e=20*Math.sin(.1*t.angle),i=20*Math.cos(.1*t.angle);let s=e+Math.cos(t.angle)*t.radius,o=i+Math.sin(t.angle)*t.radius;this.wind&&(s+=15*this.wind.x,o+=15*this.wind.z),t.x=s,t.z=o,t.y=t.baseY+2*Math.sin(t.wobble),t.wingPhase+=.3}this.updatePestBirds(),this.updateBlueBirds(),this.updateFish(),this.updateCats(),this.updateRepairNPC(),this.updateCreepers(),this.updateFriendlyBirdDrops(),this.updateBirdEventTimer()},updateBlueBirds(){this.blueBirds||(this.blueBirds=[]);for(let t=this.blueBirds.length-1;t>=0;t--){const e=this.blueBirds[t];e.wingPhase+=.6,e.attackCooldown>0&&e.attackCooldown--;const i=this.camera.x-e.x,s=this.camera.y-e.y,o=this.camera.z-e.z,a=Math.sqrt(i*i+s*s+o*o);a>1.5&&(e.vx+=i/a*.02,e.vy+=s/a*.015,e.vz+=o/a*.02);const n=e.x+e.vx,l=e.y+e.vy,r=e.z+e.vz;this.checkBirdCollision(n,e.y,e.z,.3)?e.vx*=-.5:e.x=n,this.checkBirdCollision(e.x,l,e.z,.3)?e.vy*=-.5:e.y=l,this.checkBirdCollision(e.x,e.y,r,.3)?e.vz*=-.5:e.z=r,e.vx*=.9,e.vy*=.9,e.vz*=.9,a<2&&e.attackCooldown<=0&&(this.velocity.x+=.1*(this.camera.x-e.x),this.velocity.y+=.15,this.velocity.z+=.1*(this.camera.z-e.z),e.attackCooldown=60),a>60&&this.blueBirds.splice(t,1)}},updateFish(){this.fish||(this.fish=[]);for(let t=this.fish.length-1;t>=0;t--){const e=this.fish[t];e.swimPhase+=.15;"water"!==this.getBlock(Math.floor(e.x),Math.floor(e.y),Math.floor(e.z))?e.vy-=.01:(e.vx+=.01*(Math.random()-.5),e.vz+=.01*(Math.random()-.5),e.vy+=.005*(Math.random()-.5)),e.x+=e.vx,e.y+=e.vy,e.z+=e.vz,e.vx*=.95,e.vy*=.95,e.vz*=.95;const i=Math.sqrt(e.vx*e.vx+e.vz*e.vz);i>.08&&(e.vx=e.vx/i*.08,e.vz=e.vz/i*.08)}},updateCats(){this.cats||(this.cats=[]);for(const t of this.cats){t.walkPhase+=.1,t.meowTimer--;const e=this.camera.x-t.x,i=this.camera.z-t.z,s=Math.sqrt(e*e+i*i);s>t.followDistance+2?(t.state="following",t.vx+=e/s*.01,t.vz+=i/s*.01):s<t.followDistance&&(t.state="idle"),t.x+=t.vx,t.z+=t.vz,t.vx*=.85,t.vz*=.85,t.vy-=.02,t.y+=t.vy;const o=Math.floor(t.y);this.getBlock(Math.floor(t.x),o,Math.floor(t.z))&&(t.y=o+1,t.vy=0),t.meowTimer<=0&&(t.meowTimer=200+400*Math.random())}},spawnRepairNPC(){if(this.repairNPC)return;if(!this.worldBounds)return;const t=this.worldBounds,e=t.minX+10,i=t.maxX-10,s=t.minZ+10,o=t.maxZ-10;this.debugLog("üîç Attempting to spawn Gunsmith Wizard...","info"),this.debugLog(`  Player at: (${this.camera.x.toFixed(1)}, ${this.camera.y.toFixed(1)}, ${this.camera.z.toFixed(1)})`,"info"),this.debugLog(`  Safe bounds: X[${e.toFixed(0)}, ${i.toFixed(0)}] Z[${s.toFixed(0)}, ${o.toFixed(0)}]`,"info");let a=0,n=0,l=0,r=!1;let h=[];for(let g=0;g<100;g++){const t=Math.random()*Math.PI*2,c=15+10*Math.random();let d=this.camera.x+Math.cos(t)*c,u=this.camera.z+Math.sin(t)*c;d=Math.max(e,Math.min(i,d)),u=Math.max(s,Math.min(o,u));const f=Math.floor(d),m=Math.floor(u);for(let e=25;e>=1;e--){const t=this.getBlock(f,e,m);if("grass"===t||"sand"===t){const i=!this.getBlock(f,e+1,m),s=!this.getBlock(f,e+2,m),o=!this.getBlock(f,e+3,m);if(i&&s&&o){a=d,n=e+1,l=u,r=!0,g<5&&h.push(`  Attempt ${g}: Found valid at (${f}, ${e+1}, ${m}) on ${t}`);break}g<5&&h.push(`  Attempt ${g}: (${f}, ${e}, ${m}) ${t} - blocked above: ${i?"":"Y+1"} ${s?"":"Y+2"} ${o?"":"Y+3"}`)}}if(r)break;if(g<5&&!r){const t=this.getBlock(f,10,m)||"air",e=this.getBlock(f,9,m)||"air";h.push(`  Attempt ${g}: (${f}, ?, ${m}) - no grass/sand found (Y=10: ${t}, Y=9: ${e})`)}}for(const g of h)this.debugLog(g,"info");if(!r)return void this.debugLog("‚ö†Ô∏è Failed to find valid spawn location for gunsmith after 100 attempts","warn");this.repairNPC={x:a,y:n,z:l,vx:0,vy:0,vz:0,onGround:!0,wanderTargetX:a,wanderTargetZ:l,nextWanderTime:Date.now()+3e3,showPrompt:!1,lastSpoke:0};const c=this.getBlock(Math.floor(a),Math.floor(n-1),Math.floor(l)),d=this.getBlock(Math.floor(a),Math.floor(n),Math.floor(l));this.debugLog("‚ú® Gunsmith Wizard spawned!","success"),this.debugLog(`  Position: (${a.toFixed(2)}, ${n}, ${l.toFixed(2)})`,"success"),this.debugLog(`  Standing on: ${c||"air"} at Y=${n-1}`,"success"),this.debugLog(`  Block at feet: ${d||"air (correct)"}`,d?"warn":"success");const u=this.getGroundHeightBelow(a,l,n+5);u!==n&&this.debugLog(`  ‚ö†Ô∏è getGroundHeightBelow disagrees! Returns ${u}, expected ${n}`,"warn")},updateRepairNPC(){if(!this.repairNPC)return void(Math.random()<.01&&this.spawnRepairNPC());const t=this.repairNPC;if(this.worldBounds){const e=this.worldBounds,i=e.minX+3,s=e.maxX-3,o=e.minZ+3,a=e.maxZ-3;t.x=Math.max(i,Math.min(s,t.x)),t.z=Math.max(o,Math.min(a,t.z)),t.wanderTargetX&&(t.wanderTargetX<i||t.wanderTargetX>s||t.wanderTargetZ<o||t.wanderTargetZ>a)&&(t.wanderTargetX=null)}t.vy-=.03,t.y+=t.vy;const e=this.getGroundHeightBelow(t.x,t.z,t.y,0);if(t.y<=e){if(void 0!==t.lastLoggedY&&Math.abs(e-t.lastLoggedY)>2){this.debugLog(`‚ö†Ô∏è Gunsmith Y changed significantly: ${t.lastLoggedY} ‚Üí ${e}`,"warn");const i=this.getBlock(Math.floor(t.x),e-1,Math.floor(t.z));this.debugLog(`  Now standing on: ${i||"nothing"} at Y=${e-1}`,"warn")}t.lastLoggedY=e,t.y=e,t.vy=0,t.onGround=!0}else t.onGround=!1;if(Date.now()>t.nextWanderTime||!t.wanderTargetX){let e=!1;for(let i=0;i<10;i++){const i=Math.random()*Math.PI*2,s=3+6*Math.random(),o=t.x+Math.cos(i)*s,a=t.z+Math.sin(i)*s;if(this.getGroundHeight(o,a)>0){t.wanderTargetX=o,t.wanderTargetZ=a,e=!0;break}}e||(t.wanderTargetX=t.x,t.wanderTargetZ=t.z),t.nextWanderTime=Date.now()+(3e3+4e3*Math.random())}if(null!==t.wanderTargetX){const e=t.wanderTargetX-t.x,i=t.wanderTargetZ-t.z,s=Math.sqrt(e*e+i*i);if(s>.5){const o=.04,a=e/s*o,n=i/s*o,l=t.x+a,r=t.z+n,h=this.getGroundHeight(l,r);h>0&&Math.abs(h-t.y)<3?(t.vx=a,t.vz=n):(t.vx=0,t.vz=0,t.wanderTargetX=null)}else t.vx=0,t.vz=0,t.wanderTargetX=null}t.x+=t.vx,t.z+=t.vz,t.y<0&&(this.debugLog("‚ö†Ô∏è Gunsmith fell into void! Respawning...","warn"),this.repairNPC=null);const i=Math.sqrt((t.x-this.camera.x)**2+(t.z-this.camera.z)**2);let s=!1;if(i<4){const e=-Math.sin(this.camera.rotY)*Math.cos(this.camera.rotX),i=Math.sin(this.camera.rotX),o=Math.cos(this.camera.rotY)*Math.cos(this.camera.rotX),a=t.y+1.5,n=t.x-this.camera.x,l=a-this.camera.y,r=t.z-this.camera.z,h=Math.sqrt(n*n+l*l+r*r);if(h>.1){s=e*(n/h)+i*(l/h)+o*(r/h)>.96}}t.showPrompt=s,i>60&&(this.repairNPC=null,this.debugLog("The repair NPC wandered away...","info"))},updateCreepers(){this.creepers||(this.creepers=[]);for(let t=this.creepers.length-1;t>=0;t--){const e=this.creepers[t];e.walkPhase+=.08;const i=this.camera.x-e.x,s=this.camera.z-e.z,o=Math.sqrt(i*i+s*s);if("stalking"===e.state)o>2?(e.vx+=i/o*.003,e.vz+=s/o*.003):(e.state="fusing",e.fuseTimer=0);else if("fusing"===e.state){if(e.fuseTimer++,e.flashing=Math.floor(e.fuseTimer/5)%2==0,e.fuseTimer>=e.fuseMax){this.creeperExplode(e),this.creepers.splice(t,1);continue}o>4&&(e.state="stalking",e.fuseTimer=0)}e.x+=e.vx,e.z+=e.vz,e.vx*=.9,e.vz*=.9,e.vy-=.02,e.y+=e.vy;const a=Math.floor(e.y);this.getBlock(Math.floor(e.x),a,Math.floor(e.z))&&(e.y=a+1,e.vy=0)}},creeperExplode(t){const e=this.camera.x-t.x,i=this.camera.z-t.z,s=Math.sqrt(e*e+i*i);if(s<6){const t=(6-s)/6*1.5;this.velocity.x+=e/s*t,this.velocity.y+=.8,this.velocity.z+=i/s*t}for(let o=0;o<30;o++)this.particles.push({x:t.x,y:t.y+.5,z:t.z,vx:.3*(Math.random()-.5),vy:.3*Math.random(),vz:.3*(Math.random()-.5),life:30+20*Math.random(),type:"explosion",size:3+3*Math.random()});for(let o=0;o<5;o++)this.spawnBlueBird();this.birdEvent&&this.showBirdAlert("üí• CREEPER EXPLODED! Blue birds incoming! üí•")},updateFriendlyBirdDrops(){if(this.birdDropTimer||(this.birdDropTimer=0),this.birdDropTimer++,this.birdDropTimer>=600){this.birdDropTimer=0;for(const t of this.birds)if(Math.random()<.3){const e=Math.random();let i="seeds",s=1+Math.floor(3*Math.random());e<.05?(i=["berdger","omamori","shimenawa"][Math.floor(3*Math.random())],s=1):e<.2&&(i="apple",s=1+Math.floor(2*Math.random())),this.dropItem(t.x+2*(Math.random()-.5),t.y-2,t.z+2*(Math.random()-.5),i,s);break}}},updateBirdEventTimer(){if(!this.birdEvent)return;const t=Date.now(),e=t-this.birdEvent.lastUpdate;this.birdEvent.lastUpdate=t,this.birdEvent.timer-=e,this.birdEvent.alertFade>0&&(this.birdEvent.alertFade-=e,this.birdEvent.alertFade<=0&&(this.birdEvent.alertMessage=null));const i=this.birdEvent.timer,s=this.birdEvent.events[this.birdEvent.currentEvent];i<=3e5&&i>24e4&&!this.birdEvent.alertShown.five&&(this.showBirdAlert(`‚ö†Ô∏è In 5 minutes, ${s.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.five=!0),i<=18e4&&i>12e4&&!this.birdEvent.alertShown.three&&(this.showBirdAlert(`‚ö†Ô∏è In 3 minutes, ${s.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.three=!0),i<=6e4&&i>5e4&&!this.birdEvent.alertShown.one&&(this.showBirdAlert(`‚ö†Ô∏è In 1 minute, ${s.description} ‚ö†Ô∏è`),this.birdEvent.alertShown.one=!0),i<=3e4&&i>2e4&&!this.birdEvent.alertShown.thirty&&(this.showBirdAlert(`‚ö†Ô∏è In 30 seconds, ${s.description.toUpperCase()} ‚ö†Ô∏è`),this.birdEvent.alertShown.thirty=!0),i<=1e4&&i>5e3&&!this.birdEvent.alertShown.ten&&(this.showBirdAlert(`üî• In 10 seconds, ${s.description.toUpperCase()} üî•`),this.birdEvent.alertShown.ten=!0),i<=0&&this.triggerBirdEvent()},showBirdAlert(t){this.birdEvent.alertMessage=t,this.birdEvent.alertFade=4e3},triggerBirdEvent(){const t=this.birdEvent.events[this.birdEvent.currentEvent];this.showBirdAlert(`üê¶ BIRD EVENT: ${t.name}! üê¶`),t.action(),this.birdEvent.timer=3e5,this.birdEvent.currentEvent=(this.birdEvent.currentEvent+1)%this.birdEvent.events.length,this.birdEvent.alertShown={five:!1,three:!1,one:!1,thirty:!1,ten:!1}},triggerBirdSwarm(){for(const t of this.birds)t.swarmMode=!0,t.swarmTimer=1800;for(let t=0;t<5;t++)this.spawnPestBird()},triggerBirdRage(){if(this.pestBirds)for(const t of this.pestBirds)t.rageMode=!0,t.rageTimer=2700,t.speed=1.5*(t.speed||.06);for(let t=0;t<3;t++){const t=this.spawnPestBird();t&&(t.rageMode=!0,t.rageTimer=2700)}},triggerBirdMultiply(){for(let t=0;t<10;t++){const t=Math.random()*Math.PI*2,e=10+20*Math.random(),i=this.spawnPestBird();i&&(i.x=this.camera.x+Math.cos(t)*e,i.z=this.camera.z+Math.sin(t)*e,i.y=this.camera.y+5+10*Math.random())}},triggerCreeperInvasion(){this.showBirdAlert("üí• CREEPERS ARE STALKING YOU! üí•");const t=2+Math.floor(3*Math.random());for(let e=0;e<t;e++)this.spawnCreeper()},spawnPestBird(){this.pestBirds||(this.pestBirds=[]);const t={x:this.camera.x+30*(Math.random()-.5),y:this.camera.y+10+10*Math.random(),z:this.camera.z+30*(Math.random()-.5),vx:0,vy:0,vz:0,state:"hunting",wingPhase:Math.random()*Math.PI*2,speed:.06,angryTimer:18e3};return this.pestBirds.push(t),t},spawnBlueBird(){this.blueBirds||(this.blueBirds=[]);const t={x:this.camera.x+20*(Math.random()-.5),y:this.camera.y+5+8*Math.random(),z:this.camera.z+20*(Math.random()-.5),vx:0,vy:0,vz:0,state:"aggressive",wingPhase:Math.random()*Math.PI*2,speed:.1,attackCooldown:0};return this.blueBirds.push(t),t},spawnFish(){this.fish||(this.fish=[]);let t=null;for(let i=0;i<50;i++){const e=Math.floor(this.camera.x+40*(Math.random()-.5)),i=Math.floor(this.camera.z+40*(Math.random()-.5));for(let s=20;s>=0;s--)if("water"===this.getBlock(e,s,i)){t={x:e+.5,y:s+.5,z:i+.5};break}if(t)break}t||(t={x:this.camera.x+10*(Math.random()-.5),y:7,z:this.camera.z+10*(Math.random()-.5)});const e={x:t.x,y:t.y,z:t.z,vx:.05*(Math.random()-.5),vy:0,vz:.05*(Math.random()-.5),swimPhase:Math.random()*Math.PI*2,color:Math.random()>.5?"#ff6347":"#ffd700",size:.3+.2*Math.random()};return this.fish.push(e),e},spawnCat(){this.cats||(this.cats=[]);const t={x:this.camera.x+10*(Math.random()-.5),y:this.camera.y-1,z:this.camera.z+10*(Math.random()-.5),vx:0,vy:0,vz:0,state:"idle",walkPhase:0,color:["#ffa500","#808080","#000000","#ffffff"][Math.floor(4*Math.random())],meowTimer:300*Math.random()+200,followDistance:3+2*Math.random()};return this.cats.push(t),t},spawnCreeper(){this.creepers||(this.creepers=[]);const t={x:this.camera.x+(Math.random()>.5?15:-15)+10*(Math.random()-.5),y:this.camera.y,z:this.camera.z+(Math.random()>.5?15:-15)+10*(Math.random()-.5),vx:0,vy:0,vz:0,state:"stalking",fuseTimer:0,fuseMax:90,walkPhase:0,health:3};return this.creepers.push(t),t},updateSurvivalHUD(){if(!this.survivalStats)return;const t=document.getElementById("scoreDisplay"),e=document.getElementById("waveDisplay"),i=document.getElementById("objectiveDisplay");t&&(t.textContent=`Score: ${this.survivalStats.score}`),e&&(e.textContent=`Wave: ${this.survivalStats.wave}`),i&&this.survivalStats.currentObjective&&(i.textContent=`Objective: ${this.survivalStats.currentObjective.text}`)},generateRitualTemple(t,e,i){const s=11,o=11;this.ritualTempleLocation={x:t,y:e,z:i};for(let l=0;l<s;l++)for(let s=0;s<o;s++)for(let o=0;o<10;o++)this.setBlock(t+l,e+o,i+s,null);for(let l=0;l<s;l++)for(let s=0;s<o;s++)this.setBlock(t+l,e,i+s,"ritualStone");for(let l=1;l<8;l++){for(let a=0;a<s;a++)this.setBlock(t+a,e+l,i,"ritualStone"),this.setBlock(t+a,e+l,i+o-1,"ritualStone");for(let a=0;a<o;a++)this.setBlock(t,e+l,i+a,"ritualStone"),this.setBlock(t+s-1,e+l,i+a,"ritualStone")}this.setBlock(t+5.5|0,e+1,i,null),this.setBlock(t+5.5|0,e+2,i,null),this.setBlock(t+5.5|0,e+3,i,null);const a=t+5.5|0,n=i+5.5|0;this.setBlock(a,e+1,n,"charmSocket"),this.setBlock(a-2,e+1,n,"petalSocket"),this.setBlock(a+2,e+1,n,"ropeSocket"),this.setBlock(a,e+1,n-2,"plaqueSocket"),this.setBlock(a,e+1,n+2,"incenseSocket");for(let l=1;l<=4;l++)this.setBlock(t+2,e+l,i+2,"glowstone"),this.setBlock(t+s-3,e+l,i+2,"glowstone"),this.setBlock(t+2,e+l,i+o-3,"glowstone"),this.setBlock(t+s-3,e+l,i+o-3,"glowstone")},generateTree(t,e,i){for(let s=0;s<4;s++)this.setBlock(t,e+s,i,"wood");for(let s=-2;s<=2;s++)for(let o=-2;o<=2;o++)for(let a=3;a<=5;a++)Math.abs(s)+Math.abs(o)+Math.abs(a-4)<4&&(0===s&&0===o&&a<4||this.setBlock(t+s,e+a,i+o,"appleLeaves"));this.appleTrees||(this.appleTrees=[]),this.appleTrees.push({x:t,y:e+4,z:i})},generateCherryTree(t,e,i){for(let s=0;s<6;s++)this.setBlock(t,e+s,i,"cherryWood");for(let s=-3;s<=3;s++)for(let o=-3;o<=3;o++)for(let a=4;a<=8;a++){Math.abs(s)+Math.abs(o)+Math.abs(a-6)<5&&Math.random()>.15&&(0===s&&0===o&&a<5||this.setBlock(t+s,e+a,i+o,"cherryLeaves"))}this.cherryTrees.push({x:t,y:e+6,z:i})},setBlock(t,e,i,s){const o=`${t},${e},${i}`;null===s?delete this.world[o]:this.world[o]=s},getBlock(t,e,i){return this.world[`${t},${e},${i}`]||null},setupControls(){document.addEventListener("keydown",t=>{if("`"===t.key||"~"===t.key)return t.preventDefault(),void this.toggleDebugConsole();if(!this.isActive)return;if(this.debugConsoleOpen)return;if((t.ctrlKey||t.metaKey)&&"w"===t.key.toLowerCase()&&(t.preventDefault(),t.stopPropagation()),"Escape"===t.key)return t.preventDefault(),this.dialogueOpen?void this.closeDialogue():this.journalOpen?void this.toggleJournal():this.containerOpen?void this.closeContainer():this.inventoryOpen?void this.toggleInventory():void(this.isPaused?this.resume():this.pause());if("j"===t.key.toLowerCase()&&!t.repeat)return void this.toggleJournal();if(this.isPaused)return;this.keys[t.key.toLowerCase()]=!0;const e=["1","2","3","4","5","6","7","8","9"].indexOf(t.key);if(-1!==e){this.selectedSlot=e;const t=this.inventory.hotbar[e];t&&("block"===t.type?(this.selectedBlock=t.id,this.selectedItem=null):"weapon"===t.type&&(this.selectedItem=t.id,this.selectedBlock=null)),this.updateHotbar()}if("e"===t.key.toLowerCase()){if(this.repairNPC){if(Math.sqrt((this.repairNPC.x-this.camera.x)**2+(this.repairNPC.z-this.camera.z)**2)<4){const t=-Math.sin(this.camera.rotY),e=Math.cos(this.camera.rotY),i=this.repairNPC.x-this.camera.x,s=this.repairNPC.z-this.camera.z,o=Math.sqrt(i*i+s*s);if(t*(i/o)+e*(s/o)>.5)return void this.openDialogue("gunsmith")}}this.toggleInventory()}"c"!==t.key.toLowerCase()||t.repeat||this.toggleSneak(),"Control"!==t.key||t.repeat||this.camera.sneaking||(this.toggleSneak(),this.camera.sneakingWithCtrl=!0),"q"===t.key.toLowerCase()&&this.dropHeldItem(),"r"===t.key.toLowerCase()&&this.checkRitual()&&console.log("Omamori Ritual Complete! Birds are blessed and calmed."),t.preventDefault()}),document.addEventListener("keyup",t=>{this.keys[t.key.toLowerCase()]=!1,"Control"===t.key&&this.camera.sneakingWithCtrl&&(this.camera.sneakingWithCtrl=!1,this.camera.sneaking&&this.toggleSneak())}),this.pointerLocked=!1,document.addEventListener("pointerlockchange",()=>{this.pointerLocked=document.pointerLockElement===this.canvas,this.pointerLocked?document.getElementById("clickToPlay").classList.remove("active"):!this.isActive||this.isPaused||this.inventoryOpen||this.containerOpen||this.debugConsoleOpen||this.dialogueOpen||this.journalOpen||this.justClosedInventory||this.pause()}),document.addEventListener("pointerlockerror",()=>{console.log("Pointer lock failed"),this.isActive&&!this.isPaused&&document.getElementById("clickToPlay").classList.add("active")}),this.canvas.addEventListener("mousedown",t=>{if(this.isActive&&!this.isPaused&&!this.debugConsoleOpen&&!this.inventoryOpen)if(this.pointerLocked){if(0===t.button){const t=this.raycast();if(t&&t.hit){const e=this.getBlock(t.hit.x,t.hit.y,t.hit.z);if("water"===e||"lava"===e)return;const i=t=>t&&("chest"===t||"ritualChest"===t||"buildingChest"===t||t.toLowerCase().includes("chest"));if((t=>t&&t.includes("Socket"))(e))return;if(this.setBlock(t.hit.x,t.hit.y,t.hit.z,null),this.stats.blocksBroken++,this.survivalStats&&(this.survivalStats.score+=1,this.updateSurvivalHUD()),e&&!i(e)){if(["bedrock"].includes(e))return void this.setBlock(t.hit.x,t.hit.y,t.hit.z,e);"appleLeaves"===e?(this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"appleLeaves",1),Math.random()<.15&&this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"apple",1)):"cherryLeaves"===e?(this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"cherryLeaves",1),Math.random()<.1&&this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"sakuraPetal",1)):"leaves"===e?(this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"leaves",1),Math.random()<.08&&this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"seeds",1)):this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,e,1)}else if(i(e)){const e=`${t.hit.x},${t.hit.y},${t.hit.z}`,i=this.chestContents&&this.chestContents[e];if(i&&Array.isArray(i)){for(const e of i)e&&e.type&&this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,e.type,e.count||1);delete this.chestContents[e]}this.dropItem(t.hit.x+.5,t.hit.y+.5,t.hit.z+.5,"chest",1)}}}else if(2===t.button){const t=this.raycast();if(t&&t.hit){const e=this.getBlock(t.hit.x,t.hit.y,t.hit.z);if(e&&(["chest","ritualChest","buildingChest","dungeonChest","barrel","crate","furnace","furnaceActive","alchemyTable","storageShrine"].includes(e)||e.toLowerCase().includes("chest")))return void this.openContainer(t.hit.x,t.hit.y,t.hit.z,e);if(e&&e.includes("Socket"))return void this.interactWithSocket(t.hit.x,t.hit.y,t.hit.z,e)}const e=this.inventory.hotbar[this.selectedSlot],i=e?e.id:null;if("ka69"===this.selectedItem)this.shootAK47();else if("berdger"===i)this.shootBerdger();else if("apple"===i)this.throwApple();else if("seeds"===i)this.useSeeds();else if("water_bucket"===this.selectedItem||"lava_bucket"===this.selectedItem){const t=this.raycast();if(t&&t.place){const e="water_bucket"===this.selectedItem?"water":"lava",i=t.place,s=Math.floor(this.camera.x),o=Math.floor(this.camera.z),a=Math.floor(this.camera.y-this.playerEyeHeight),n=Math.floor(this.camera.y-this.playerEyeHeight+this.playerHeight);let l=!1;for(let t=a;t<=n;t++)if(s===i.x&&t===i.y&&o===i.z){l=!0;break}if(!l){this.setBlock(i.x,i.y,i.z,e),this.setFluidLevel(i.x,i.y,i.z,8),this.fluidUpdates.push({x:i.x,y:i.y,z:i.z,type:e,level:8});const t=this.inventory.hotbar[this.selectedSlot];t&&t.count>1?t.count--:(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay()}}}else if(this.selectedBlock){const t=this.raycast();if(t&&t.place){const e=t.place,i=this.getBlock(e.x,e.y,e.z);if(i&&"water"!==i&&"lava"!==i)return;const s=Math.floor(this.camera.x),o=Math.floor(this.camera.z),a=Math.floor(this.camera.y-this.playerEyeHeight),n=Math.floor(this.camera.y-this.playerEyeHeight+this.playerHeight);let l=!1;for(let t=a;t<=n;t++)if(s===e.x&&t===e.y&&o===e.z){l=!0;break}if(!l){this.setBlock(e.x,e.y,e.z,this.selectedBlock),this.stats.blocksPlaced++;const t=this.inventory.hotbar[this.selectedSlot];t&&t.count>0&&(t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedBlock=null),this.updateHotbarDisplay())}}}}}else this.canvas.requestPointerLock()}),document.getElementById("minecraftGame").addEventListener("contextmenu",t=>{this.debugConsoleOpen||t.preventDefault()}),this.canvas.addEventListener("wheel",t=>{if(!this.isActive||this.isPaused||this.inventoryOpen||this.debugConsoleOpen)return;t.preventDefault(),t.deltaY>0?this.selectedSlot=(this.selectedSlot+1)%9:t.deltaY<0&&(this.selectedSlot=(this.selectedSlot+8)%9);const e=this.inventory.hotbar[this.selectedSlot];if(e){"block"===e.type?(this.selectedBlock=e.id,this.selectedItem=null):("weapon"===e.type||"bucket"===e.type)&&(this.selectedItem=e.id,this.selectedBlock=null);const t={grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",leaves:"Leaves",water:"Water",sand:"Sand",brick:"Brick",ka69:"KA-69",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",seed:"Seed",berdger:"Berdger",cherry_wood:"Cherry Wood",cherry_leaves:"Cherry Leaves",glowstone:"Burgerstone",ritual_item:"Omamori Charm",lava:"Lava",ice:"Ice"},i=e.id||e.type,s=t[i]||i;this.hotbarTooltip.text=s,this.hotbarTooltip.visible=!0,this.hotbarTooltip.timestamp=Date.now(),setTimeout(()=>{Date.now()-this.hotbarTooltip.timestamp>=1500&&(this.hotbarTooltip.visible=!1)},1500)}else this.selectedBlock=null,this.selectedItem=null;this.updateHotbar()},{passive:!1});document.getElementById("minecraftGame").addEventListener("wheel",t=>{!this.isActive||this.debugConsoleOpen||this.inventoryOpen||(t.preventDefault(),t.stopPropagation())},{passive:!1}),document.addEventListener("mousemove",t=>{this.isActive&&!this.isPaused&&this.pointerLocked&&!this.debugConsoleOpen&&(this.camera.rotY-=.003*t.movementX,this.camera.rotX=Math.max(-1.5,Math.min(1.5,this.camera.rotX+.003*t.movementY)))}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.isActive&&!this.isPaused&&this.pause()}),window.addEventListener("resize",()=>{});const t=()=>{const t=document.fullscreenElement||document.webkitFullscreenElement,e=this.canvas;t?(e.style.width="100vw",e.style.height="100vh",e.style.objectFit="contain"):(e.style.width="",e.style.height="",e.style.objectFit=""),this.updateFullscreenButton()};document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.querySelectorAll(".hotbar-slot").forEach((t,e)=>{t.addEventListener("click",t=>{t.stopPropagation(),this.selectedSlot=e;const i=this.inventory.hotbar[e];i&&("block"===i.type?(this.selectedBlock=i.id,this.selectedItem=null):"weapon"===i.type&&(this.selectedItem=i.id,this.selectedBlock=null)),this.updateHotbar()})})},setupMenus(){document.getElementById("btnResume").addEventListener("click",()=>this.resume()),document.getElementById("btnFullscreen").addEventListener("click",t=>{t.preventDefault();const e=document.getElementById("minecraftGame");document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen().catch(t=>console.log("Fullscreen error:",t)):e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),this.resume()}),document.getElementById("btnAccount").addEventListener("click",t=>{t.preventDefault()}),document.getElementById("btnStats").addEventListener("click",()=>{this.showSubmenu("menuStats"),this.updateStatsDisplay()}),document.getElementById("btnOptions").addEventListener("click",()=>{this.showSubmenu("menuOptions")}),document.getElementById("btnQuit").addEventListener("click",()=>this.stop()),document.getElementById("statsBack").addEventListener("click",()=>this.showSubmenu("menuMain")),document.getElementById("optionsBack").addEventListener("click",()=>this.showSubmenu("menuMain")),document.getElementById("optBrightness").addEventListener("input",t=>{this.settings.brightness=parseInt(t.target.value),this.applyFilters()}),document.getElementById("optFilter").addEventListener("change",t=>{this.settings.filter=t.target.value,this.applyFilters()}),document.getElementById("optRenderDist").addEventListener("change",t=>{this.settings.renderDistance=parseInt(t.target.value)}),document.getElementById("optTreeStyle").addEventListener("change",t=>{this.settings.treeStyle=t.target.value}),document.getElementById("optTextureMode").addEventListener("change",t=>{this.settings.textureMode=t.target.value}),["optShadows","optLighting","optAA","optShowFps"].forEach(t=>{document.getElementById(t).addEventListener("click",e=>{const i=e.target,s="true"===i.dataset.on;i.dataset.on=(!s).toString(),i.classList.toggle("on",!s),"optShadows"===t&&(this.settings.shadows=!s),"optLighting"===t&&(this.settings.lighting=!s),"optAA"===t&&(this.settings.antialiasing=!s,this.canvas.style.imageRendering=s?"auto":"pixelated"),"optShowFps"===t&&(this.settings.showFps=!s)})}),document.getElementById("optTargetFps").addEventListener("input",t=>{const e=parseInt(t.target.value);this.settings.targetFps=e,document.getElementById("targetFpsValue").textContent=String(e)})},showSubmenu(t){document.querySelectorAll(".pause-submenu").forEach(t=>t.classList.remove("active")),document.getElementById(t).classList.add("active")},updateStatsDisplay(){document.getElementById("statPlaced").textContent=this.stats.blocksPlaced,document.getElementById("statBroken").textContent=this.stats.blocksBroken,document.getElementById("statDistance").textContent=String(Math.floor(this.stats.distance))+"m",document.getElementById("statJumps").textContent=this.stats.jumps;const t=Math.floor((Date.now()-this.stats.startTime)/1e3),e=Math.floor(t/60),i=t%60;document.getElementById("statTime").textContent=`${e}:${i.toString().padStart(2,"0")}`},applyFilters(){let t=`brightness(${this.settings.brightness}%)`;switch(this.settings.filter){case"sepia":t+=" sepia(80%)";break;case"grayscale":t+=" grayscale(100%)";break;case"trippy":t+=" hue-rotate("+Date.now()%3600/10+"deg) saturate(200%)"}this.canvas.style.filter=t},updateHotbar(){document.querySelectorAll(".hotbar-slot").forEach((t,e)=>{const i=e===this.selectedSlot;t.classList.toggle("selected",i)})},updateHotbarDisplay(){document.querySelectorAll(".hotbar-slot").forEach((t,e)=>{const i=this.inventory.hotbar[e],s=e===this.selectedSlot;t.classList.toggle("selected",s),i&&i.count?t.setAttribute("data-count",i.count):t.setAttribute("data-count","");let o=t.querySelector("canvas");if(o||(o=document.createElement("canvas"),o.width=32,o.height=32,o.style.width="100%",o.style.height="100%",o.style.position="absolute",o.style.top="2px",o.style.left="2px",t.appendChild(o)),i){this.drawMiniBlock(o,i.id);let e=t.querySelector(".durability-bar");if(void 0!==i.durability&&i.maxDurability){e||(e=document.createElement("div"),e.className="durability-bar",e.innerHTML='<div class="durability-fill"></div>',t.appendChild(e));const s=e.querySelector(".durability-fill"),o=i.durability/i.maxDurability*100;s.style.width=o+"%",s.style.backgroundColor=o>50?"#4a4":o>25?"#aa4":"#a44",e.style.display="block"}else e&&(e.style.display="none")}else{o.getContext("2d").clearRect(0,0,o.width,o.height);const e=t.querySelector(".durability-bar");e&&(e.style.display="none")}})},shootAK47(){if(this.shootCooldown>0)return;const t=this.inventory.hotbar[this.selectedSlot];if(t&&"ka69"===t.id){if(void 0!==t.durability&&t.durability<=0)return void this.debugLog("KA-69 is broken! Find the Repair NPC to fix it (15 seeds)","warn");void 0!==t.durability&&(t.durability--,t.durability<=0&&(t.durability=0,this.debugLog("Your KA-69 broke! Find the Repair NPC (trade 15 seeds)","error")),this.updateHotbarDisplay())}this.shootCooldown=8,this.muzzleFlash=5;const e=this.camera.rotX,i=this.camera.rotY,s=-Math.sin(i)*Math.cos(e),o=-Math.sin(e),a=Math.cos(i)*Math.cos(e),n={x:this.camera.x+.5*s,y:this.camera.y+.5*o,z:this.camera.z+.5*a,vx:2.5*s,vy:2.5*o,vz:2.5*a,life:60,type:"bullet",trail:[]};this.particles.push(n);let l=null,r=1/0;for(const h of this.pestBirds){const t=h.x-this.camera.x,e=h.y-this.camera.y,i=h.z-this.camera.z,n=Math.sqrt(t*t+e*e+i*i);if(n<15&&n<r){s*(t/n)+o*(e/n)+a*(i/n)>.9&&(l=h,r=n)}}if(l){l.vx=.8*s+.2*(Math.random()-.5),l.vy=.8*o+.3+.2*Math.random(),l.vz=.8*a+.2*(Math.random()-.5),l.state="knockback",l.stateTimer=90;for(let o=0;o<8;o++){const t=.15+.2*Math.random(),e=.5*-s+1.5*(Math.random()-.5),i=.8*Math.random()+.2,o=.5*-a+1.5*(Math.random()-.5),n=Math.sqrt(e*e+i*i+o*o);this.particles.push({x:l.x,y:l.y,z:l.z,vx:e/n*t,vy:i/n*t,vz:o/n*t,life:25+20*Math.random(),type:"ricochet",size:2+3*Math.random()})}for(let s=0;s<5;s++)this.particles.push({x:l.x+.3*(Math.random()-.5),y:l.y+.3*(Math.random()-.5),z:l.z+.3*(Math.random()-.5),vx:.1*(Math.random()-.5),vy:.05+.05*Math.random(),vz:.1*(Math.random()-.5),life:40+30*Math.random(),type:"feather",rotation:Math.random()*Math.PI*2,rotSpeed:.3*(Math.random()-.5)});const t=.08+.05*Math.random();this.velocity.y+=.05+.03*Math.random();const e=l.x-this.camera.x,i=l.z-this.camera.z,n=Math.sqrt(e*e+i*i);n>.1&&(this.camera.x-=e/n*t*.3+(Math.random()-.5)*t,this.camera.z-=i/n*t*.3+(Math.random()-.5)*t);const r=Math.random();let h=0;r<.01?h=20:r<.1&&(h=5);for(let s=0;s<h;s++){const t=Math.random()*Math.PI*2,e=2+3*Math.random();this.pestBirds.push({x:l.x+Math.cos(t)*e,y:l.y+2*(Math.random()-.5),z:l.z+Math.sin(t)*e,vx:0,vy:0,vz:0,targetOffsetX:0,targetOffsetY:0,targetOffsetZ:0,state:"circling",stateTimer:10+20*Math.random(),angle:t,circleRadius:e,baseCircleRadius:e,circleSpeed:.07+.05*Math.random(),swoopProgress:0,wingPhase:Math.random()*Math.PI*2,size:.15+.08*Math.random(),chirpTimer:30*Math.random(),knockbackSpin:0,anger:1+Math.floor(3*Math.random()),timesShot:0,spawnThreshold:4+Math.floor(4*Math.random())})}}for(const h of this.birds){const t=h.x-this.camera.x,e=h.y-this.camera.y,i=h.z-this.camera.z,n=Math.sqrt(t*t+e*e+i*i);if(n<25){if(s*(t/n)+o*(e/n)+a*(i/n)>.85){h.radius+=8,h.baseY+=5;for(let t=0;t<5;t++)this.particles.push({x:h.x,y:h.y,z:h.z,vx:.3*(Math.random()-.5),vy:.2*Math.random(),vz:.3*(Math.random()-.5),life:20+15*Math.random(),type:"ricochet",size:2+2*Math.random()})}}}},updateParticles(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];if(e.life--,e.life<=0)this.particles.splice(t,1);else if(e.x+=e.vx,e.y+=e.vy,e.z+=e.vz,"bullet"===e.type){e.trail.push({x:e.x,y:e.y,z:e.z}),e.trail.length>8&&e.trail.shift();const i=Math.floor(e.x),s=Math.floor(e.y),o=Math.floor(e.z);if(this.getBlock(i,s,o)){for(let t=0;t<6;t++)this.particles.push({x:e.x,y:e.y,z:e.z,vx:.2*(Math.random()-.5),vy:.15*Math.random(),vz:.2*(Math.random()-.5),life:15+10*Math.random(),type:"spark",size:2+2*Math.random()});this.particles.splice(t,1)}}else if("ricochet"===e.type||"spark"===e.type)e.vy-=.008,e.vx*=.97,e.vz*=.97;else if("feather"===e.type)e.vy-=.002,e.vx*=.98,e.vz*=.98,e.rotation+=e.rotSpeed;else if("burger"===e.type){e.vy-=.003;for(const t of this.pestBirds){const i=t.x-e.x,s=t.y-e.y,o=t.z-e.z,a=Math.sqrt(i*i+s*s+o*o);if(a<1.5){const s=2.5;t.vx=.5*e.vx+i/a*s,t.vy=Math.abs(e.vy)+.5,t.vz=.5*e.vz+o/a*s,t.state="knockback",t.stateTimer=120,t.anger=Math.min(5,t.anger+2),e.life=0;for(let t=0;t<8;t++)this.particles.push({x:e.x,y:e.y,z:e.z,vx:.3*(Math.random()-.5),vy:.2*Math.random(),vz:.3*(Math.random()-.5),life:20,type:"burgerSplat",size:3+3*Math.random()})}}}else if("burgerSplat"===e.type)e.vy-=.01,e.vx*=.95,e.vz*=.95;else if("apple"===e.type){e.vy+=e.gravity||-.008;for(const i of this.pestBirds){const t=i.x-e.x,s=i.y-e.y,o=i.z-e.z,a=Math.sqrt(t*t+s*s+o*o);if(a<1.5){const s=3;i.vx=.5*e.vx+t/a*s,i.vy=.8,i.vz=.5*e.vz+o/a*s,i.state="knockback",i.stateTimer=180,i.anger=Math.max(0,i.anger-.5),e.life=0,this.survivalStats&&(this.survivalStats.score+=50,this.updateSurvivalHUD());for(let t=0;t<6;t++)this.particles.push({x:e.x,y:e.y,z:e.z,vx:.3*(Math.random()-.5),vy:.2*Math.random(),vz:.3*(Math.random()-.5),life:15,type:"appleSplat",size:2+2*Math.random()})}}for(const i of this.birds)if(i.swarmMode){const t=i.x-e.x,s=i.y-e.y,o=i.z-e.z;Math.sqrt(t*t+s*s+o*o)<2&&(i.swarmMode=!1,i.swarmTimer=0,e.life=0,this.survivalStats&&(this.survivalStats.score+=25,this.updateSurvivalHUD()))}const t=this.getGroundHeightBelow(e.x,e.z,e.y+10);e.y<=t+.5&&(e.life=0)}else"appleSplat"===e.type?(e.vy-=.015,e.vx*=.9,e.vz*=.9):"petal"===e.type&&(e.vy-=8e-4,e.vx+=.15*this.wind.x,e.vz+=.15*this.wind.z,e.vx*=.985,e.vz*=.985,e.rotation+=e.rotSpeed+.08*this.wind.x,e.flutter+=e.flutterSpeed||.08,e.x+=.025*Math.sin(e.flutter),e.y+=.008*Math.cos(1.3*e.flutter),e.z+=.015*Math.cos(.7*e.flutter),e.y<this.getGroundHeightBelow(e.x,e.z,e.y+10)+1&&(e.life=0))}},updateWind(){if(this.wind.gustTimer++,this.wind.gustTimer>120+180*Math.random()){this.wind.gustTimer=0;const t=.01+.04*Math.random(),e=Math.random()*Math.PI*2;this.wind.targetX=Math.cos(e)*t,this.wind.targetZ=Math.sin(e)*t}this.wind.x+=.02*(this.wind.targetX-this.wind.x),this.wind.z+=.02*(this.wind.targetZ-this.wind.z),this.wind.x+=.002*(Math.random()-.5),this.wind.z+=.002*(Math.random()-.5)},updatePetals(){if(!this.cherryTrees||0===this.cherryTrees.length)return;const t=this.particles.filter(t=>"petal"===t.type).length,e=Math.min(5,150-t);for(let i=0;i<e;i++){if(Math.random()>.6)continue;const t=this.cherryTrees[Math.floor(Math.random()*this.cherryTrees.length)],e=Math.sqrt((t.x-this.camera.x)**2+(t.z-this.camera.z)**2),i=40;if(e<i){const s=1-e/i*.5;if(Math.random()<s){const e=10*(Math.random()-.5),i=10*(Math.random()-.5),s=Math.random()<.3?8*Math.random():0;this.particles.push({x:t.x+e,y:t.y+3*Math.random()+s,z:t.z+i,vx:1.5*this.wind.x+.03*(Math.random()-.5),vy:-.008-.015*Math.random(),vz:1.5*this.wind.z+.03*(Math.random()-.5),life:250+200*Math.random(),type:"petal",size:2.5+2.5*Math.random(),rotation:Math.random()*Math.PI*2,rotSpeed:.15*(Math.random()-.5),flutter:Math.random()*Math.PI*2,flutterSpeed:.05+.05*Math.random()})}}}if(t<120&&Math.random()<.3){const t=Math.random()*Math.PI*2,e=10+20*Math.random();this.particles.push({x:this.camera.x+Math.cos(t)*e,y:this.camera.y+5+10*Math.random(),z:this.camera.z+Math.sin(t)*e,vx:2*this.wind.x+.02*(Math.random()-.5),vy:-.005-.01*Math.random(),vz:2*this.wind.z+.02*(Math.random()-.5),life:150+100*Math.random(),type:"petal",size:2+2*Math.random(),rotation:Math.random()*Math.PI*2,rotSpeed:.12*(Math.random()-.5),flutter:Math.random()*Math.PI*2,flutterSpeed:.04+.04*Math.random()})}},dropItem(t,e,i,s,o){this.droppedItems||(this.droppedItems=[]),this.droppedItems.push({x:t+.3*(Math.random()-.5),y:e,z:i+.3*(Math.random()-.5),vy:.1+.05*Math.random(),type:s,count:o,bobPhase:Math.random()*Math.PI*2,pickupDelay:30,age:0})},updateDroppedItems(){if(this.droppedItems)for(let t=this.droppedItems.length-1;t>=0;t--){const e=this.droppedItems[t];e.pickupDelay>0&&e.pickupDelay--;const i=Math.floor(e.x),s=Math.floor(e.y),o=Math.floor(e.z),a=Math.floor(e.y-.5),n=this.getBlock(i,s,o),l=this.getBlock(i,a,o),r=this.getBlock(i,s+1,o),h=this.getBlock(i,s+2,o),c=this.getBlock(i,s+3,o),d="lava"===n,u="lava"===r||"lava"===h||"lava"===c,g="water"===n||d||("water"===r||"water"===h||"water"===c)||u,f="water"===l,m=l&&!this.fluidBlocks.includes(l);if(void 0===e.vy&&(e.vy=0),void 0===e.bobPhase&&(e.bobPhase=Math.random()*Math.PI*2),void 0===e.resting&&(e.resting=!1),e.bobPhase+=.06,g){e.resting=!1;const t=d||u?.03:.06,a=d||u?.82:.85;e.vy+=t,e.vy*=a,e.vy=Math.max(-.05,Math.min(.2,e.vy));let n=s+1;for(let e=s;e<s+10;e++){const t=this.getBlock(i,e,o);if("water"!==t&&"lava"!==t){n=e-.1;break}}e.y>n-.5&&e.vy>0&&(e.vy*=.6),e.y>=n-.3&&e.y<=n+.3&&Math.abs(e.vy)<.08?(e.y=n,e.vy=0):e.y+=e.vy}else if(f&&!m){e.resting=!1;const t=a+1.4;e.y<t?e.vy+=.02:e.vy-=.005,e.vy*=.88,Math.abs(e.y-t)<.1&&Math.abs(e.vy)<.02?(e.y=t,e.vy=0):e.y+=e.vy}else if(e.resting)e.vy=0,m||(e.resting=!1);else if(e.vy-=.025,e.vy*=.98,e.vy=Math.max(-.5,e.vy),e.y+=e.vy,m){const t=a+1+.3;e.y<=t&&(e.y=t,e.vy=0,e.resting=!0)}else e.y<1&&(e.y=1,e.vy=0,e.resting=!0);if(e.pickupDelay<=0){const i=e.x-this.camera.x,s=e.y-this.camera.y,o=e.z-this.camera.z;if(Math.sqrt(i*i+s*s+o*o)<2&&this.addToInventory(e.type,e.count)){this.droppedItems.splice(t,1);continue}}e.age=(e.age||0)+1,e.age>18e3&&this.droppedItems.splice(t,1)}},addToInventory(t,e){let i="block";"ka69"!==t&&"berdger"!==t||(i="weapon"),"water_bucket"!==t&&"lava_bucket"!==t||(i="bucket"),this.ritualItems&&this.ritualItems.includes(t)&&(i="item"),"seeds"!==t&&"apple"!==t||(i="item"),this.showPickupNotification(t,e);for(let s=0;s<9;s++){const i=this.inventory.hotbar[s];if(i&&(i.id===t||i.type===t)&&i.count<64){const t=Math.min(e,64-i.count);if(i.count+=t,(e-=t)<=0)return this.updateHotbarDisplay(),!0}}for(let s=0;s<27;s++){const i=this.inventory.main[s];if(i&&(i.id===t||i.type===t)&&i.count<64){const t=Math.min(e,64-i.count);if(i.count+=t,(e-=t)<=0)return this.updateHotbarDisplay(),!0}}for(let s=0;s<9;s++)if(!this.inventory.hotbar[s]){const o=this.itemTypes[t]||{};return this.inventory.hotbar[s]={type:i,id:t,count:e,durability:o.durability,maxDurability:o.maxDurability},this.updateHotbarDisplay(),!0}for(let s=0;s<27;s++)if(!this.inventory.main[s]){const o=this.itemTypes[t]||{};return this.inventory.main[s]={type:i,id:t,count:e,durability:o.durability,maxDurability:o.maxDurability},this.updateHotbarDisplay(),!0}return!1},showPickupNotification(t,e){if(e<0){const e=document.getElementById("pickupNotification");if(!e)return;const i={grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",appleLeaves:"Apple Leaves",leaves:"Leaves",sand:"Sand",brick:"Brick",ka69:"KA-69",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",seeds:"Seeds",berdger:"The Berdger",apple:"Apple",sakuraPetal:"Cherry Petal",shimenawa:"Sacred Rope",omamori:"Charm",ema:"Wish Plaque",incense:"Incense",whiteBrick:"White Brick",redBrick:"Red Brick",glowstone:"Burgerstone",ritualStone:"Ritual Stone",table:"Table",chair:"Chair",bed:"Bed",bedPillow:"Pillow",cashRegister:"Cash Register",stool:"Stool",counter:"Counter",lamp:"Lamp",bookshelf:"Bookshelf",plant:"Plant",sink:"Sink",stove:"Stove",fridge:"Fridge"},s=document.createElement("div");return s.className="pickup-item",s.style.borderColor="rgba(255, 50, 50, 0.8)",s.innerHTML=`\n                        <span class="pickup-icon">üíî</span>\n                        <span style="color:#ff6666">${i[t]||t} broke!</span>\n                    `,e.appendChild(s),void setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},2e3)}this.queuePickupNotification(t,e)},drawMiniBlock(t,e){const i=t.getContext("2d"),s=this.blockColors[e],o=t.width,a=t.height;i.clearRect(0,0,o,a);const n=o/2,l=a/2,r=.35*Math.min(o,a);if(!s){if(i.save(),i.translate(n,l),"apple"===e)i.fillStyle="#dc143c",i.beginPath(),i.arc(0,0,.7*r,0,2*Math.PI),i.fill(),i.fillStyle="rgba(255,255,255,0.3)",i.beginPath(),i.arc(.2*-r,.2*-r,.25*r,0,2*Math.PI),i.fill(),i.fillStyle="#654321",i.fillRect(-1,.8*-r,3,.3*r),i.fillStyle="#228b22",i.beginPath(),i.ellipse(3,.7*-r,4,2,.3,0,2*Math.PI),i.fill();else if("seeds"===e){i.fillStyle="#daa520";for(let t=0;t<5;t++){const e=t/5*Math.PI*2,s=Math.cos(e)*r*.4,o=Math.sin(e)*r*.3;i.beginPath(),i.ellipse(s,o,3,5,e,0,2*Math.PI),i.fill()}}else"ka69"===e?(i.fillStyle="#333",i.fillRect(.6*-r,.1*-r,1.2*r,.25*r),i.fillStyle="#8b4513",i.fillRect(.3*-r,.1*r,.4*r,.4*r),i.fillStyle="#222",i.fillRect(.1*r,.1*r,.15*r,.35*r)):"berdger"===e?(i.fillStyle="#daa520",i.beginPath(),i.ellipse(0,.3*-r,.5*r,.25*r,0,0,2*Math.PI),i.fill(),i.fillStyle="#8b4513",i.fillRect(.4*-r,.15*-r,.8*r,.2*r),i.fillStyle="#228b22",i.fillRect(.35*-r,.05*-r,.7*r,.1*r),i.fillStyle="#daa520",i.beginPath(),i.ellipse(0,.2*r,.55*r,.3*r,0,0,2*Math.PI),i.fill()):"water_bucket"===e||"lava_bucket"===e?(i.fillStyle="#888",i.beginPath(),i.moveTo(.4*-r,.3*-r),i.lineTo(.4*r,.3*-r),i.lineTo(.3*r,.5*r),i.lineTo(.3*-r,.5*r),i.closePath(),i.fill(),i.fillStyle="water_bucket"===e?"#4a90d9":"#ff6600",i.beginPath(),i.moveTo(.3*-r,.1*-r),i.lineTo(.3*r,.1*-r),i.lineTo(.25*r,.4*r),i.lineTo(.25*-r,.4*r),i.closePath(),i.fill()):"sakuraPetal"===e?(i.fillStyle="#ffb7c5",i.beginPath(),i.ellipse(0,0,.6*r,.3*r,.3,0,2*Math.PI),i.fill()):"shimenawa"===e?(i.strokeStyle="#daa520",i.lineWidth=4,i.beginPath(),i.moveTo(.5*-r,0),i.quadraticCurveTo(0,.4*-r,.5*r,0),i.stroke()):"omamori"===e?(i.fillStyle="#cc0000",i.fillRect(.3*-r,.5*-r,.6*r,r),i.fillStyle="#ffd700",i.fillRect(.25*-r,.35*-r,.5*r,.15*r)):"ema"===e?(i.fillStyle="#deb887",i.beginPath(),i.moveTo(0,.5*-r),i.lineTo(.4*r,.2*-r),i.lineTo(.4*r,.4*r),i.lineTo(.4*-r,.4*r),i.lineTo(.4*-r,.2*-r),i.closePath(),i.fill()):"incense"===e?(i.fillStyle="#8b4513",i.fillRect(-1,.6*-r,3,1.2*r),i.fillStyle="#ff6600",i.beginPath(),i.arc(.5,.6*-r,3,0,2*Math.PI),i.fill()):(i.fillStyle="#888",i.fillRect(.4*-r,.4*-r,.8*r,.8*r),i.fillStyle="#444",i.font="8px monospace",i.textAlign="center",i.fillText("?",0,3));return void i.restore()}const h=.25*Math.min(o,a);let c,d=s.top,u=s.side;"string"==typeof d&&d.includes("rgba")&&(d=d.replace(/[\d.]+\)$/,"1)"),u=u.replace(/[\d.]+\)$/,"1)")),i.fillStyle=d,i.beginPath(),i.moveTo(n,l-h),i.lineTo(n+h,l-h/2),i.lineTo(n,l),i.lineTo(n-h,l-h/2),i.closePath(),i.fill(),i.fillStyle=u,i.beginPath(),i.moveTo(n-h,l-h/2),i.lineTo(n,l),i.lineTo(n,l+h),i.lineTo(n-h,l+h/2),i.closePath(),i.fill();try{c=this.darkenColor(u.replace(/rgba?\([^)]+\)/,"#888888"),.7)}catch(g){c=this.darkenColor(u,.7)}i.fillStyle=c,i.beginPath(),i.moveTo(n,l),i.lineTo(n+h,l-h/2),i.lineTo(n+h,l+h/2),i.lineTo(n,l+h),i.closePath(),i.fill(),i.strokeStyle="rgba(0,0,0,0.3)",i.lineWidth=.5,i.beginPath(),i.moveTo(n,l-r),i.lineTo(n+r,l-r/2),i.lineTo(n+r,l+r/2),i.lineTo(n,l+r),i.lineTo(n-r,l+r/2),i.lineTo(n-r,l-r/2),i.closePath(),i.stroke()},drawDroppedItem3D(t,e,i,s,o,a){const n=this.blockColors[o],l=.5*(a||0);if(t.save(),t.translate(e,i),!n){if("apple"===o)t.fillStyle="#dc143c",t.beginPath(),t.arc(0,0,.8*s,0,2*Math.PI),t.fill(),t.fillStyle="rgba(255,255,255,0.3)",t.beginPath(),t.arc(.2*-s,.2*-s,.3*s,0,2*Math.PI),t.fill(),t.fillStyle="#654321",t.fillRect(-1,.9*-s,2,.3*s),t.fillStyle="#228b22",t.beginPath(),t.ellipse(2,.8*-s,3,2,.3,0,2*Math.PI),t.fill();else if("seeds"===o){t.fillStyle="#daa520";for(let e=0;e<5;e++){const i=e/5*Math.PI*2+l,o=Math.cos(i)*s*.4,a=Math.sin(i)*s*.3;t.beginPath(),t.ellipse(o,a,.2*s,.1*s,i,0,2*Math.PI),t.fill()}}else"ka69"===o?(t.fillStyle="#333",t.fillRect(.8*-s,.15*-s,1.6*s,.3*s),t.fillRect(.3*-s,.15*-s,.15*s,.5*s),t.fillRect(.3*s,.4*-s,.5*s,.25*s)):"berdger"===o?(t.fillStyle="#D2691E",t.beginPath(),t.ellipse(0,.2*-s,.7*s,.35*s,0,Math.PI,0),t.fill(),t.fillStyle="#654321",t.fillRect(.6*-s,.1*-s,1.2*s,.25*s),t.fillStyle="#228B22",t.fillRect(.55*-s,.1*s,1.1*s,.1*s),t.fillStyle="#DEB887",t.beginPath(),t.ellipse(0,.25*s,.65*s,.3*s,0,0,Math.PI),t.fill()):"water_bucket"===o||"lava_bucket"===o?(t.fillStyle="#888",t.beginPath(),t.moveTo(.5*-s,.5*-s),t.lineTo(.5*s,.5*-s),t.lineTo(.4*s,.5*s),t.lineTo(.4*-s,.5*s),t.closePath(),t.fill(),t.fillStyle="water_bucket"===o?"#4a90d9":"#ff6600",t.fillRect(.35*-s,.3*-s,.7*s,.6*s),t.strokeStyle="#666",t.lineWidth=2,t.beginPath(),t.arc(0,.6*-s,.4*s,.2*Math.PI,.8*Math.PI),t.stroke()):"sakuraPetal"===o?(t.fillStyle="#ffb7c5",t.beginPath(),t.ellipse(0,0,.6*s,.3*s,l,0,2*Math.PI),t.fill()):"shimenawa"===o?(t.strokeStyle="#daa520",t.lineWidth=.2*s,t.beginPath(),t.moveTo(.6*-s,0),t.bezierCurveTo(.3*-s,.4*-s,.3*s,.4*s,.6*s,0),t.stroke()):"omamori"===o?(t.fillStyle="#ff4444",t.fillRect(.3*-s,.5*-s,.6*s,.8*s),t.fillStyle="#gold",t.fillRect(.2*-s,.4*-s,.4*s,.15*s)):"ema"===o?(t.fillStyle="#deb887",t.beginPath(),t.moveTo(0,.6*-s),t.lineTo(.5*s,.2*-s),t.lineTo(.5*s,.5*s),t.lineTo(.5*-s,.5*s),t.lineTo(.5*-s,.2*-s),t.closePath(),t.fill()):"incense"===o?(t.fillStyle="#8b4513",t.fillRect(-1,.6*-s,2,1.2*s),t.fillStyle="#ff6600",t.beginPath(),t.arc(0,.6*-s,3,0,2*Math.PI),t.fill()):(t.fillStyle="#888",t.fillRect(.5*-s,.5*-s,s,s));return void t.restore()}const r=.8*s;t.fillStyle=n.top,t.beginPath(),t.moveTo(0,-r),t.lineTo(r,-r/2),t.lineTo(0,0),t.lineTo(-r,-r/2),t.closePath(),t.fill(),t.fillStyle=n.side,t.beginPath(),t.moveTo(-r,-r/2),t.lineTo(0,0),t.lineTo(0,r),t.lineTo(-r,r/2),t.closePath(),t.fill(),t.fillStyle=this.darkenColor(n.side,.7),t.beginPath(),t.moveTo(0,0),t.lineTo(r,-r/2),t.lineTo(r,r/2),t.lineTo(0,r),t.closePath(),t.fill(),t.strokeStyle="rgba(0,0,0,0.4)",t.lineWidth=1,t.beginPath(),t.moveTo(0,-r),t.lineTo(r,-r/2),t.lineTo(r,r/2),t.lineTo(0,r),t.lineTo(-r,r/2),t.lineTo(-r,-r/2),t.closePath(),t.stroke(),t.restore()},useSeeds(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&"seeds"===t.id&&t.count>0){t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay(),this.seedCalmTimer=600;for(let t=0;t<10;t++)this.particles.push({x:this.camera.x+2*(Math.random()-.5),y:this.camera.y-.5,z:this.camera.z+2*(Math.random()-.5),vx:.2*(Math.random()-.5),vy:.1+.1*Math.random(),vz:.2*(Math.random()-.5),life:60,type:"spark",size:2});return!0}return!1},shootBerdger(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&"berdger"===t.id){const t=this.camera.rotX,e=this.camera.rotY,i=Math.cos(t),s=Math.sin(t),o=-Math.sin(e)*i,a=-s,n=Math.cos(e)*i;return this.particles.push({x:this.camera.x+.5*o,y:this.camera.y+.5*a,z:this.camera.z+.5*n,vx:.8*o,vy:.8*a,vz:.8*n,life:120,type:"burger",size:8,trail:[]}),!0}return!1},throwApple(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&"apple"===t.id&&t.count>0){t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay();const e=this.camera.rotX,i=this.camera.rotY,s=Math.cos(e),o=Math.sin(e),a=-Math.sin(i)*s,n=-o,l=Math.cos(i)*s;return this.particles.push({x:this.camera.x+.5*a,y:this.camera.y+.5*n,z:this.camera.z+.5*l,vx:.6*a,vy:.6*n+.1,vz:.6*l,life:180,type:"apple",size:6,gravity:-.008}),!0}return!1},checkRitual(){if(this.ritualComplete)return;const t={};for(const e of this.ritualItems)t[e]=!1;for(let e=0;e<9;e++){const i=this.inventory.hotbar[e];i&&this.ritualItems.includes(i.id)&&(t[i.id]=!0)}if(this.ritualItems.every(e=>t[e])){this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=36e3;for(let t=0;t<9;t++){const e=this.inventory.hotbar[t];e&&this.ritualItems.includes(e.id)&&(this.inventory.hotbar[t]=null)}this.updateHotbarDisplay();for(const t of this.pestBirds)t.anger=0,t.state="circling";for(let t=0;t<50;t++)this.particles.push({x:this.camera.x+8*(Math.random()-.5),y:this.camera.y+5*Math.random(),z:this.camera.z+8*(Math.random()-.5),vx:.1*(Math.random()-.5),vy:.05+.1*Math.random(),vz:.1*(Math.random()-.5),life:120+60*Math.random(),type:"petal",size:4+3*Math.random(),rotation:Math.random()*Math.PI*2,rotSpeed:.2*(Math.random()-.5),flutter:Math.random()*Math.PI*2});return!0}return!1},interactWithSocket(t,e,i,s){const o={petalSocket:"sakuraPetal",ropeSocket:"shimenawa",charmSocket:"omamori",plaqueSocket:"ema",incenseSocket:"incense"},a={petalSocket:"petalSocketFilled",ropeSocket:"ropeSocketFilled",charmSocket:"charmSocketFilled",plaqueSocket:"plaqueSocketFilled",incenseSocket:"incenseSocketFilled"},n=o[s];if(!n)return;if(s.includes("Filled"))return;const l=this.inventory.hotbar[this.selectedSlot];if(l&&l.id===n&&l.count>0){l.count--,l.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null),this.updateHotbarDisplay(),this.setBlock(t,e,i,a[s]),this.socketsFilled||(this.socketsFilled={}),this.socketsFilled[s]=!0;for(let s=0;s<20;s++)this.particles.push({x:t+.5+.5*(Math.random()-.5),y:e+1+.5*Math.random(),z:i+.5+.5*(Math.random()-.5),vx:.1*(Math.random()-.5),vy:.1+.1*Math.random(),vz:.1*(Math.random()-.5),life:60+40*Math.random(),type:"spark",size:3+2*Math.random()});if(Object.keys(o).every(t=>this.socketsFilled&&this.socketsFilled[t])&&!this.ritualComplete){if(this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=36e3,this.triggerRitualReward(),this.pestBirds)for(const t of this.pestBirds)t.anger=0,t.state="fleeing",t.stateTimer=600;this.survivalStats&&(this.survivalStats.score+=5e3,this.survivalStats.currentObjective={text:"Blessing active - birds flee!",type:"complete"},this.updateSurvivalHUD());for(let s=0;s<100;s++)this.particles.push({x:t+.5+10*(Math.random()-.5),y:e+8*Math.random(),z:i+.5+10*(Math.random()-.5),vx:.15*(Math.random()-.5),vy:.1+.15*Math.random(),vz:.15*(Math.random()-.5),life:180+120*Math.random(),type:"petal",size:4+4*Math.random(),rotation:Math.random()*Math.PI*2,rotSpeed:.2*(Math.random()-.5),flutter:Math.random()*Math.PI*2})}}},openChest(t,e,i){this.openContainer(t,e,i,"chest")},openContainer(t,e,i,s){this.chestContents||(this.chestContents={});const o=`${t},${e},${i}`;this.chestContents[o]||(this.chestContents[o]=[]);const a={chest:{name:"üì¶ Chest",slots:27},dungeonChest:{name:"üèõÔ∏è Dungeon Chest",slots:27},ritualChest:{name:"‚õ©Ô∏è Ritual Chest",slots:9},buildingChest:{name:"üè† Storage Chest",slots:27},barrel:{name:"üõ¢Ô∏è Barrel",slots:27},crate:{name:"üì¶ Crate",slots:18},furnace:{name:"üî• Furnace",slots:3},alchemyTable:{name:"‚öóÔ∏è Alchemy Table",slots:5},storageShrine:{name:"‚ú® Storage Shrine",slots:54}},n=a[s]||a.chest;this.openContainerPos={x:t,y:e,z:i},this.openContainerType=s,this.containerSlots=n.slots,this.containerOpen=!0,document.pointerLockElement&&document.exitPointerLock(),this.renderContainerUI(n.name,o)},renderContainerUI(t,e){const i=document.getElementById("containerScreen"),s=document.getElementById("containerTitle"),o=document.getElementById("containerSlots"),a=document.getElementById("playerSlotsInContainer");if(!i||!o||!a)return;s.textContent=t;const n=this.chestContents[e]||[],l=t=>({grass:"Grass",dirt:"Dirt",stone:"Stone",wood:"Wood",leaves:"Leaves",water:"Water",sand:"Sand",brick:"Brick",ka69:"KA-69",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",lava:"Lava",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",seeds:"Seeds",berdger:"The Berdger",apple:"Apple",sakuraPetal:"Cherry Petal",shimenawa:"Sacred Rope",omamori:"Charm",ema:"Wish Plaque",incense:"Incense",sakuraite:"Sakuraite",moonstone:"Moonstone",jadite:"Jadite",crimsonite:"Crimsonite",voidstone:"Voidstone",spirite:"Spirite",glowstone:"Burgerstone",whiteBrick:"White Brick",redBrick:"Red Brick",table:"Table",chair:"Chair",bed:"Bed",counter:"Counter",stool:"Stool",cashRegister:"Cash Register",lamp:"Lamp",fridge:"Fridge",stove:"Stove",sink:"Sink",plant:"Plant",bookshelf:"Bookshelf",barrel:"Barrel",crate:"Crate"}[t]||t);let r="";for(let c=0;c<this.containerSlots;c++){const t=n[c],e=t&&t.type,i=e?this.getItemEmoji({id:t.type}):"",s=e&&t.count>1?t.count:"",o=e?l(t.type):"";r+=`\n                        <div class="container-slot ${e?"has-item":""}" \n                             data-slot="${c}" data-source="container"\n                             ${o?`data-tooltip="${o}"`:""}>\n                            ${e?`<span class="slot-icon">${i}</span>`:""}\n                            ${s?`<span class="slot-count">${s}</span>`:""}\n                        </div>\n                    `}o.innerHTML=r;let h="";for(let c=0;c<9;c++){const t=this.inventory.hotbar[c],e=t&&t.id,i=e?this.getItemEmoji(t):"",s=e&&t.count>1?t.count:"",o=e?l(t.id):"";h+=`\n                        <div class="container-slot ${e?"has-item":""}" \n                             data-slot="${c}" data-source="hotbar"\n                             ${o?`data-tooltip="${o}"`:""}>\n                            ${e?`<span class="slot-icon">${i}</span>`:""}\n                            ${s?`<span class="slot-count">${s}</span>`:""}\n                        </div>\n                    `}for(let c=0;c<27;c++){const t=this.inventory.main[c],e=t&&t.id,i=e?this.getItemEmoji(t):"",s=e&&t.count>1?t.count:"",o=e?l(t.id):"";h+=`\n                        <div class="container-slot ${e?"has-item":""}" \n                             data-slot="${c}" data-source="main"\n                             ${o?`data-tooltip="${o}"`:""}>\n                            ${e?`<span class="slot-icon">${i}</span>`:""}\n                            ${s?`<span class="slot-count">${s}</span>`:""}\n                        </div>\n                    `}a.innerHTML=h,this.setupContainerSlotHandlers(e),i.classList.add("active")},setupContainerSlotHandlers(t){document.querySelectorAll(".container-slot").forEach(e=>{e.addEventListener("click",e=>{const i=e,s=parseInt(e.currentTarget.dataset.slot),o=e.currentTarget.dataset.source;this.handleContainerSlotClick(s,o,t,!1,i.clientX,i.clientY)}),e.addEventListener("contextmenu",e=>{e.preventDefault();const i=e,s=parseInt(e.currentTarget.dataset.slot),o=e.currentTarget.dataset.source;this.handleContainerSlotClick(s,o,t,!0,i.clientX,i.clientY)})});const e=document.getElementById("containerClose");e&&(e.onclick=()=>this.closeContainer())},handleContainerSlotClick(t,e,i,s=!1,o=0,a=0){this.debugSettings.dragDebug&&(console.log(`[DRAG] handleContainerSlotClick: slot=${t}, source=${e}, halfStack=${s}, mouse=(${o}, ${a})`),console.log("[DRAG] Before click: draggedItem=",this.draggedItem));const n=this.chestContents[i]||[];if(this.draggedItem)if("container"===e){const e=n[t];if(e&&e.type)if(e.type===this.draggedItem.type){const t=(this.itemTypes[e.type]?.maxStack||64)-e.count,i=Math.min(t,this.draggedItem.count);e.count+=i,this.draggedItem.count-=i,this.draggedItem.count<=0&&(this.draggedItem=null)}else n[t]={...this.draggedItem},this.draggedItem={...e};else n[t]={...this.draggedItem},this.draggedItem=null}else{const i="hotbar"===e?this.inventory.hotbar:this.inventory.main,s=i[t];if(s&&s.id)if(s.id===this.draggedItem.type){const t=(this.itemTypes[s.id]?.maxStack||64)-s.count,e=Math.min(t,this.draggedItem.count);s.count+=e,this.draggedItem.count-=e,this.draggedItem.count<=0&&(this.draggedItem=null)}else{const e={type:s.id,count:s.count};i[t]={type:"block",id:this.draggedItem.type,count:this.draggedItem.count},this.draggedItem=e}else i[t]={type:"block",id:this.draggedItem.type,count:this.draggedItem.count},this.draggedItem=null}else if("container"===e){const e=n[t];if(e&&e.type)if(s&&e.count>1){const t=Math.ceil(e.count/2);this.draggedItem={type:e.type,count:t},e.count-=t}else this.draggedItem={...e},n[t]=null}else{const i="hotbar"===e?this.inventory.hotbar:this.inventory.main,o=i[t];if(o&&o.id)if(s&&o.count>1){const t=Math.ceil(o.count/2);this.draggedItem={type:o.id,count:t},o.count-=t}else this.draggedItem={type:o.id,count:o.count},i[t]=null}this.chestContents[i]=n,this.renderContainerUI(document.getElementById("containerTitle").textContent,i),this.updateHotbarDisplay(),this.debugSettings.dragDebug&&console.log("[DRAG] After click: draggedItem=",this.draggedItem),this.updateDragCursor(o,a)},updateDragCursor(t,e){let i=document.getElementById("dragGhost");if(this.debugSettings.dragDebug&&console.log(`[DRAG] updateDragCursor called: mouseX=${t}, mouseY=${e}, draggedItem=`,this.draggedItem),this.draggedItem){i||(i=document.createElement("div"),i.id="dragGhost",i.className="drag-ghost",document.body.appendChild(i),this.debugSettings.dragDebug&&console.log("[DRAG] Created new ghost element"),document.addEventListener("mousemove",t=>{const e=document.getElementById("dragGhost");e&&"none"!==e.style.display&&(e.style.left=t.clientX+"px",e.style.top=t.clientY+"px"),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}));const s=this.getItemEmoji({id:this.draggedItem.type});i.innerHTML=`<span class="ghost-icon">${s}</span>`,this.draggedItem.count>1&&(i.innerHTML+=`<span class="ghost-count">${this.draggedItem.count}</span>`);const o=t||this.lastMouseX||0,a=e||this.lastMouseY||0;i.style.left=o+"px",i.style.top=a+"px",i.style.display="block",this.debugSettings.dragDebug&&(console.log(`[DRAG] Ghost updated: emoji="${s}", pos=(${o}, ${a}), display=${i.style.display}`),console.log("[DRAG] Ghost computed style:",window.getComputedStyle(i)))}else i&&(i.style.display="none",this.debugSettings.dragDebug&&console.log("[DRAG] Ghost hidden (no dragged item)"))},closeContainer(){this.draggedItem&&(this.dropItem(this.camera.x,this.camera.y,this.camera.z,this.draggedItem.type,this.draggedItem.count),this.draggedItem=null),this.containerOpen=!1,this.openContainerPos=null,this.openContainerType=null;const t=document.getElementById("dragGhost");t&&(t.style.display="none");const e=document.getElementById("containerScreen");e&&e.classList.remove("active"),this.updateHotbarDisplay()},dropHeldItem(){const t=this.inventory.hotbar[this.selectedSlot];if(t&&t.count>0){const e=-Math.sin(this.camera.rotY),i=Math.cos(this.camera.rotY),s=t.id||t.type;this.dropItem(this.camera.x+1.5*e,this.camera.y,this.camera.z+1.5*i,s,1),t.count--,t.count<=0&&(this.inventory.hotbar[this.selectedSlot]=null,this.selectedItem=null),this.updateHotbarDisplay()}},debugConsoleOpen:!1,debugNoclip:!1,debugGodMode:!1,debugSettings:{showFPS:!1,showCoords:!1,showDepthOrder:!1,showFaceNormals:!1,showBoundingBoxes:!1,showRaycastVector:!1,showProjectionTest:!1,wireframeOnly:!1,disableFaceCulling:!1,showOverdraw:!1,highlightZFighting:!1,showTargetInfo:!1,renderAlgorithm:"painter",showTreeDiag:!1,highlightBlockType:null,showFaceOrder:!1,showDistanceHeatmap:!1,pauseRendering:!1,capturedFrame:null,showRenderStats:!1,showNearPlaneClipping:!1,showBlockModels:!1,showCameraAngle:!1,showSwimDebug:!1,swimConsoleLog:!1,dragDebug:!1},debugFly:!1,debugMoveSpeed:null,toggleDebugConsole(){this.debugConsoleOpen=!this.debugConsoleOpen;const t=document.getElementById("debugConsole"),e=document.getElementById("renderCanvas");if(console.log("[Console] Toggle debug console, now open:",this.debugConsoleOpen),console.log("[Console] isPaused:",this.isPaused),console.log("[Console] isActive:",this.isActive),t)if(this.debugConsoleOpen){t.classList.add("active"),t.style.display="flex",document.pointerLockElement&&document.exitPointerLock(),this.pointerLocked=!1,e&&e.blur();const i=document.getElementById("debugOutput"),s=document.getElementById("debugInput");this.debugLog('Debug console opened. Type "help" for commands.',"info"),setTimeout(()=>{i&&(i.scrollTop=i.scrollHeight),s&&(s.focus(),s.select())},100)}else{t.classList.remove("active"),t.style.display="none";const i=document.getElementById("debugSuggestions");i&&i.classList.remove("active"),e&&(e.focus(),setTimeout(()=>{this.isActive&&!this.isPaused&&e.requestPointerLock()},100))}},setupDebugConsole(){console.log("[Autocomplete] Setting up debug console...");const t=document.getElementById("debugConsole");t&&(t.classList.remove("active"),t.style.display="none");const e=this;setTimeout(function(){console.log("[Autocomplete] setTimeout fired, calling setupDebugConsoleActual..."),e.setupDebugConsoleActual()},100)},setupDebugConsoleActual(){console.log("[Autocomplete] Setting up autocomplete (delayed)...");const t=document.getElementById("debugConsole"),e=document.getElementById("debugInput");let i=document.getElementById("debugSuggestions");if(console.log("[Autocomplete] Element check:"),console.log("  - debugConsole:",t),console.log("  - debugInput:",e),console.log("  - debugSuggestions:",i),!t||!e)return void console.error("[Autocomplete] ERROR: Required elements not found! Cannot proceed.");const s=t.querySelector(".debug-console-header");if(s){let e=!1,i=0,o=0,a=0,n=0;const l=window.getComputedStyle(t);let r=parseInt(l.left)||10,h=parseInt(l.top)||50;s.addEventListener("mousedown",t=>{"debugFps"!==t.target.id&&(a=t.clientX-r,n=t.clientY-h,e=!0,s.style.cursor="grabbing")});let c=!1,d="",u=0,g=0,f=0,m=0,p=0,y=0;const b=s=>{if(c){s.preventDefault();let e=u,i=g,o=p,a=y;const n=s.clientX-f,l=s.clientY-m;d.includes("e")?e=Math.max(300,u+n):d.includes("w")&&(e=Math.max(300,u-n),o=p+(u-e)),d.includes("s")?i=Math.max(200,g+l):d.includes("n")&&(i=Math.max(200,g-l),a=y+(g-i)),t.style.width=`${e}px`,t.style.maxHeight=`${i}px`,t.style.left=`${o}px`,t.style.top=`${a}px`,r=o,h=a}else if(e){s.preventDefault(),i=s.clientX-a,o=s.clientY-n,r=i,h=o;const e=window.innerWidth-100,l=window.innerHeight-50,c=Math.max(0,Math.min(i,e)),d=Math.max(0,Math.min(o,l));t.style.left=`${c}px`,t.style.top=`${d}px`,r=c,h=d}else{const e=t.getBoundingClientRect(),i=10,o=s.clientY-e.top<i,a=e.bottom-s.clientY<i,n=s.clientX-e.left<i,l=e.right-s.clientX<i;t.style.cursor=o&&n||a&&l?"nwse-resize":o&&l||a&&n?"nesw-resize":o||a?"ns-resize":n||l?"ew-resize":"default"}};t.addEventListener("mousedown",e=>{if(e.target.closest(".debug-console-header"))return;const i=t.getBoundingClientRect(),s=e.clientY-i.top<10,o=i.bottom-e.clientY<10,a=e.clientX-i.left<10,n=i.right-e.clientX<10;(s||o||a||n)&&(c=!0,d="",s&&(d+="n"),o&&(d+="s"),a&&(d+="w"),n&&(d+="e"),f=e.clientX,m=e.clientY,u=i.width,g=i.height,p=i.left,y=i.top,e.preventDefault())}),document.addEventListener("mousemove",b),document.addEventListener("mouseup",()=>{e&&(e=!1,s.style.cursor="move"),c&&(c=!1,t.style.cursor="default")}),console.log("[Console] Made draggable and resizable!")}if(!i){console.log("[Autocomplete] debugSuggestions not found, creating dynamically..."),i=document.createElement("div"),i.id="debugSuggestions",i.className="debug-console-suggestions";const s=e.parentElement;s&&s.nextSibling?t.insertBefore(i,s.nextSibling):t.appendChild(i),console.log("[Autocomplete] Created debugSuggestions:",i)}console.log("[Autocomplete] All elements ready, proceeding with setup...");const o=[{name:"help",desc:"Show all available commands"},{name:"noclip",desc:"Toggle flying through walls"},{name:"god",desc:"Toggle invincibility"},{name:"coords",desc:"Toggle coordinate display"},{name:"tp",desc:"Teleport to position or landmark"},{name:"give",desc:"Give yourself items"},{name:"time",desc:"Set game time"},{name:"wave",desc:"Set wave number"},{name:"fly",desc:"Toggle fly mode"},{name:"speed",desc:"Set movement speed"},{name:"clear",desc:"Clear console output"},{name:"fps",desc:"Toggle FPS display"},{name:"render",desc:"Rendering debug: wireframe|depthorder|normals|bounds|raycast|projection|culling|overdraw|all|none"},{name:"algo",desc:"Set render algorithm: painter|zbuffer|bsp"}];let a=-1,n=[];const l=document.getElementById("debugInput"),r=t=>{const e=document.getElementById("debugSuggestions");if(!e||0===n.length)return;a=t;e.querySelectorAll(".debug-suggestion-item").forEach((t,e)=>{e===a?t.classList.add("selected"):t.classList.remove("selected")})};if(l){console.log("[Autocomplete] Input element found, attaching listeners"),console.log("[Autocomplete] Input element:",l);const t=document.getElementById("debugSuggestions");console.log("[Autocomplete] Suggestions element on setup:",t),l.addEventListener("input",t=>{const e=l.value.trim().split(" ")[0];console.log("[Autocomplete] Input event fired, query:",e),(t=>{const e=document.getElementById("debugSuggestions");if(console.log("[Autocomplete] Query:",t),console.log("[Autocomplete] suggestionsEl:",e),!e||!t)return e&&e.classList.remove("active"),n=[],void(a=-1);n=o.filter(e=>e.name.toLowerCase().startsWith(t.toLowerCase())),console.log("[Autocomplete] Current suggestions:",n),0!==n.length?(e.innerHTML="",n.forEach((t,i)=>{const s=document.createElement("div");s.className="debug-suggestion-item",i===a&&s.classList.add("selected"),s.innerHTML=`<span class="suggestion-name">${t.name}</span><span class="suggestion-desc">${t.desc}</span>`,s.addEventListener("click",()=>{l.value=t.name+" ",l.focus(),e.classList.remove("active"),n=[],a=-1}),e.appendChild(s)}),console.log("[Autocomplete] Added active class, innerHTML:",e.innerHTML.substring(0,100)),e.classList.add("active")):e.classList.remove("active")})(e)}),l.addEventListener("keydown",t=>{if("ArrowDown"===t.key)t.preventDefault(),n.length>0&&(a=(a+1)%n.length,r(a));else if("ArrowUp"===t.key)t.preventDefault(),n.length>0&&(a=a<=0?n.length-1:a-1,r(a));else if("Tab"===t.key){if(t.preventDefault(),n.length>0){a<0&&(a=0),a=t.shiftKey?a<=0?n.length-1:a-1:(a+1)%n.length,l.value=n[a].name+" ";const e=document.getElementById("debugSuggestions");e&&e.classList.remove("active"),n=[],a=-1,l.focus()}}else if("Enter"===t.key)if(t.preventDefault(),a>=0)(()=>{if(a>=0&&a<n.length){l.value=n[a].name+" ";const t=document.getElementById("debugSuggestions");t&&t.classList.remove("active"),n=[],a=-1}})();else{const t=l.value.trim();if(t){this.executeDebugCommand(t),l.value="";const e=document.getElementById("debugSuggestions");e&&e.classList.remove("active"),n=[],a=-1}}else if("`"===t.key||"~"===t.key)t.preventDefault(),this.toggleDebugConsole();else if("Escape"===t.key&&n.length>0){t.preventDefault();const e=document.getElementById("debugSuggestions");e&&e.classList.remove("active"),n=[],a=-1}t.stopPropagation()}),l.addEventListener("keyup",t=>t.stopPropagation())}},debugLog(t,e="normal"){const i=document.getElementById("debugOutput");if(i){const s=document.createElement("div");for(s.className=e,s.textContent=`> ${t}`,i.appendChild(s),i.scrollTop=i.scrollHeight;i.children.length>100;)i.removeChild(i.firstChild)}},executeDebugCommand(t){const e=t.toLowerCase().split(" "),i=e[0],s=e.slice(1);switch(this.debugLog(t,"normal"),i){case"help":this.debugLog("Commands:","info"),this.debugLog("  noclip - Toggle flying through walls","info"),this.debugLog("  god - Toggle invincibility","info"),this.debugLog("  coords - Toggle coordinate display","info"),this.debugLog("  tp <x> <y> <z> - Teleport to position","info"),this.debugLog("  tp <landmark> - Teleport to landmark","info"),this.debugLog("    landmarks: ritual, gunsmith, spawn","info"),this.debugLog("  give <item> [count] - Give item","info"),this.debugLog("  spawn <mob> [count] - Spawn mobs","info"),this.debugLog("    mobs: bird, fish, cat, creeper, bluebird, gunsmith","info"),this.debugLog("  time <ms> - Set bird event timer","info"),this.debugLog("  kill - Kill all mobs","info"),this.debugLog("  clear - Clear console","info"),this.debugLog("  pos - Show current position","info"),this.debugLog("  fly - Toggle flight mode","info"),this.debugLog("  speed <value> - Set move speed","info"),this.debugLog("  ritual - Complete ritual instantly","info"),this.debugLog("  score <value> - Set score","info"),this.debugLog("  algo <type> - Set render algorithm","info"),this.debugLog("    painter|zbuffer|bsp","info"),this.debugLog("","info"),this.debugLog("Rendering Debug:","info"),this.debugLog("  render <option> - Toggle render debug","info"),this.debugLog("    wireframe - Wireframe-only mode","info"),this.debugLog("    depthorder - Show depth sorting","info"),this.debugLog("    normals - Show face normals","info"),this.debugLog("    bounds - Show bounding boxes","info"),this.debugLog("    raycast - Show raycast vector","info"),this.debugLog("    projection - Test projection","info"),this.debugLog("    culling - Disable face culling","info"),this.debugLog("    overdraw - Show overdraw heatmap","info"),this.debugLog("    targetinfo - Raycast vs render diagnostic","info"),this.debugLog("    treediag - Tree/foliage flicker diagnostic","info"),this.debugLog("    faceorder - Show face render order","info"),this.debugLog("    heatmap - Distance-based heatmap","info"),this.debugLog("    stats - Show render statistics","info"),this.debugLog("    highlight <type> - Highlight block type","info"),this.debugLog("    pause - Pause/capture render frame","info"),this.debugLog("    all - Toggle all render debug","info"),this.debugLog("    none - Turn all render debug OFF","info");break;case"noclip":this.debugNoclip=!this.debugNoclip,this.debugLog("Noclip: "+(this.debugNoclip?"ON":"OFF"),this.debugNoclip?"success":"warn");break;case"god":this.debugGodMode=!this.debugGodMode,this.debugLog("God mode: "+(this.debugGodMode?"ON":"OFF"),this.debugGodMode?"success":"warn");break;case"coords":this.debugSettings.showCoords=!this.debugSettings.showCoords,this.debugLog("Coords display: "+(this.debugSettings.showCoords?"ON":"OFF"),"success");break;case"fly":this.debugFly=!this.debugFly,this.debugLog("Fly mode: "+(this.debugFly?"ON":"OFF"),this.debugFly?"success":"warn");break;case"tp":if(s.length>=1){const t=s[0].toLowerCase();if("ritual"===t||"temple"===t)this.ritualTempleLocation?(this.camera.x=this.ritualTempleLocation.x+5,this.camera.y=this.ritualTempleLocation.y+3,this.camera.z=this.ritualTempleLocation.z+5,this.velocity={x:0,y:0,z:0},this.debugLog("Teleported to Ritual Temple","success")):this.debugLog("Ritual temple not found","error");else if("gunsmith"===t||"npc"===t||"repair"===t)this.repairNPC?(this.camera.x=this.repairNPC.x,this.camera.y=this.repairNPC.y+2,this.camera.z=this.repairNPC.z,this.velocity={x:0,y:0,z:0},this.debugLog("Teleported to Gunsmith NPC","success")):this.debugLog("Gunsmith NPC not found (not spawned yet)","error");else if("spawn"===t||"home"===t)this.camera.x=0,this.camera.y=10,this.camera.z=0,this.velocity={x:0,y:0,z:0},this.debugLog("Teleported to spawn","success");else if(s.length>=3){const t=parseFloat(s[0]),e=parseFloat(s[1]),i=parseFloat(s[2]);isNaN(t)||isNaN(e)||isNaN(i)?this.debugLog("Invalid coordinates","error"):(this.camera.x=t,this.camera.y=e,this.camera.z=i,this.velocity={x:0,y:0,z:0},this.debugLog(`Teleported to ${t.toFixed(1)}, ${e.toFixed(1)}, ${i.toFixed(1)}`,"success"))}else this.debugLog("Usage: tp <x> <y> <z> OR tp <landmark>","error"),this.debugLog("Landmarks: ritual, gunsmith, spawn","info")}else this.debugLog("Usage: tp <x> <y> <z> OR tp <landmark>","error"),this.debugLog("Landmarks: ritual, gunsmith, spawn","info");break;case"temple":this.ritualTempleLocation?(this.camera.x=this.ritualTempleLocation.x+5,this.camera.y=this.ritualTempleLocation.y+3,this.camera.z=this.ritualTempleLocation.z+5,this.velocity={x:0,y:0,z:0},this.debugLog("Teleported to Ritual Temple","success")):this.debugLog("Temple not found","error");break;case"pos":this.debugLog(`Position: ${this.camera.x.toFixed(2)}, ${this.camera.y.toFixed(2)}, ${this.camera.z.toFixed(2)}`,"info"),this.debugLog(`Rotation: ${(180*this.camera.rotX/Math.PI).toFixed(1)}¬∞, ${(180*this.camera.rotY/Math.PI).toFixed(1)}¬∞`,"info");break;case"give":if(s.length>=1){const t=s[0],e=s.length>=2?parseInt(s[1]):1;this.blockColors[t]||this.itemTypes[t]?(this.addToInventory(t,e),this.debugLog(`Given ${e}x ${t}`,"success")):(this.debugLog(`Unknown item: ${t}`,"error"),this.debugLog("Items: "+Object.keys(this.itemTypes).slice(0,10).join(", ")+"...","info"))}else this.debugLog("Usage: give <item> [count]","error");break;case"spawn":const t=s[0],e=s.length>=2?parseInt(s[1]):1,o=["bird","pest","fish","cat","creeper","bluebird","gunsmith"];if("bird"===t||"pest"===t){for(let t=0;t<e;t++)this.spawnPestBird();this.debugLog(`Spawned ${e} pest bird(s)`,"success")}else if("fish"===t){for(let t=0;t<e;t++)this.spawnFish();this.debugLog(`Spawned ${e} fish`,"success")}else if("cat"===t){for(let t=0;t<e;t++)this.spawnCat();this.debugLog(`Spawned ${e} cat(s)`,"success")}else if("creeper"===t){for(let t=0;t<e;t++)this.spawnCreeper();this.debugLog(`Spawned ${e} creeper(s)`,"success")}else if("bluebird"===t){for(let t=0;t<e;t++)this.spawnBlueBird();this.debugLog(`Spawned ${e} blue bird(s)`,"success")}else"gunsmith"===t||"npc"===t||"repair"===t?(this.spawnRepairNPC(),this.debugLog("Spawned gunsmith NPC","success")):(this.debugLog("Usage: spawn <mob> [count]","error"),this.debugLog("Mobs: "+o.join(", "),"info"));break;case"kill":let a=0;a+=this.pestBirds?this.pestBirds.length:0,a+=this.blueBirds?this.blueBirds.length:0,a+=this.creepers?this.creepers.length:0,this.pestBirds=[],this.blueBirds=[],this.creepers=[],this.debugLog(`Killed ${a} mobs`,"success");break;case"time":if(s.length>=1){const t=parseInt(s[0]);!isNaN(t)&&this.birdEvent&&(this.birdEvent.timer=t,this.debugLog(`Bird event timer set to ${t}ms`,"success"))}else this.debugLog("Usage: time <ms>","error");break;case"clear":const n=document.getElementById("debugOutput");n&&(n.innerHTML="");break;case"speed":s.length>=1?(this.debugMoveSpeed=parseFloat(s[0]),this.debugLog(`Speed set to ${this.debugMoveSpeed}`,"success")):this.debugLog("Usage: speed <value> (default: 0.12)","error");break;case"ritual":this.ritualComplete=!0,this.ritualBlessingActive=!0,this.ritualBlessingTimer=36e3,this.socketsFilled={petalSocket:!0,ropeSocket:!0,charmSocket:!0,plaqueSocket:!0,incenseSocket:!0},this.triggerRitualReward(),this.debugLog("Ritual completed!","success");break;case"score":s.length>=1&&this.survivalStats&&(this.survivalStats.score=parseInt(s[0]),this.updateSurvivalHUD(),this.debugLog(`Score set to ${this.survivalStats.score}`,"success"));break;case"render":const l=s[0]?s[0].toLowerCase():"";if(!l){this.debugLog("Usage: render <option>","error"),this.debugLog("Options: wireframe, depthorder, normals, bounds, raycast, projection, culling, overdraw, all, none","info"),this.debugLog("Example: render wireframe","info");break}switch(l){case"wireframe":this.debugSettings.wireframeOnly=!this.debugSettings.wireframeOnly,this.debugLog("Wireframe mode: "+(this.debugSettings.wireframeOnly?"ON":"OFF"),"success");break;case"depthorder":this.debugSettings.showDepthOrder=!this.debugSettings.showDepthOrder,this.debugLog("Depth order display: "+(this.debugSettings.showDepthOrder?"ON":"OFF"),"success");break;case"normals":this.debugSettings.showFaceNormals=!this.debugSettings.showFaceNormals,this.debugLog("Face normals: "+(this.debugSettings.showFaceNormals?"ON":"OFF"),"success");break;case"bounds":this.debugSettings.showBoundingBoxes=!this.debugSettings.showBoundingBoxes,this.debugLog("Bounding boxes: "+(this.debugSettings.showBoundingBoxes?"ON":"OFF"),"success");break;case"raycast":this.debugSettings.showRaycastVector=!this.debugSettings.showRaycastVector,this.debugLog("Raycast vector: "+(this.debugSettings.showRaycastVector?"ON":"OFF"),"success");break;case"projection":this.debugSettings.showProjectionTest=!this.debugSettings.showProjectionTest,this.debugLog("Projection test: "+(this.debugSettings.showProjectionTest?"ON":"OFF"),"success"),this.debugLog("A test point will be shown at camera center","info");break;case"culling":this.debugSettings.disableFaceCulling=!this.debugSettings.disableFaceCulling,this.debugLog("Face culling: "+(this.debugSettings.disableFaceCulling?"DISABLED":"ENABLED"),this.debugSettings.disableFaceCulling?"warn":"success");break;case"overdraw":this.debugSettings.showOverdraw=!this.debugSettings.showOverdraw,this.debugLog("Overdraw visualization: "+(this.debugSettings.showOverdraw?"ON":"OFF"),"success");break;case"targetinfo":this.debugSettings.showTargetInfo=!this.debugSettings.showTargetInfo,this.debugLog("Target info: "+(this.debugSettings.showTargetInfo?"ON":"OFF"),"success"),this.debugSettings.showTargetInfo&&this.debugLog("Shows raycast hit position, world data, and render status","info");break;case"treediag":this.debugSettings.showTreeDiag=!this.debugSettings.showTreeDiag,this.debugLog("Tree diagnostic: "+(this.debugSettings.showTreeDiag?"ON":"OFF"),"success"),this.debugSettings.showTreeDiag&&(this.debugLog("Shows leaf/foliage render analysis","info"),this.debugLog("- Red outline: Potential Z-fighting","info"),this.debugLog("- Numbers: Render order within group","info"));break;case"faceorder":this.debugSettings.showFaceOrder=!this.debugSettings.showFaceOrder,this.debugLog("Face order display: "+(this.debugSettings.showFaceOrder?"ON":"OFF"),"success"),this.debugSettings.showFaceOrder&&this.debugLog("Shows render order of individual faces","info");break;case"heatmap":this.debugSettings.showDistanceHeatmap=!this.debugSettings.showDistanceHeatmap,this.debugLog("Distance heatmap: "+(this.debugSettings.showDistanceHeatmap?"ON":"OFF"),"success"),this.debugSettings.showDistanceHeatmap&&this.debugLog("Colors blocks by distance (red=close, blue=far)","info");break;case"stats":this.debugSettings.showRenderStats=!this.debugSettings.showRenderStats,this.debugLog("Render stats: "+(this.debugSettings.showRenderStats?"ON":"OFF"),"success");break;case"highlight":if(s[0]){const t=s[0].toLowerCase();this.debugSettings.highlightBlockType===t?(this.debugSettings.highlightBlockType=null,this.debugLog("Highlight OFF","warn")):(this.debugSettings.highlightBlockType=t,this.debugLog(`Highlighting: ${t}`,"success"))}else this.debugSettings.highlightBlockType=null,this.debugLog("Usage: render highlight <block_type>","info"),this.debugLog("Example: render highlight leaves","info"),this.debugLog("Common types: leaves, wood, grass, stone, sand","info");break;case"pause":this.debugSettings.pauseRendering=!this.debugSettings.pauseRendering,this.debugSettings.pauseRendering?(this.debugLog("Render PAUSED - frame captured","warn"),this.debugLog('Use "render pause" again to resume',"info")):(this.debugSettings.capturedFrame=null,this.debugLog("Render RESUMED","success"));break;case"nearplane":this.debugSettings.showNearPlaneClipping=!this.debugSettings.showNearPlaneClipping,this.debugLog("Near-plane clipping debug: "+(this.debugSettings.showNearPlaneClipping?"ON":"OFF"),"success"),this.debugSettings.showNearPlaneClipping&&(this.debugLog("Shows faces with clamped vertices (prevents see-through)","info"),this.debugLog("Green outline = normal, Red = clamped vertex","info"));break;case"blockmodels":case"models":if(this.debugSettings.showBlockModels=!this.debugSettings.showBlockModels,this.debugLog("Block models debug: "+(this.debugSettings.showBlockModels?"ON":"OFF"),"success"),this.debugSettings.showBlockModels){this.debugLog("Shows custom block model bounds for furniture/containers","info");const t=Object.keys(this.blockModels||{});this.debugLog(`Blocks with custom models: ${t.join(", ")}`,"info")}break;case"angle":case"camera":this.debugSettings.showCameraAngle=!this.debugSettings.showCameraAngle,this.debugLog("Camera angle debug: "+(this.debugSettings.showCameraAngle?"ON":"OFF"),"success"),this.debugSettings.showCameraAngle&&this.debugLog("Shows camera rotation angles and look direction","info");break;case"swim":case"swimming":this.debugSettings.showSwimDebug=!this.debugSettings.showSwimDebug,this.debugLog("Swimming debug: "+(this.debugSettings.showSwimDebug?"ON":"OFF"),"success"),this.debugSettings.showSwimDebug&&(this.debugLog("Shows swimming state, physics branch, and velocities","info"),this.debugLog("Key insight: BRANCH shows which physics code is running","info"));break;case"swimlog":this.debugSettings.swimConsoleLog=!this.debugSettings.swimConsoleLog,this.debugLog("Swim console logging: "+(this.debugSettings.swimConsoleLog?"ON":"OFF"),"success"),this.debugSettings.swimConsoleLog&&this.debugLog("Check browser console (F12) for frame-by-frame swim data","info");break;case"drag":case"dragdebug":if(this.debugSettings.dragDebug=!this.debugSettings.dragDebug,this.debugLog("Drag debug: "+(this.debugSettings.dragDebug?"ON":"OFF"),"success"),this.debugSettings.dragDebug){this.debugLog("Check browser console (F12) for drag/drop info when clicking items","info");const t=document.getElementById("dragGhost");this.debugLog("Current ghost element: "+(t?"exists":"not created"),"info"),t&&this.debugLog(`Ghost display: ${t.style.display}, position: (${t.style.left}, ${t.style.top})`,"info"),this.debugLog(`draggedItem: ${this.draggedItem?JSON.stringify(this.draggedItem):"null"}`,"info")}break;case"all":const t=!this.debugSettings.wireframeOnly;this.debugSettings.wireframeOnly=t,this.debugSettings.showDepthOrder=t,this.debugSettings.showFaceNormals=t,this.debugSettings.showBoundingBoxes=t,this.debugSettings.showRaycastVector=t,this.debugSettings.showProjectionTest=t,this.debugSettings.showOverdraw=t,this.debugSettings.showTargetInfo=t,this.debugLog("All render debug: "+(t?"ON":"OFF"),t?"success":"warn");break;case"none":this.debugSettings.wireframeOnly=!1,this.debugSettings.showDepthOrder=!1,this.debugSettings.showFaceNormals=!1,this.debugSettings.showBoundingBoxes=!1,this.debugSettings.showRaycastVector=!1,this.debugSettings.showProjectionTest=!1,this.debugSettings.showOverdraw=!1,this.debugSettings.disableFaceCulling=!1,this.debugSettings.showTargetInfo=!1,this.debugSettings.showTreeDiag=!1,this.debugSettings.showFaceOrder=!1,this.debugSettings.showDistanceHeatmap=!1,this.debugSettings.showRenderStats=!1,this.debugSettings.highlightBlockType=null,this.debugSettings.pauseRendering=!1,this.debugSettings.capturedFrame=null,this.debugSettings.showNearPlaneClipping=!1,this.debugSettings.showBlockModels=!1,this.debugSettings.showCameraAngle=!1,this.debugSettings.showSwimDebug=!1,this.debugSettings.swimConsoleLog=!1,this.debugSettings.dragDebug=!1,this.debugLog("All render debug: OFF","warn");break;default:this.debugLog(`Unknown render option: ${l}`,"error"),this.debugLog("Options: wireframe, depthorder, normals, bounds, raycast, projection, culling, overdraw, targetinfo, treediag, faceorder, heatmap, stats, highlight, pause, nearplane, blockmodels, angle, swim, swimlog, drag, all, none","info")}break;case"algo":const r=s[0]?s[0].toLowerCase():"";if(!r||!["painter","zbuffer","bsp"].includes(r)){this.debugLog("Usage: algo <type>","error"),this.debugLog("Types: painter, zbuffer, bsp","info"),this.debugLog("  painter  - Classic painter's algorithm (sort back-to-front)","info"),this.debugLog("  zbuffer  - Z-buffer simulation (sub-pixel depth precision)","info"),this.debugLog("  bsp      - Binary Space Partitioning (spatial tree)","info"),this.debugLog(`Current: ${this.debugSettings.renderAlgorithm}`,"info");break}this.debugSettings.renderAlgorithm=r,this.debugLog(`Render algorithm: ${r.toUpperCase()}`,"success");const h={painter:"Sorts blocks and faces by distance, renders back-to-front",zbuffer:"Enhanced depth sorting with sub-pixel precision",bsp:"Spatial tree traversal for optimal rendering order"};this.debugLog(h[r],"info");break;default:this.debugLog(`Unknown command: ${i}`,"error")}},triggerRitualReward(){this.birdEvent&&this.showBirdAlert("üå∏ DIVINE BLESSING ACTIVATED! üå∏"),this.ritualFlight=!0,this.ritualFlightTimer=7200,this.ritualBarrierActive=!0,this.addToInventory("berdger",1),this.addToInventory("apple",32),this.survivalStats&&(this.survivalStats.score+=1e4,this.survivalStats.wave++,this.survivalStats.currentObjective={text:"‚ú® Divine protection active!",type:"blessed"},this.updateSurvivalHUD());for(const t of this.pestBirds)t.state="fleeing",t.stateTimer=1200,t.anger=0;for(let t=0;t<100;t++)this.particles.push({x:this.camera.x+10*(Math.random()-.5),y:this.camera.y+8*Math.random()-2,z:this.camera.z+10*(Math.random()-.5),vx:.15*(Math.random()-.5),vy:.1+.2*Math.random(),vz:.15*(Math.random()-.5),life:200+100*Math.random(),type:"blessing",size:4+4*Math.random()})},pickupQueue:{},pickupTimer:null,queuePickupNotification(t,e){this.pickupQueue[t]||(this.pickupQueue[t]=0),this.pickupQueue[t]+=e,this.pickupTimer&&clearTimeout(this.pickupTimer),this.pickupTimer=setTimeout(()=>{this.flushPickupNotifications()},500)},flushPickupNotifications(){const t=document.getElementById("pickupNotification");if(!t)return;const e={grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",appleLeaves:"Apple Leaves",leaves:"Leaves",sand:"Sand",brick:"Brick",ka69:"KA-69",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",seeds:"Seeds",berdger:"The Berdger",apple:"Apple",sakuraPetal:"Cherry Petal",shimenawa:"Sacred Rope",omamori:"Charm",ema:"Wish Plaque",incense:"Incense",whiteBrick:"White Brick",redBrick:"Red Brick",glowstone:"Burgerstone",ritualStone:"Ritual Stone"};for(const[i,s]of Object.entries(this.pickupQueue)){if(0===s)continue;const o=document.createElement("div");o.className="pickup-item";const a=document.createElement("canvas");a.width=24,a.height=24,this.drawMiniBlock(a,i),o.innerHTML=`\n                        <span class="pickup-icon"></span>\n                        <span>+${s} ${e[i]||i}</span>\n                    `,o.querySelector(".pickup-icon").appendChild(a),t.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},2e3)}this.pickupQueue={},this.pickupTimer=null},setFluidLevel(t,e,i,s){const o=`${t},${e},${i}`;s<=0?delete this.fluidLevels[o]:this.fluidLevels[o]=Math.min(8,Math.max(1,s))},getFluidLevel(t,e,i){return this.fluidLevels[`${t},${e},${i}`]||0},updateFluids(){if(this.fluidUpdateTimer||(this.fluidUpdateTimer=0),this.fluidUpdateTimer++,this.fluidUpdateTimer<8)return;this.fluidUpdateTimer=0;let t=0;for(;this.fluidUpdates.length>0&&t<2;){const e=this.fluidUpdates.shift();t++;const i=this.getBlock(e.x,e.y,e.z);if(!i||!this.fluidBlocks.includes(i)){this.setFluidLevel(e.x,e.y,e.z,0);continue}const s=e.level||8,o=this.getBlock(e.x,e.y-1,e.z);if("water"===o&&"lava"===e.type){this.setBlock(e.x,e.y-1,e.z,"stone"),this.setFluidLevel(e.x,e.y-1,e.z,0);continue}if("lava"===o&&"water"===e.type){this.setBlock(e.x,e.y-1,e.z,"obsidian"),this.setFluidLevel(e.x,e.y-1,e.z,0);continue}if(!o){this.setBlock(e.x,e.y-1,e.z,e.type),this.setFluidLevel(e.x,e.y-1,e.z,8),this.fluidUpdates.push({x:e.x,y:e.y-1,z:e.z,type:e.type,level:8});continue}const a=s-1;if(!(a<=0)&&(o&&!this.fluidBlocks.includes(o))){const t=[{x:1,z:0},{x:-1,z:0},{x:0,z:1},{x:0,z:-1}];for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}for(const i of t){const t=e.x+i.x,s=e.z+i.z,o=this.getBlock(t,e.y,s),n=this.getFluidLevel(t,e.y,s);"lava"!==e.type||"water"!==o?"water"!==e.type||"lava"!==o?o?o===e.type&&n<a&&(this.setFluidLevel(t,e.y,s,a),this.fluidUpdates.push({x:t,y:e.y,z:s,type:e.type,level:a})):(this.setBlock(t,e.y,s,e.type),this.setFluidLevel(t,e.y,s,a),this.fluidUpdates.push({x:t,y:e.y,z:s,type:e.type,level:a})):(this.setBlock(t,e.y,s,"stone"),this.setFluidLevel(t,e.y,s,0)):(this.setBlock(t,e.y,s,"stone"),this.setFluidLevel(t,e.y,s,0))}}}},toggleInventory(){this.inventoryOpen=!this.inventoryOpen;const t=document.getElementById("inventoryScreen");t&&t.classList.toggle("active",this.inventoryOpen),this.inventoryOpen?(this.inventoryHeldItem=null,this.renderInventory(),document.pointerLockElement&&document.exitPointerLock()):(this.inventoryHeldItem=null,this.updateInventoryHeldCursor(),this.justClosedInventory=!0,setTimeout(()=>{this.justClosedInventory=!1},100),this.isPaused||this.canvas.requestPointerLock())},attemptRepair(){const t=this.getItemCount("seed");if(t<15)return void this.debugLog(`Repair NPC: "Need 15 seeds! You only have ${t}."`,"warn");let e=!1;for(let i=0;i<this.inventory.hotbar.length;i++){const t=this.inventory.hotbar[i];if(t&&"ka69"===t.id&&void 0!==t.durability&&0===t.durability){t.durability=t.maxDurability||100,e=!0,this.debugLog('‚ú® Repair NPC: "Your KA-69 is good as new!"',"success");break}}if(!e)for(let i=0;i<this.inventory.main.length;i++){const t=this.inventory.main[i];if(t&&"ka69"===t.id&&void 0!==t.durability&&0===t.durability){t.durability=t.maxDurability||100,e=!0,this.debugLog('‚ú® Repair NPC: "Your KA-69 is good as new!"',"success");break}}e?(this.removeItemFromInventory("seed",15),this.updateHotbarDisplay(),this.repairNPC&&(this.repairNPC.lastSpoke=Date.now())):this.debugLog('Repair NPC: "You don\'t have a broken KA-69 to fix!"',"warn")},openDialogue(t){"gunsmith"===t&&(this.dialogueOpen=!0,this.currentDialogueNPC="gunsmith",this.isPaused=!0,document.pointerLockElement&&document.exitPointerLock(),this.gunsmithMetBefore||(this.gunsmithMetBefore=!0,this.questData.meet_gunsmith&&(this.questData.meet_gunsmith.stage=1,this.quests.push(this.questData.meet_gunsmith))),this.renderDialogue())},closeDialogue(){this.dialogueOpen=!1,this.currentDialogueNPC=null,this.isPaused=!1;const t=document.getElementById("dialogueScreen");t&&(t.style.display="none");const e=document.getElementById("clickToPlay");e&&e.classList.add("active")},toggleJournal(){if(this.journalOpen=!this.journalOpen,this.journalOpen)this.isPaused=!0,document.pointerLockElement&&document.exitPointerLock(),this.renderJournal();else{this.isPaused=!1;const t=document.getElementById("journalScreen");t&&(t.style.display="none");const e=document.getElementById("clickToPlay");e&&e.classList.add("active")}},renderDialogue(){let t=document.getElementById("dialogueScreen");t&&t.remove(),t=document.createElement("div"),t.id="dialogueScreen",t.style.cssText="\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, -50%);\n                    width: min(92vw, 500px);\n                    background: rgba(30, 20, 40, 0.97);\n                    border: 3px solid #8b7355;\n                    border-radius: 8px;\n                    color: #fff;\n                    font-family: 'Courier New', monospace;\n                    z-index: 9999;\n                    box-shadow: 0 0 30px rgba(0,0,0,0.7);\n                    overflow: hidden;\n                ";if((document.getElementById("minecraftGame")||document.body).appendChild(t),!document.getElementById("dialogueStyles")){const t=document.createElement("style");t.id="dialogueStyles",t.textContent="\n                        #dialogueScreen .dialogue-content::-webkit-scrollbar { width: 8px; }\n                        #dialogueScreen .dialogue-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }\n                        #dialogueScreen .dialogue-content::-webkit-scrollbar-thumb { background: #8b7355; border-radius: 4px; }\n                        #dialogueScreen .dialogue-content::-webkit-scrollbar-thumb:hover { background: #a08060; }\n                    ",document.head.appendChild(t)}if("gunsmith"===this.currentDialogueNPC){const e=this.gunsmithDialogueStage;let i="üßô Gunsmith Wizard",s="";s=this.gunsmithMetBefore&&0!==e?'\n                            <p>"Ah, back again! How\'s the bird-battling going?"</p>\n                            <p><em>*He peers at you with curious eyes*</em></p>\n                            <p>"I\'m still working on tracking down the source of all these birds. \n                            The more data we gather, the closer we get to the truth!"</p>\n                        ':'\n                            <p><em>*The wizard adjusts his pointed hat and grins*</em></p>\n                            <p>"Ah! A fellow survivor of the Great Feathering! Welcome!"</p>\n                            <p>"I\'ve been studying these birds for quite some time. Aggressive spawning, \n                            coordinated attacks, suspiciously optimized pathfinding..."</p>\n                            <p><em>*He pulls out a worn notebook*</em></p>\n                            <p>"I think there\'s a <strong>source</strong> to all this. Something is spawning \n                            these creatures at an unnaturally high rate!"</p>\n                            <p>"I\'m a traveling gunsmith‚ÄîI can repair your KA-69. And if you want to \n                            <em>solve</em> this bird problem, I could use your help."</p>\n                        ';const o=Math.min(.4*window.innerHeight,200);t.innerHTML=`\n                        \x3c!-- Header --\x3e\n                        <div style="padding: 12px 16px; border-bottom: 2px solid #8b7355; background: rgba(20, 15, 30, 0.5);">\n                            <h2 style="color: #ffd700; margin: 0; font-size: 15px;">${i}</h2>\n                        </div>\n                        \n                        \x3c!-- Scrollable Content - explicit max-height --\x3e\n                        <div class="dialogue-content" style="max-height: ${o}px; overflow-y: scroll; padding: 12px 16px; font-size: 12px; line-height: 1.5;">\n                            ${s}\n                        </div>\n                        \n                        \x3c!-- Fixed Options --\x3e\n                        <div style="padding: 10px 16px; border-top: 2px solid #8b7355; background: rgba(20, 15, 30, 0.5);">\n                            <div onclick="window.game.handleDialogueChoice('speak')" \n                                 style="padding: 8px 10px; margin: 4px 0; background: rgba(139, 115, 85, 0.3); \n                                        border: 2px solid #8b7355; border-radius: 4px; cursor: pointer; \n                                        transition: all 0.2s; font-size: 11px;"\n                                 onmouseover="this.style.background='rgba(139, 115, 85, 0.5)'"\n                                 onmouseout="this.style.background='rgba(139, 115, 85, 0.3)'">\n                                üí¨ <strong>Speak</strong> - "Tell me about your quest"\n                            </div>\n                            <div onclick="window.game.handleDialogueChoice('repair')" \n                                 style="padding: 8px 10px; margin: 4px 0; background: rgba(65, 105, 225, 0.3); \n                                        border: 2px solid #4169e1; border-radius: 4px; cursor: pointer;\n                                        transition: all 0.2s; font-size: 11px;"\n                                 onmouseover="this.style.background='rgba(65, 105, 225, 0.5)'"\n                                 onmouseout="this.style.background='rgba(65, 105, 225, 0.3)'">\n                                üîß <strong>Repair KA-69</strong> - 15 seeds\n                            </div>\n                            <div onclick="window.game.handleDialogueChoice('exit')" \n                                 style="padding: 8px 10px; margin: 4px 0; background: rgba(139, 0, 0, 0.3); \n                                        border: 2px solid #8b0000; border-radius: 4px; cursor: pointer;\n                                        transition: all 0.2s; font-size: 11px;"\n                                 onmouseover="this.style.background='rgba(139, 0, 0, 0.5)'"\n                                 onmouseout="this.style.background='rgba(139, 0, 0, 0.3)'">\n                                üö™ <strong>Exit</strong>\n                            </div>\n                        </div>\n                    `,t.querySelectorAll(".dialogue-content p").forEach(t=>{t.style.margin="6px 0"});const a=t.querySelector(".dialogue-content");a&&a.addEventListener("wheel",t=>{t.stopPropagation(),a.scrollTop+=t.deltaY},{passive:!0})}},handleDialogueChoice(t){"speak"===t?this.showQuestDialogue():"repair"===t?(this.attemptRepair(),setTimeout(()=>{this.dialogueOpen&&this.renderDialogue()},100)):"exit"===t&&this.closeDialogue()},showQuestDialogue(){const t=document.getElementById("dialogueScreen");if(!t)return;const e=Math.min(.4*window.innerHeight,200);t.innerHTML=`\n                    \x3c!-- Header --\x3e\n                    <div style="padding: 12px 16px; border-bottom: 2px solid #8b7355; background: rgba(20, 15, 30, 0.5);">\n                        <h2 style="color: #ffd700; margin: 0; font-size: 15px;">üßô Gunsmith Wizard</h2>\n                    </div>\n                    \n                    \x3c!-- Scrollable Content - explicit max-height --\x3e\n                    <div class="dialogue-content" style="max-height: ${e}px; overflow-y: scroll; padding: 12px 16px; font-size: 12px; line-height: 1.5;">\n                        <p>"Excellent! I knew you had that collaborative spirit!"</p>\n                        <p><em>*He spreads out a map with various markings*</em></p>\n                        <p>"These birds aren't randomly spawning. There's <em>intelligence</em> behind this. \n                        Maybe a cursed artifact, maybe a rogue wizard!"</p>\n                        <p>"I need <strong>data</strong>. Survive some waves, gather drops from defeated birds, \n                        and come back to me."</p>\n                        <div style="background: rgba(255, 215, 0, 0.15); border: 1px solid #ffd700; border-radius: 4px; padding: 10px; margin: 10px 0;">\n                            <p style="color: #ffd700; margin: 0 0 6px 0;">\n                                <strong>üìú QUEST: Origin of the Feathered Menace</strong>\n                            </p>\n                            <p style="margin: 3px 0; color: #ccc;">‚Ä¢ Survive 3 bird waves</p>\n                            <p style="margin: 3px 0; color: #ccc;">‚Ä¢ Collect 50 bird drops</p>\n                            <p style="margin: 3px 0; color: #ccc;">‚Ä¢ Return to the Gunsmith</p>\n                        </div>\n                        <p style="color: #aaa;">Press <strong>J</strong> to open your journal.</p>\n                    </div>\n                    \n                    \x3c!-- Fixed Options --\x3e\n                    <div style="padding: 10px 16px; border-top: 2px solid #8b7355; background: rgba(20, 15, 30, 0.5);">\n                        <div onclick="window.game.handleDialogueChoice('exit')" \n                             style="padding: 8px 10px; margin: 4px 0; background: rgba(65, 105, 225, 0.3); \n                                    border: 2px solid #4169e1; border-radius: 4px; cursor: pointer;\n                                    transition: all 0.2s; font-size: 11px;"\n                             onmouseover="this.style.background='rgba(65, 105, 225, 0.5)'"\n                             onmouseout="this.style.background='rgba(65, 105, 225, 0.3)'">\n                            ‚úì <strong>Accept Quest</strong>\n                        </div>\n                    </div>\n                `,t.querySelectorAll(".dialogue-content > p").forEach(t=>{t.style.margin="6px 0"});const i=t.querySelector(".dialogue-content");i&&i.addEventListener("wheel",t=>{t.stopPropagation(),i.scrollTop+=t.deltaY},{passive:!0}),"locked"===this.questData.birds_origin.status&&(this.questData.birds_origin.status="active",this.questData.birds_origin.stage=1,this.quests.push(this.questData.birds_origin)),this.questData.meet_gunsmith&&(this.questData.meet_gunsmith.stage=2,this.questData.meet_gunsmith.status="completed")},renderJournal(){let t=document.getElementById("journalScreen");if(!t){t=document.createElement("div"),t.id="journalScreen",t.style.cssText="\n                        position: absolute;\n                        top: 50%;\n                        left: 50%;\n                        transform: translate(-50%, -50%);\n                        width: min(90%, 600px);\n                        max-height: 80%;\n                        background: rgba(40, 30, 20, 0.97);\n                        border: 4px solid #8b7355;\n                        border-radius: 8px;\n                        padding: 20px;\n                        color: #fff;\n                        font-family: 'Courier New', monospace;\n                        z-index: 9999;\n                        overflow-y: auto;\n                        box-shadow: 0 0 40px rgba(0,0,0,0.8);\n                    ";(document.getElementById("minecraftGame")||document.body).appendChild(t)}t.style.display="block";let e='\n                    <div style="border-bottom: 2px solid #8b7355; padding-bottom: 12px; margin-bottom: 15px;">\n                        <h1 style="color: #ffd700; margin: 0; font-size: 22px;">üìñ Quest Journal</h1>\n                        <p style="color: #aaa; margin: 4px 0 0 0; font-size: 11px;">Press J to close</p>\n                    </div>\n                ';const i=this.quests.filter(t=>"active"===t.status);i.length>0&&(e+='<h2 style="color: #4169e1; margin: 15px 0 8px 0; font-size: 16px;">Active Quests</h2>',i.forEach(t=>{e+=`\n                            <div style="background: rgba(65, 105, 225, 0.2); border: 2px solid #4169e1; \n                                        border-radius: 6px; padding: 12px; margin: 8px 0;">\n                                <h3 style="color: #ffd700; margin: 0 0 8px 0; font-size: 14px;">${t.title}</h3>\n                                <p style="line-height: 1.4; margin: 6px 0; font-size: 12px;">${t.description}</p>\n                                <div style="margin-top: 10px;">\n                                    <strong style="color: #4169e1; font-size: 12px;">Objectives:</strong>\n                                    <ul style="margin: 4px 0; padding-left: 18px; font-size: 12px;">\n                                        ${t.objectives.map(t=>`<li style="margin: 2px 0;">${t}</li>`).join("")}\n                                    </ul>\n                                </div>\n                                ${t.progress?`\n                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #4169e1; font-size: 12px;">\n                                        <strong>Progress:</strong> \n                                        Waves: ${t.progress.waves}/3 | \n                                        Drops: ${t.progress.drops}/50\n                                    </div>\n                                `:""}\n                            </div>\n                        `}));const s=this.quests.filter(t=>"completed"===t.status);s.length>0&&(e+='<h2 style="color: #228b22; margin: 20px 0 8px 0; font-size: 16px;">Completed Quests</h2>',s.forEach(t=>{e+=`\n                            <div style="background: rgba(34, 139, 34, 0.2); border: 2px solid #228b22; \n                                        border-radius: 6px; padding: 12px; margin: 8px 0; opacity: 0.7;">\n                                <h3 style="color: #90ee90; margin: 0 0 6px 0; font-size: 14px;">‚úì ${t.title}</h3>\n                                <p style="line-height: 1.4; margin: 6px 0; font-size: 11px;">${t.description}</p>\n                            </div>\n                        `})),0===this.quests.length&&(e+='\n                        <div style="text-align: center; padding: 30px; color: #888;">\n                            <p style="font-size: 14px;">No quests yet...</p>\n                            <p style="font-size: 12px;">Talk to NPCs to discover new quests!</p>\n                        </div>\n                    '),t.innerHTML=e},renderInventory(){const t=document.getElementById("inventoryScreen");if(!t)return;const e=t=>{if(!t)return"";const e=t.id||t.type;return{grass:"Grass Block",dirt:"Dirt",stone:"Stone",wood:"Wood",leaves:"Leaves",water:"Water",sand:"Sand",brick:"Brick",ka69:"KA-69",water_bucket:"Water Bucket",lava_bucket:"Lava Bucket",lava:"Lava",obsidian:"Obsidian",cherryWood:"Cherry Wood",cherryLeaves:"Cherry Leaves",chest:"Chest",ritualChest:"Ritual Chest",buildingChest:"Building Chest",dungeonChest:"Dungeon Chest",seeds:"Seeds",berdger:"The Berdger",sakuraPetal:"Sacred Cherry Petal",shimenawa:"Sacred Rope",omamori:"Protective Charm",ema:"Wooden Wish Plaque",incense:"Purifying Incense",bedrock:"Bedrock",deepslate:"Deepslate",mossyStone:"Mossy Stone",dungeonBrick:"Dungeon Brick",dungeonMossy:"Mossy Dungeon Brick",sakuraite:"Sakuraite Ore",moonstone:"Moonstone Ore",jadite:"Jadite Ore",crimsonite:"Crimsonite Ore",voidstone:"Voidstone Ore",spirite:"Spirite Ore",barrel:"Storage Barrel",crate:"Wooden Crate",furnace:"Furnace",alchemyTable:"Alchemy Table",storageShrine:"Storage Shrine",whiteBrick:"White Brick",redBrick:"Red Brick",glowstone:"Burgerstone",ritualStone:"Ritual Stone",appleLeaves:"Apple Tree Leaves"}[e]||e},i=this.craftingCollapsed||!1;let s='<div class="inventory-container">';if(s+='<div class="inv-header"><h2>üì¶ Inventory</h2><button class="inv-close-btn" onclick="minecraftGame.toggleInventory()">‚úï</button></div>',s+='<div class="crafting-section">',s+='<div class="crafting-header" onclick="minecraftGame.toggleCrafting()">',s+=`<h3>üî® Crafting ${i?"‚ñ∂":"‚ñº"}</h3>`,s+="</div>",!i){s+='<div class="recipe-list">';for(const t of this.recipes){const e=this.canCraftRecipe(t);s+=`<div class="recipe ${e?"craftable":"disabled"}" data-recipe="${t.name}">`,s+=`<span class="recipe-name">${t.name}</span>`,s+='<span class="recipe-ingredients">',t.ingredients.forEach(t=>{s+=`${t.count}x ${t.id} `}),s+="</span>",s+=`<span class="recipe-result">‚Üí ${t.result.count}x ${t.result.id}</span>`,e&&(s+=`<button class="craft-btn" onclick="event.stopPropagation(); minecraftGame.craftRecipe('${t.name}')">Craft</button>`),s+="</div>"}s+="</div>"}s+="</div>",s+='<div class="inv-hotbar">',s+="<h3>Hotbar</h3>",s+='<div class="inv-slots" id="hotbarSlots">',this.inventory.hotbar.forEach((t,i)=>{const o=this.getItemEmoji(t),a=t&&t.count>0,n=a?e(t):"";s+=`<div class="inv-slot ${i===this.selectedSlot?"selected":""} ${a?"has-item":""}" \n                        data-source="hotbar" data-index="${i}" ${n?`data-tooltip="${n}"`:""}>\n                        ${a?`<span class="slot-icon">${o}</span>`:""}\n                        ${a&&t.count>1?`<span class="slot-count">${t.count}</span>`:""}\n                    </div>`}),s+="</div></div>",s+='<div class="inv-main">',s+="<h3>Storage</h3>",s+='<div class="inv-slots" id="storageSlots">';for(let o=0;o<27;o++){const t=this.inventory.main[o],i=t&&t.count>0,a=i?this.getItemEmoji(t):"",n=i?e(t):"";s+=`<div class="inv-slot ${i?"has-item":"empty"}" data-source="main" data-index="${o}" ${n?`data-tooltip="${n}"`:""}>\n                        ${i?`<span class="slot-icon">${a}</span>`:""}\n                        ${i&&t.count>1?`<span class="slot-count">${t.count}</span>`:""}\n                    </div>`}s+="</div></div>",s+='<p class="inv-hint">Click to pick up/place items | ESC or E to close</p>',s+="</div>",t.innerHTML=s,this.setupInventoryClickHandlers()},toggleCrafting(){this.craftingCollapsed=!this.craftingCollapsed;const t=document.querySelector(".inventory-container"),e=t?t.scrollTop:0;this.renderInventory(),requestAnimationFrame(()=>{const t=document.querySelector(".inventory-container");t&&(t.scrollTop=e)})},setupInventoryClickHandlers(){document.querySelectorAll("#inventoryScreen .inv-slot").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const i=e,s=t.dataset.source,o=parseInt(t.dataset.index);this.handleInventorySlotClick(s,o,i.clientX,i.clientY)}),t.addEventListener("contextmenu",t=>{t.preventDefault(),t.stopPropagation()})})},handleInventorySlotClick(t,e,i,s){const o="hotbar"===t?this.inventory.hotbar:this.inventory.main,a=o[e];if(this.debugSettings.dragDebug&&(console.log(`[INV] Click: source=${t}, index=${e}, mouse=(${i}, ${s})`),console.log("[INV] inventoryHeldItem=",this.inventoryHeldItem),console.log("[INV] clickedItem=",a)),this.inventoryHeldItem){const n=this.inventoryHeldItem.source,l=this.inventoryHeldItem.index,r="hotbar"===n?this.inventory.hotbar:this.inventory.main,h=r[l];r[l]=a,o[e]=h,this.inventoryHeldItem=null,this.updateInventorySlotDisplay(n,l),this.updateInventorySlotDisplay(t,e),this.updateInventoryHeldCursor(i,s),this.updateHotbarDisplay()}else if(a&&a.count>0){this.inventoryHeldItem={source:t,index:e,item:{...a}},this.updateInventoryHeldCursor(i,s);const o=document.querySelector(`.inv-slot[data-source="${t}"][data-index="${e}"]`);o&&o.classList.add("held"),this.debugSettings.dragDebug&&console.log("[INV] Picked up item:",this.inventoryHeldItem)}},updateInventorySlotDisplay(t,e){const i=("hotbar"===t?this.inventory.hotbar:this.inventory.main)[e],s=document.querySelector(`.inv-slot[data-source="${t}"][data-index="${e}"]`);if(s)if(s.classList.remove("held","has-item","empty"),i&&i.count>0){s.classList.add("has-item");const t=this.getItemEmoji(i);s.innerHTML=`<span class="slot-icon">${t}</span>`,i.count>1&&(s.innerHTML+=`<span class="slot-count">${i.count}</span>`)}else s.classList.add("empty"),s.innerHTML=""},updateInventoryHeldCursor(t,e){let i=document.getElementById("invHeldGhost");if(this.inventoryHeldItem){const{source:s,index:o}=this.inventoryHeldItem,a=("hotbar"===s?this.inventory.hotbar:this.inventory.main)[o];if(a&&a.count>0){i||(i=document.createElement("div"),i.id="invHeldGhost",i.className="inv-held-ghost",document.body.appendChild(i),document.addEventListener("mousemove",t=>{const e=document.getElementById("invHeldGhost");e&&"none"!==e.style.display&&(e.style.left=t.clientX+"px",e.style.top=t.clientY+"px"),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY})),i.innerHTML=`<span class="ghost-icon">${this.getItemEmoji(a)}</span>`,a.count>1&&(i.innerHTML+=`<span class="ghost-count">${a.count}</span>`);const s=t||this.lastMouseX||0,o=e||this.lastMouseY||0;i.style.left=s+"px",i.style.top=o+"px",i.style.display="block"}else i&&(i.style.display="none")}else i&&(i.style.display="none")},swapInventorySlots(t,e,i,s){const o="hotbar"===t?this.inventory.hotbar:this.inventory.main,a="hotbar"===i?this.inventory.hotbar:this.inventory.main,n=o[e],l=a[s];if(o[e]=l,a[s]=n,"hotbar"===t||"hotbar"===i){const t=this.inventory.hotbar[this.selectedSlot];t?"block"===t.type?(this.selectedBlock=t.id,this.selectedItem=null):"weapon"===t.type&&(this.selectedItem=t.id,this.selectedBlock=null):(this.selectedBlock=null,this.selectedItem=null)}},getItemEmoji(t){if(!t)return"";return{grass:"üåø",dirt:"üü´",stone:"ü™®",wood:"ü™µ",leaves:"üå∏",water:"üíß",sand:"üèñÔ∏è",brick:"üß±",ka69:"üî´",water_bucket:"ü™£",lava_bucket:"ü´ß",lava:"üî•",obsidian:"üü£",cherryWood:"ü™µ",cherryLeaves:"üå∏",chest:"üì¶",ritualChest:"üì¶",buildingChest:"üì¶",dungeonChest:"üì¶",seeds:"üåæ",berdger:"üçî",sakuraPetal:"üå∏",shimenawa:"ü™¢",omamori:"üéÄ",ema:"ü™ß",incense:"üïØÔ∏è",bedrock:"‚¨õ",deepslate:"ü™®",mossyStone:"ü™®",dungeonBrick:"üß±",dungeonMossy:"üß±",sakuraite:"üíé",moonstone:"üåô",jadite:"üíö",crimsonite:"‚ù§Ô∏è",voidstone:"üñ§",spirite:"üí†",barrel:"üõ¢Ô∏è",crate:"üì¶",furnace:"üî•",alchemyTable:"‚öóÔ∏è",storageShrine:"‚õ©Ô∏è",whiteBrick:"üß±",redBrick:"üß±",glowstone:"üí°",ritualStone:"ü™®",appleLeaves:"üçÉ",table:"ü™ë",chair:"ü™ë",bed:"üõèÔ∏è",bedPillow:"üõèÔ∏è",cashRegister:"üßæ",stool:"ü™ë",counter:"üóÑÔ∏è",lamp:"üí°",bookshelf:"üìö",plant:"üåø",sink:"üö∞",stove:"üî•",fridge:"üßä"}[t.id||t.type]||"‚ùì"},canCraftRecipe(t){for(const e of t.ingredients){if(this.countItem(e.id)<e.count)return!1}return!0},countItem(t){let e=0;for(const i of this.inventory.hotbar)i&&i.id===t&&(e+=i.count);for(const i of this.inventory.main)i&&i.id===t&&(e+=i.count);return e},craftRecipe(t){const e=this.recipes.find(e=>e.name===t);if(e&&this.canCraftRecipe(e)){for(const t of e.ingredients)this.removeItem(t.id,t.count);this.addItem(e.result),this.renderInventory()}},removeItem(t,e){let i=e;for(const s of this.inventory.hotbar)if(s&&s.id===t&&i>0){const t=Math.min(s.count,i);s.count-=t,i-=t}for(const s of this.inventory.main)if(s&&s.id===t&&i>0){const t=Math.min(s.count,i);s.count-=t,i-=t}},addItem(t){for(const e of this.inventory.hotbar)if(e&&e.id===t.id&&e.count<64){const i=Math.min(64-e.count,t.count);if(e.count+=i,t.count-=i,t.count<=0)return}for(const e of this.inventory.main)if(e&&e.id===t.id&&e.count<64){const i=Math.min(64-e.count,t.count);if(e.count+=i,t.count-=i,t.count<=0)return}for(let e=0;e<this.inventory.main.length;e++)if(!this.inventory.main[e])return void(this.inventory.main[e]={...t})},raycast(){const t=-this.camera.rotX,e=-this.camera.rotY,i=Math.cos(t),s=Math.sin(t),o=Math.cos(e),a=Math.sin(e)*i,n=s,l=o*i,r=Math.sqrt(a*a+n*n+l*l),h=a/r,c=n/r,d=l/r,u=this.camera.x,g=this.camera.y+this.getEyeHeight(),f=this.camera.z;let m=Math.floor(u),p=Math.floor(g),y=Math.floor(f);const b=h>=0?1:-1,v=c>=0?1:-1,x=d>=0?1:-1,k=Math.abs(1/h),M=Math.abs(1/c),S=Math.abs(1/d);let w,T,B;w=h>0?(m+1-u)/h:h<0?(m-u)/h:1/0,T=c>0?(p+1-g)/c:c<0?(p-g)/c:1/0,B=d>0?(y+1-f)/d:d<0?(y-f)/d:1/0;let P=null;let C=0,I=null,z=!1,$=!1;for(let L=0;L<100;L++){const t=this.getBlock(m,p,y);if(t){if("water"!==t&&"lava"!==t){let e=null;const i=(z||$)&&I||P;return!i||0===i.x&&0===i.y&&0===i.z||(e={x:m+i.x,y:p+i.y,z:y+i.z}),{hit:{x:m,y:p,z:y},place:e,block:t,throughWater:z,throughLava:$,hitT:C,enteredFace:i,lastSolidFace:I,rawEnteredFace:P,debugTMax:{x:w,y:T,z:B},debugStep:{x:b,y:v,z:x}}}"water"===t&&(z=!0),"lava"===t&&($=!0)}else I=P;if(w<T&&w<B){if(C=w,C>4)break;m+=b,w+=k,P={x:-b,y:0,z:0}}else if(T<B){if(C=T,C>4)break;p+=v,T+=M,P={x:0,y:-v,z:0}}else{if(C=B,C>4)break;y+=x,B+=S,P={x:0,y:0,z:-x}}}return null},update(){if(!this.isActive||this.isPaused)return;this.shootCooldown>0&&this.shootCooldown--,this.muzzleFlash>0&&this.muzzleFlash--,this.ritualFlightTimer>0&&(this.ritualFlightTimer--,this.ritualFlightTimer<=0&&(this.ritualFlight=!1));const t=this.debugMoveSpeed||.12,e=this.debugNoclip||this.debugFly||this.ritualFlight?2*t:t,i=Math.sin(this.camera.rotY),s=Math.cos(this.camera.rotY);if(this.debugNoclip||this.debugFly){let t=0,o=0,a=0;return this.keys.w&&(t-=i*Math.cos(this.camera.rotX)*e,o-=Math.sin(this.camera.rotX)*e,a+=s*Math.cos(this.camera.rotX)*e),this.keys.s&&(t+=i*Math.cos(this.camera.rotX)*e,o+=Math.sin(this.camera.rotX)*e,a-=s*Math.cos(this.camera.rotX)*e),this.keys.a&&(t-=s*e,a-=i*e),this.keys.d&&(t+=s*e,a+=i*e),this.keys[" "]&&(o+=e),this.keys.shift&&(o-=e),this.debugNoclip,this.camera.x+=t,this.camera.y+=o,this.camera.z+=a,void(this.velocity={x:0,y:0,z:0})}if(this.ritualFlight){let t=0,o=0,a=0;this.keys.w&&(t-=i*e,a+=s*e),this.keys.s&&(t+=i*e,a-=s*e),this.keys.a&&(t-=s*e,a-=i*e),this.keys.d&&(t+=s*e,a+=i*e),this.keys[" "]&&(o+=e),this.keys.shift&&(o-=e);const n=this.camera.x+t,l=this.camera.y+o,r=this.camera.z+a,h=Math.floor(l-this.playerEyeHeight),c=Math.floor(l),d=Math.floor(n),u=Math.floor(r);let g=!0;for(let e=h;e<=c;e++){const t=this.getBlock(d,e,u);if(t&&!this.fluidBlocks.includes(t)){g=!1;break}}return g&&(this.camera.x=n,this.camera.y=l,this.camera.z=r),void(this.velocity={x:0,y:0,z:0})}const o=this.camera.y-this.playerEyeHeight,a=o+this.playerHeight,n=Math.floor(this.camera.x),l=Math.floor(this.camera.z),r=this.getBlock(n,Math.floor(o),l),h=this.getBlock(n,Math.floor(o+.9),l),c=this.getBlock(n,Math.floor(a-.1),l),d=this.getBlock(n,Math.floor(o)-1,l),u="water"===r,g="water"===h,f="water"===c,m="lava"===c,p=u||g,y="lava"===r||"lava"===h,b=p||y,v=f||m,x=g&&!f&&this.velocity.y>-.02,k=x&&!this.keys.shift;this.inWater=p||f,this.inLava=y||m,this.swimming=b,this.headSubmergedWater=f,this.headSubmergedLava=m,this.swimDebugInfo={feetBlock:r||"air",waistBlock:h||"air",headBlock:c||"air",belowFeetBlock:d||"air",feetInWater:u,waistInWater:g,headInWater:f,inWater:p,swimming:b,submerged:v,stableAtSurface:x,atFluidSurface:k,velocityY:this.velocity.y,playerFeetY:o,physicsBranch:"none"};let M=1;p&&(M=.65),y&&(M=.35);let S=0,w=0;const T=t;this.keys.w&&(S-=i*T*M,w+=s*T*M),this.keys.s&&(S+=i*T*M,w-=s*T*M),this.keys.a&&(S-=s*T*M,w-=i*T*M),this.keys.d&&(S+=s*T*M,w+=i*T*M);const B=this.camera.x,P=this.camera.z,C=.25,I=1.8;if(this.collidesAt(this.camera.x,this.camera.y,this.camera.z,C,I)){let t=!1;for(let e=.1;e<=1.5&&!t;e+=.1){const i=[0,45,90,135,180,225,270,315];for(const s of i){const i=s*Math.PI/180,o=this.camera.x+Math.cos(i)*e,a=this.camera.z+Math.sin(i)*e;if(!this.collidesAt(o,this.camera.y,a,C,I)){this.camera.x=o,this.camera.z=a,t=!0;break}}t||this.collidesAt(this.camera.x,this.camera.y+e,this.camera.z,C,I)||(this.camera.y+=e,t=!0)}}let z=this.camera.x,$=this.camera.z;const L=S/8,E=w/8;for(let H=0;H<8;H++){const t=z+L;if(this.collidesAt(t,this.camera.y,$,C,I)){const t=.5*L;this.collidesAt(z+t,this.camera.y,$,C,I)||(z+=t)}else z=t;const e=$+E;if(this.collidesAt(z,this.camera.y,e,C,I)){const t=.5*E;this.collidesAt(z,this.camera.y,$+t,C,I)||($+=t)}else $=e}this.collidesAt(z,this.camera.y,$,C,I)&&(z=this.camera.x,$=this.camera.z),this.camera.x=z,this.camera.z=$;const F=this.camera.x-B,D=this.camera.z-P;if(this.stats.distance+=Math.sqrt(F*F+D*D),b){const t=y,e=t?.9:.92,i=t?.1:.14;if(k){this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="FLOAT");const t=.002,e=.75;this.velocity.y<-.002?this.velocity.y+=4*t:this.velocity.y>.002&&(this.velocity.y-=3*t),this.velocity.y*=e,this.velocity.y=Math.max(-.006,Math.min(.006,this.velocity.y)),this.keys[" "]&&(this.velocity.y=.22,this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="JUMP"))}else{this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="SINK");const s=t?.01:.014,o=t?.032:.048,a=t?.018:.028;this.velocity.y-=s,this.keys[" "]&&(this.velocity.y+=o,this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="SWIM_UP")),this.keys.shift&&(this.velocity.y-=a,this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="DIVE")),this.velocity.y*=e,this.velocity.y=Math.max(-i,Math.min(i,this.velocity.y))}}else this.swimDebugInfo&&(this.swimDebugInfo.physicsBranch="GRAVITY"),this.velocity.y+=this.gravity;this.debugSettings.swimConsoleLog&&this.swimDebugInfo&&this.swimming&&console.log(`[SWIM] branch=${this.swimDebugInfo.physicsBranch} velY=${this.velocity.y.toFixed(4)} waist=${this.swimDebugInfo.waistInWater} head=${this.swimDebugInfo.headInWater} stable=${this.swimDebugInfo.stableAtSurface} atSurf=${this.swimDebugInfo.atFluidSurface}`);const R=this.camera.y+this.velocity.y,A=this.getGroundHeightBelow(this.camera.x,this.camera.z,this.camera.y)+this.playerEyeHeight+.5;if(b)R<A?(this.camera.y=A,this.velocity.y=Math.max(0,this.velocity.y)):this.camera.y=R,this.isJumping=!0;else if(R<A){this.camera.y=A,this.velocity.y=0,this.isJumping=!1;const t=Date.now(),e=350;this.lastJumpTime||(this.lastJumpTime=0),this.keys[" "]&&t-this.lastJumpTime>e&&(this.velocity.y=.28,this.isJumping=!0,this.stats.jumps++,this.lastJumpTime=t)}else this.camera.y=R;const O=this.getCeilingAbove(this.camera.x,this.camera.z,this.camera.y);if(null!==O&&this.camera.y>O-.5&&(this.camera.y=O-.5,this.velocity.y=0),this.worldBounds){const t=.5,e=.3;this.camera.x<this.worldBounds.minX+t&&(this.camera.x=this.worldBounds.minX+t,this.velocity.x=Math.abs(this.velocity.x||0)*e),this.camera.x>this.worldBounds.maxX-t&&(this.camera.x=this.worldBounds.maxX-t,this.velocity.x=-Math.abs(this.velocity.x||0)*e),this.camera.z<this.worldBounds.minZ+t&&(this.camera.z=this.worldBounds.minZ+t,this.velocity.z=Math.abs(this.velocity.z||0)*e),this.camera.z>this.worldBounds.maxZ-t&&(this.camera.z=this.worldBounds.maxZ-t,this.velocity.z=-Math.abs(this.velocity.z||0)*e),this.camera.y<this.worldBounds.minY+this.playerEyeHeight&&(this.camera.y=this.worldBounds.minY+this.playerEyeHeight,this.velocity.y=.15)}"trippy"===this.settings.filter&&this.applyFilters()},collidesAt(t,e,i,s,o){const a=e-this.playerEyeHeight,n=[{x:t-s,z:i-s},{x:t+s,z:i-s},{x:t-s,z:i+s},{x:t+s,z:i+s},{x:t,z:i}];for(const l of n){const t=Math.floor(l.x),e=Math.floor(l.z);for(let i=Math.floor(a);i<Math.floor(a+o);i++){const s=this.getBlock(t,i,e);if(s&&!this.fluidBlocks.includes(s))return!0}}return!1},getGroundHeightBelow(t,e,i,s=null){const o=Math.floor(t),a=Math.floor(e),n=null!==s?s:this.playerEyeHeight;for(let l=Math.floor(i-n);l>=0;l--){const t=this.getBlock(o,l,a);if(t&&!this.fluidBlocks.includes(t))return l+1}return 0},getGroundHeight(t,e){const i=Math.floor(t),s=Math.floor(e);for(let o=40;o>=0;o--){const t=this.getBlock(i,o,s);if(t&&"water"!==t&&"lava"!==t)return o}return 0},getCeilingAbove(t,e,i){const s=Math.floor(t),o=Math.floor(e),a=Math.floor(i);for(let n=a;n<=a+3;n++){const t=this.getBlock(s,n,o);if(t&&!this.fluidBlocks.includes(t))return n}return null},render(){if(!this.isActive)return;const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=this.camera.y+this.getEyeHeight();if(!this.cachedSky||this.cachedSky.w!==e||this.cachedSky.h!==i||this.cachedSky.lighting!==this.settings.lighting){const s=t.createLinearGradient(0,0,0,i);this.settings.lighting?(s.addColorStop(0,"#1a0a1a"),s.addColorStop(.5,"#2d1f3d"),s.addColorStop(1,"#ffb7c5")):(s.addColorStop(0,"#111"),s.addColorStop(1,"#333")),this.cachedSky={grad:s,w:e,h:i,lighting:this.settings.lighting}}t.fillStyle=this.cachedSky.grad,t.fillRect(0,0,e,i);const o=this.camera.x,a=s,n=this.camera.z,l=Math.cos(-this.camera.rotY),r=Math.sin(-this.camera.rotY),h=Math.cos(-this.camera.rotX),c=Math.sin(-this.camera.rotX),d=e/2,u=i/2,g=400,f=this.settings.renderDistance,m=f*f,p=(t,e,i)=>{const s=t-o,f=e-a,m=i-n,p=s*l-m*r,y=s*r+m*l,b=f*h-y*c,v=f*c+y*h;if(v<=.05){const t=.05,e=t/Math.max(v,.001);return{x:d+p*e/t*g,y:u-b*e/t*g,z:t,clamped:!0}}return{x:d+p/v*g,y:u-b/v*g,z:v}},y=[],b=-Math.sin(this.camera.rotY),v=Math.cos(this.camera.rotY),x=Math.floor(o),k=Math.floor(a),M=Math.floor(n),S=Math.ceil(f);for(let D=x-S;D<=x+S;D++)for(let t=M-S;t<=M+S;t++){const e=D+.5-o,i=t+.5-n,s=e*e+i*i;if(s>m)continue;if(!(e*b+i*v<-3&&s>16))for(let o=Math.max(0,k-S);o<=Math.min(60,k+S);o++){const e=`${D},${o},${t}`,i=this.world[e];if(!i)continue;const n=o+.5-a,l=s+n*n;l>m||y.push({x:D,y:o,z:t,dist:l,type:i})}}y.sort((t,e)=>e.dist-t.dist);const w=(t,e,i)=>this.world[`${t},${e},${i}`],T=t=>{if(!t)return!0;if(this.fluidBlocks.includes(t))return!0;const e=this.blockColors[t];return!(!e||!e.transparent)},B=t=>{if(!t)return!1;const e=this.blockColors[t];return(!e||!e.transparent)&&!this.fluidBlocks.includes(t)},P=(t,e,i)=>this.fluidLevels[`${t},${e},${i}`]||8,C=.002*Date.now(),I=[],z=[];for(let D=0;D<y.length;D++){const t=y[D],e=this.blockColors[t.type];e&&e.transparent?z.push(t):I.push(t)}const $=(t,e,i)=>{const s=[[t+.5,e+.5,i+.5],[t+.1,e+.1,i+.1],[t+.9,e+.1,i+.1],[t+.1,e+.9,i+.1],[t+.9,e+.9,i+.1],[t+.1,e+.1,i+.9],[t+.9,e+.1,i+.9],[t+.1,e+.9,i+.9],[t+.9,e+.9,i+.9]];for(const[l,r,h]of s){const s=l-o,c=r-a,d=h-n,u=Math.sqrt(s*s+c*c+d*d);let g=!1;const f=Math.min(8,Math.ceil(u/2));for(let l=1;l<f;l++){const r=l/f,h=Math.floor(o+s*r),u=Math.floor(a+c*r),m=Math.floor(n+d*r);if(h===t&&u===e&&m===i)continue;const p=w(h,u,m);if(p&&!this.fluidBlocks.includes(p)){const t=this.blockColors[p];if(!t||!t.transparent){g=!0;break}}}if(!g)return!1}return!0},L=z.filter(t=>!$(t.x,t.y,t.z));L.sort((t,e)=>e.dist-t.dist),I.sort((t,e)=>e.dist-t.dist);const E=[...I,...L],F=this.debugSettings.renderAlgorithm;if("painter"===F)E.sort((t,e)=>{const i=e.dist-t.dist;return Math.abs(i)>.001?i:t.y!==e.y?t.y-e.y:t.z!==e.z?t.z-e.z:t.x!==e.x?t.x-e.x:t.type.localeCompare(e.type)});else if("zbuffer"===F)E.forEach(t=>{const{x:e,y:i,z:s}=t,l=[[e,i,s],[e+1,i,s],[e,i+1,s],[e+1,i+1,s],[e,i,s+1],[e+1,i,s+1],[e,i+1,s+1],[e+1,i+1,s+1]];let r=1/0;for(const[h,c,d]of l){const t=h-o,e=c-a,i=d-n,s=t*t+e*e+i*i;s<r&&(r=s)}t.minDist=r}),E.sort((t,e)=>{const i=(e.minDist||e.dist)-(t.minDist||t.dist);return Math.abs(i)>1e-4?i:t.y!==e.y?t.y-e.y:t.z!==e.z?t.z-e.z:t.x!==e.x?t.x-e.x:t.type.localeCompare(e.type)});else if("bsp"===F){const t=e=>{if(0===e.length)return null;if(1===e.length)return{block:e[0],front:null,back:null};const i=Math.min(...e.map(t=>t.x)),s=Math.max(...e.map(t=>t.x)),o=Math.min(...e.map(t=>t.y)),a=Math.max(...e.map(t=>t.y)),n=Math.min(...e.map(t=>t.z)),l=s-i,r=a-o,h=Math.max(...e.map(t=>t.z))-n;let c;c=l>=r&&l>=h?"x":r>=h?"y":"z",e.sort((t,e)=>t[c]-e[c]);const d=Math.floor(e.length/2),u=e[d],g=e.filter((t,e)=>e<d),f=e.filter((t,e)=>e>d);return{block:u,axis:c,value:u[c],front:t(g),back:t(f)}},e=(t,i)=>{if(!t)return;if(!t.axis)return void i.push(t.block);("x"===t.axis?o:"y"===t.axis?a:n)<t.value?(e(t.back,i),i.push(t.block),e(t.front,i)):(e(t.front,i),i.push(t.block),e(t.back,i))},i=t(E.slice()),s=[];e(i,s),E.length=0,E.push(...s)}for(let D=0;D<E.length;D++){const e=E[D],{x:i,y:s,z:l,type:r}=e,h=this.blockColors[r];if(!h)continue;t.lineWidth=0,t.strokeStyle="transparent";const c=this.fluidBlocks.includes(r),d=c?P(i,s,l):8,u=s+d/8,g=w(i,s+1,l),f=w(i,s-1,l),m=w(i,s,l+1),y=w(i,s,l-1),b=w(i-1,s,l),v=w(i+1,s,l);let x,k,M,S,I,z;const $=this.blockModels&&this.blockModels[r];if(this.debugSettings.disableFaceCulling)x=k=M=S=I=z=!0;else if($)x=k=M=S=I=z=!0;else if(c){x=!g||g!==r,k=!f||!this.fluidBlocks.includes(f);const t=d,e=m===r?P(i,s,l+1):0,o=y===r?P(i,s,l-1):0,a=b===r?P(i-1,s,l):0,n=v===r?P(i+1,s,l):0;M=!m||m!==r||e<t,S=!y||y!==r||o<t,I=!b||b!==r||a<t,z=!v||v!==r||n<t}else{const t=this.blockColors[r]&&this.blockColors[r].transparent,e=("leaves"===r||"appleLeaves"===r||"cherryLeaves"===r)&&("transparent"===this.settings.treeStyle||"bushy"===this.settings.treeStyle);if(t)x=!B(g),k=!B(f),M=!B(m),S=!B(y),I=!B(b),z=!B(v);else if(e){const t=t=>{if(!t)return!0;if("leaves"===t||"appleLeaves"===t||"cherryLeaves"===t)return!0;const e=this.blockColors[t];return!(!e||!e.transparent)||!!this.fluidBlocks.includes(t)};x=t(g),k=t(f),M=t(m),S=t(y),I=t(b),z=t(v)}else x=T(g),k=T(f),M=T(m),S=T(y),I=T(b),z=T(v)}if(!(x||k||M||S||I||z))continue;const L="leaves"===r||"appleLeaves"===r||"cherryLeaves"===r,F=this.settings.treeStyle,R=this.blockModels[r],A=R?R[0]:0,O=R?R[1]:0,H=R?R[2]:0,W=R?R[3]:1,N=R?R[4]:1,q=R?R[5]:1,Y=i+A,G=s+O,X=l+H,j=i+A+W,_=s+O+N,U=l+H+q,Z=[],K=h&&h.transparent,V=.95,J=K?V:.95,Q=K?V:.75,tt=1,et=K?V:.6,it=K?V:.85,st=K?V:.9,ot=h.side,at=h.top,nt=h.bottom;let lt=0,rt=0,ht=0;if(L&&"bushy"===F){const t=.001*Date.now(),e=.08*Math.sin(1.5*t+.3*i+.5*l),s=.05*Math.sin(2.3*t+.7*i-.2*l),o=.03*Math.cos(1.8*t-.4*i+.6*l);lt=e+s,rt=s+o,ht=.3*Math.abs(e)}const ct=(t,e,i)=>{if(!L||"bushy"!==F)return[t,e,i];return e>s+.5?[t+lt,e+ht,i+rt]:[t,e,i]},dt=R?_:u,ut=R?G:s;if(M){const t=[[Y,ut,U],[j,ut,U],[j,dt,U],[Y,dt,U]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:ot,dark:J,isTop:!1,isLeaf:L})}if(S){const t=[[j,ut,X],[Y,ut,X],[Y,dt,X],[j,dt,X]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:ot,dark:Q,isTop:!1,isLeaf:L})}if(x){const t=[[Y,dt,X],[j,dt,X],[j,dt,U],[Y,dt,U]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:at,dark:tt,isTop:!0,isLeaf:L})}if(k){const t=[[Y,ut,U],[j,ut,U],[j,ut,X],[Y,ut,X]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:nt,dark:et,isTop:!1,isLeaf:L})}if(I){const t=[[Y,ut,X],[Y,ut,U],[Y,dt,U],[Y,dt,X]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:ot,dark:it,isTop:!1,isLeaf:L})}if(z){const t=[[j,ut,U],[j,ut,X],[j,dt,X],[j,dt,U]].map(([t,e,i])=>ct(t,e,i));Z.push({v:t,color:ot,dark:st,isTop:!1,isLeaf:L})}const gt=Z.map(t=>{const e=(t.v[0][0]+t.v[1][0]+t.v[2][0]+t.v[3][0])/4,i=(t.v[0][1]+t.v[1][1]+t.v[2][1]+t.v[3][1])/4,s=(t.v[0][2]+t.v[1][2]+t.v[2][2]+t.v[3][2])/4,l=e-o,r=i-a,h=s-n;return{face:t,distSq:l*l+r*r+h*h}});gt.sort((t,e)=>e.distSq-t.distSq);for(let w=0;w<gt.length;w++){const{face:d}=gt[w],u=[];let g=0;for(let t=0;t<4;t++){const e=p(d.v[t][0],d.v[t][1],d.v[t][2]);u.push(e),e.clamped&&g++}if(g>=4)continue;const f=g>0;if(4!==u.length)continue;let m=d.color;if(this.settings.shadows&&d.dark<1&&(m=this.darkenColor(d.color,d.dark)),d.isLeaf&&("transparent"===this.settings.treeStyle||"bushy"===this.settings.treeStyle))if(m.startsWith("rgb("))m=m.replace("rgb(","rgba(").replace(")",", 0.75)");else if(m.startsWith("#")){const t=parseInt(m.slice(1,3),16),e=parseInt(m.slice(3,5),16),i=parseInt(m.slice(5,7),16);m=`rgba(${t}, ${e}, ${i}, 0.75)`}if(c&&h.animated)if("water"===r){const t=C,e=(.4*Math.sin(t+.7*i+.5*l)+.3*Math.sin(.8*t-.3*i+.7*l)+.2*Math.sin(1.3*t+.5*i-.3*l))/3+.5,r=i+.5-o,h=s+.5-a,c=l+.5-n,d=Math.sqrt(r*r+h*h+c*c),u=Math.abs(h/(d||1)),g=.02,f=g+(1-g)*Math.pow(1-u,5);let p=0;const y=this.camera.x-(i+.5),b=this.camera.z-(l+.5),v=Math.sqrt(y*y+b*b);if(v<5&&this.camera.y>s+1){p=(1-v/5)*f*.3}const x=[{r:255,g:183,b:197},{r:255,g:218,b:185},{r:135,g:206,b:235}][Math.min(2,Math.floor(3*(1-u)))],k=Math.min(1,d/20),M=30+15*k,S=80+20*k,w=160-30*k,T={r:100,g:60,b:40},B=Math.min(.7,1.5*f);let P=Math.floor(M*(1-B)+x.r*B),I=Math.floor(S*(1-B)+x.g*B),z=Math.floor(w*(1-B)+x.b*B);p>0&&(P=Math.floor(P*(1-p)+T.r*p),I=Math.floor(I*(1-p)+T.g*p),z=Math.floor(z*(1-p)+T.b*p));const $={x:.5,y:.8,z:.3},L={x:r/d,y:h/d,z:c/d},E={x:$.x+L.x,y:$.y+L.y,z:$.z+L.z},F=Math.sqrt(E.x*E.x+E.y*E.y+E.z*E.z),D=Math.max(0,E.y/F),R=Math.pow(D,32)*e*.6,A=.85+.15*e+R+.1*(Math.sin(2*t+1.5*i)*Math.cos(1.5*t+1.5*l)*Math.sin(1.7*t-1.2*i+.8*l)+1),O=.55,H=.35*f;m=`rgba(${Math.min(255,Math.floor(P*A+200*R))}, ${Math.min(255,Math.floor(I*A+180*R))}, ${Math.min(255,Math.floor(z*A+150*R))}, ${Math.min(.9,O+H)})`}else if("lava"===r){const t=1.5*C+.3*i+.3*l,e=.8+.2*Math.sin(t),s=Math.floor(255*e),o=Math.floor((80+30*Math.sin(2*t))*e),a=Math.floor(30*(1-.5*e));m=`rgb(${Math.min(255,s)}, ${Math.min(255,o)}, ${a})`}const y=d.isTop?"top":"side";if(h.useTexture&&h.texture&&!c){let i=m;if(this.settings.shadows&&d.dark<1)if(m.startsWith("#"))i=this.darkenColor(m,d.dark);else if(m.startsWith("rgb")){const t=m.match(/\d+/g);if(t){i=`rgb(${Math.floor(parseInt(t[0])*d.dark)},${Math.floor(parseInt(t[1])*d.dark)},${Math.floor(parseInt(t[2])*d.dark)})`}}if(this.debugSettings.wireframeOnly){t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=1.5,t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.closePath(),t.stroke();continue}if(d.isLeaf&&("transparent"===this.settings.treeStyle||"bushy"===this.settings.treeStyle))if(i.startsWith("rgb("))i=i.replace("rgb(","rgba(").replace(")",", 0.75)");else if(i.startsWith("#")){const t=parseInt(i.slice(1,3),16),e=parseInt(i.slice(3,5),16),s=parseInt(i.slice(5,7),16);i=`rgba(${t}, ${e}, ${s}, 0.75)`}t.fillStyle=i,t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.fill();const s=this.generateTexture(h.texture,i,y);t.save(),t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.closePath(),t.clip();const o=Math.min(u[0].x,u[1].x,u[2].x,u[3].x),a=Math.max(u[0].x,u[1].x,u[2].x,u[3].x),n=Math.min(u[0].y,u[1].y,u[2].y,u[3].y),l=Math.max(u[0].y,u[1].y,u[2].y,u[3].y);if(t.globalCompositeOperation="overlay",t.globalAlpha=.4,"fixed"===this.settings.textureMode){t.save(),t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.closePath(),t.clip();const i=s;if(i&&i.setTransform){const t=32,s=e.x*t*.5%t,o=(e.y+e.z)*t*.5%t,a=new DOMMatrix;a.translateSelf(s,o),i.setTransform(a)}t.fillStyle=s,t.fillRect(o-5,n-5,a-o+10,l-n+10),t.restore()}else if("vacuum"===this.settings.textureMode){const e=(u[0].x+u[1].x+u[2].x+u[3].x)/4,i=(u[0].y+u[1].y+u[2].y+u[3].y)/4;t.save();const r=s;if(r&&r.setTransform){const t=new DOMMatrix;t.translateSelf(e,i),r.setTransform(t)}t.fillStyle=s,t.fillRect(o-5,n-5,a-o+10,l-n+10),t.restore()}else t.fillStyle=s,t.fillRect(o-5,n-5,a-o+10,l-n+10);t.restore()}else t.fillStyle=m,t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.fill();this.debugSettings.showNearPlaneClipping&&f&&(t.strokeStyle="#ff0000",t.lineWidth=3,t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.closePath(),t.stroke()),this.debugSettings.showBlockModels&&this.blockModels[r]&&(t.strokeStyle="#00ffff",t.lineWidth=2,t.setLineDash([4,4]),t.beginPath(),t.moveTo(u[0].x,u[0].y),t.lineTo(u[1].x,u[1].y),t.lineTo(u[2].x,u[2].y),t.lineTo(u[3].x,u[3].y),t.closePath(),t.stroke(),t.setLineDash([]))}}if(this.debugSettings.showRaycastVector){const e=this.raycast();if(e){const i=p(o,a,n),s=p(e.hit.x+.5,e.hit.y+.5,e.hit.z+.5);i&&s&&(t.strokeStyle="rgba(255, 0, 0, 0.8)",t.lineWidth=3,t.setLineDash([5,5]),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke(),t.setLineDash([]),t.fillStyle="rgba(255, 0, 0, 0.9)",t.beginPath(),t.arc(s.x,s.y,5,0,2*Math.PI),t.fill())}}if(this.debugSettings.showProjectionTest){const e=d,i=u;t.strokeStyle="rgba(0, 255, 0, 1)",t.lineWidth=3,t.beginPath(),t.moveTo(e-20,i),t.lineTo(e+20,i),t.moveTo(e,i-20),t.lineTo(e,i+20),t.stroke(),t.fillStyle="rgba(0, 255, 0, 1)",t.beginPath(),t.arc(e,i,5,0,2*Math.PI),t.fill(),t.fillStyle="rgba(0, 255, 0, 1)",t.strokeStyle="rgba(0, 0, 0, 0.8)",t.font="bold 14px monospace",t.lineWidth=3,t.strokeText("SCREEN CENTER",e+25,i-15),t.fillText("SCREEN CENTER",e+25,i-15)}if(this.debugSettings.showDepthOrder){t.fillStyle="rgba(255, 255, 255, 0.9)",t.strokeStyle="rgba(0, 0, 0, 0.9)",t.font="bold 14px monospace",t.lineWidth=3;for(let e=0;e<Math.min(E.length,50);e++){const i=E[e],s=p(i.x+.5,i.y+.5,i.z+.5);if(s){const i=`#${e}`;t.strokeText(i,s.x-15,s.y+5),t.fillText(i,s.x-15,s.y+5)}}}if(this.debugSettings.showFaceNormals){t.strokeStyle="rgba(255, 255, 0, 0.8)",t.lineWidth=2;for(let e=0;e<Math.min(E.length,20);e++){const i=E[e],{x:s,y:o,z:a}=i,n=[{center:[s+.5,o+1,a+.5],dir:[0,1,0],name:"Top"},{center:[s+.5,o,a+.5],dir:[0,-1,0],name:"Bottom"},{center:[s+.5,o+.5,a+1],dir:[0,0,1],name:"Front"},{center:[s+.5,o+.5,a],dir:[0,0,-1],name:"Back"},{center:[s,o+.5,a+.5],dir:[-1,0,0],name:"Left"},{center:[s+1,o+.5,a+.5],dir:[1,0,0],name:"Right"}];for(const e of n){const i=p(e.center[0],e.center[1],e.center[2]),s=p(e.center[0]+.5*e.dir[0],e.center[1]+.5*e.dir[1],e.center[2]+.5*e.dir[2]);if(i&&s){t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke();const e=Math.atan2(s.y-i.y,s.x-i.x);t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(s.x-8*Math.cos(e-Math.PI/6),s.y-8*Math.sin(e-Math.PI/6)),t.lineTo(s.x-8*Math.cos(e+Math.PI/6),s.y-8*Math.sin(e+Math.PI/6)),t.lineTo(s.x,s.y),t.fill()}}}}if(this.debugSettings.showBoundingBoxes){t.strokeStyle="rgba(0, 255, 255, 0.6)",t.lineWidth=1;for(let e=0;e<Math.min(E.length,30);e++){const i=E[e],{x:s,y:o,z:a}=i,n=[[s,o,a],[s+1,o,a],[s+1,o+1,a],[s,o+1,a],[s,o,a+1],[s+1,o,a+1],[s+1,o+1,a+1],[s,o+1,a+1]].map(t=>p(t[0],t[1],t[2])).filter(t=>null!==t);if(8===n.length){const e=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];t.beginPath();for(const[i,s]of e)t.moveTo(n[i].x,n[i].y),t.lineTo(n[s].x,n[s].y);t.stroke()}}}if(this.debugSettings.showOverdraw){t.fillStyle="rgba(255, 255, 255, 0.9)",t.strokeStyle="rgba(0, 0, 0, 0.9)",t.font="bold 16px monospace",t.lineWidth=3;const e=`OVERDRAW: ${E.length} blocks rendered`;t.strokeText(e,10,100),t.fillText(e,10,100)}if(this.debugSettings.showTargetInfo){const e=this.raycast(),i=10;let s=130;const l=18;if(t.font="bold 14px monospace",t.lineWidth=3,t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(5,115,650,e?850:60),t.fillStyle="#ff69b4",t.fillText("=== TARGET DIAGNOSTIC ===",i,s),s+=l+5,e&&e.hit){const r=e.hit.x,h=e.hit.y,c=e.hit.z,g=`${r},${h},${c}`,f=this.world[g];t.fillStyle="#fff",t.fillText(`Camera: (${o.toFixed(1)}, ${a.toFixed(1)}, ${n.toFixed(1)})`,i,s),s+=l;const y=Math.floor(o),b=Math.floor(a),v=Math.floor(n),x=this.world[`${y},${b},${v}`];if(t.fillStyle=x?"#f55":"#0f0",t.fillText(`Start Voxel: (${y}, ${b}, ${v}) = ${x||"air"}`,i,s),s+=l,t.fillStyle="#0ff",t.fillText(`Raycast Hit: (${r}, ${h}, ${c})${e.hitT?` at t=${e.hitT.toFixed(2)}`:""}`,i,s),s+=l,t.fillStyle="#ff0",t.fillText(`Raycast Block: "${e.block||"null"}"`,i,s),s+=l,t.fillStyle="#f0f",t.fillText("=== PLACEMENT INFO ===",i,s),s+=l,e.place){t.fillStyle="#0ff",t.fillText(`Place Position: (${e.place.x}, ${e.place.y}, ${e.place.z})`,i,s),s+=l;const o=e.place.x-r,a=e.place.y-h,n=e.place.z-c;let d="Unknown";1===o?d="+X (Right)":-1===o?d="-X (Left)":1===a?d="+Y (Top)":-1===a?d="-Y (Bottom)":1===n?d="+Z (Front)":-1===n&&(d="-Z (Back)"),t.fillStyle="#ff0",t.fillText(`Entry Face: ${d} (diff: ${o},${a},${n})`,i,s),s+=l,e.enteredFace&&(t.fillStyle="#aaa",t.fillText(`enteredFace: (${e.enteredFace.x}, ${e.enteredFace.y}, ${e.enteredFace.z})`,i,s),s+=l),e.lastSolidFace&&(t.fillText(`lastSolidFace: (${e.lastSolidFace.x}, ${e.lastSolidFace.y}, ${e.lastSolidFace.z})`,i,s),s+=l),e.rawEnteredFace&&(t.fillText(`rawEnteredFace: (${e.rawEnteredFace.x}, ${e.rawEnteredFace.y}, ${e.rawEnteredFace.z})`,i,s),s+=l),e.debugTMax&&(t.fillText(`tMax at hit: X=${e.debugTMax.x.toFixed(2)} Y=${e.debugTMax.y.toFixed(2)} Z=${e.debugTMax.z.toFixed(2)}`,i,s),s+=l),e.debugStep&&(t.fillText(`Step dirs: X=${e.debugStep.x} Y=${e.debugStep.y} Z=${e.debugStep.z}`,i,s),s+=l);const u=[[e.place.x,e.place.y,e.place.z],[e.place.x+1,e.place.y,e.place.z],[e.place.x+1,e.place.y+1,e.place.z],[e.place.x,e.place.y+1,e.place.z],[e.place.x,e.place.y,e.place.z+1],[e.place.x+1,e.place.y,e.place.z+1],[e.place.x+1,e.place.y+1,e.place.z+1],[e.place.x,e.place.y+1,e.place.z+1]].map(t=>p(t[0],t[1],t[2]));if(u.every(t=>null!==t)){t.strokeStyle="rgba(0, 255, 0, 0.8)",t.lineWidth=2,t.setLineDash([5,5]);const i=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];t.beginPath();for(const[e,o]of i)t.moveTo(u[e].x,u[e].y),t.lineTo(u[o].x,u[o].y);t.stroke(),t.setLineDash([]);const s=p(e.place.x+.5,e.place.y+.5,e.place.z+.5);s&&(t.fillStyle="#0f0",t.font="bold 12px monospace",t.fillText("PLACE",s.x+15,s.y),t.font="bold 14px monospace")}}else t.fillStyle="#f55",t.fillText("Place Position: null (no entry face)",i,s),s+=l;t.fillStyle="#f0f",t.fillText("======================",i,s),s+=l,t.fillStyle=f?"#0f0":"#f55",t.fillText(`World Data: "${f||"EMPTY"}"`,i,s),s+=l;const k=E.some(t=>t.x===r&&t.y===h&&t.z===c);t.fillStyle=k?"#0f0":"#f55",t.fillText("In Render List: "+(k?"YES":"NO"),i,s),s+=l;const M=r+.5-o,S=h+.5-a,T=c+.5-n,B=Math.sqrt(M*M+S*S+T*T),P=Math.sqrt(m);t.fillStyle=B<=P?"#0f0":"#f55",t.fillText(`Distance: ${B.toFixed(1)} (max: ${P.toFixed(0)})`,i,s),s+=l;const C=M*-Math.sin(this.camera.rotY)+T*Math.cos(this.camera.rotY)<-3&&B*B>16;if(t.fillStyle=C?"#f55":"#0f0",t.fillText("Frustum: "+(C?"CULLED (behind cam)":"VISIBLE"),i,s),s+=l,f){const g=w(r,h+1,c),m=w(r,h-1,c),y=w(r,h,c+1),b=w(r,h,c-1),v=w(r-1,h,c),x=w(r+1,h,c),k=this.blockColors[f]&&this.blockColors[f].transparent;let M,S,T,B,P,C;if(this.fluidBlocks.includes(f))M=!g||g!==f,S=!m||!this.fluidBlocks.includes(m),T=!y||y!==f,B=!b||b!==f,P=!v||v!==f,C=!x||x!==f;else if(k)M=g!==f,S=m!==f,T=y!==f,B=b!==f,P=v!==f,C=x!==f;else{const t=t=>{if(!t)return!0;if(this.fluidBlocks.includes(t))return!0;const e=this.blockColors[t];return e&&e.transparent};M=t(g),S=t(m),T=t(y),B=t(b),P=t(v),C=t(x)}const I=[M,S,T,B,P,C].filter(Boolean).length;t.fillStyle=I>0?"#0f0":"#f55",t.fillText(`Visible Faces: ${I}/6`,i,s),s+=l;const z=[M?"T":"-",S?"B":"-",T?"F":"-",B?"K":"-",P?"L":"-",C?"R":"-"].join(" ");t.fillStyle="#888",t.fillText(`Faces [T B F K L R]: ${z}`,i,s),s+=l,t.font="12px monospace",t.fillText(`Adj: T:${g||"air"} B:${m||"air"} F:${y||"air"}`,i,s),s+=14,t.fillText(`     K:${b||"air"} L:${v||"air"} R:${x||"air"}`,i,s),s+=l,t.font="bold 14px monospace",0===I&&(t.fillStyle="#f00",t.fillText("‚ö† ALL FACES CULLED - block invisible!",i,s),s+=l);const $=p(r+.5,h+.5,c+.5);$?(t.strokeStyle="#0ff",t.lineWidth=3,t.beginPath(),t.arc($.x,$.y,15,0,2*Math.PI),t.stroke(),t.beginPath(),t.moveTo($.x-20,$.y),t.lineTo($.x+20,$.y),t.moveTo($.x,$.y-20),t.lineTo($.x,$.y+20),t.stroke(),t.fillStyle="#0ff",t.font="bold 12px monospace",t.fillText("PROJECTED",$.x+20,$.y-5),t.fillText(`Z=${$.z.toFixed(2)}`,$.x+20,$.y+10),t.font="bold 14px monospace",t.fillStyle="#0ff",t.fillText(`Proj Center: (${$.x.toFixed(0)}, ${$.y.toFixed(0)}) z=${$.z.toFixed(2)}`,i,s),s+=l):(t.fillStyle="#f55",t.fillText("‚ö† Block center fails projection (z <= 0.1)!",i,s),s+=l);const L=[[r,h,c],[r+1,h,c],[r,h+1,c],[r,h,c+1],[r+1,h+1,c],[r+1,h,c+1],[r,h+1,c+1],[r+1,h+1,c+1]].map(t=>p(t[0],t[1],t[2])).filter(t=>null!==t).length;t.fillStyle=8===L?"#0f0":L>0?"#ff0":"#f55",t.fillText(`Projected Corners: ${L}/8`,i,s),s+=l;const E=-this.camera.rotX,F=-this.camera.rotY,D=Math.cos(E),R=Math.sin(E),A=Math.cos(F),O=Math.sin(F)*D,H=R,W=A*D,N=p(o+3*O,a+3*H,n+3*W);if(N){t.strokeStyle="#0f0",t.lineWidth=3,t.beginPath(),t.moveTo(N.x-15,N.y-15),t.lineTo(N.x+15,N.y+15),t.moveTo(N.x+15,N.y-15),t.lineTo(N.x-15,N.y+15),t.stroke(),t.fillStyle="#0f0",t.font="bold 12px monospace",t.fillText("RAY DIR",N.x+20,N.y),t.font="bold 14px monospace";const g=d,f=u,m=N.x-g,y=N.y-f;t.fillStyle=Math.abs(m)<10&&Math.abs(y)<10?"#0f0":"#f55",t.fillText(`Ray‚ÜíScreen offset: (${m.toFixed(0)}, ${y.toFixed(0)})`,i,s),s+=l;const b=p(r+.5,h+.5,c+.5);if(b){t.strokeStyle="#ff0",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(d,u),t.lineTo(b.x,b.y),t.stroke(),t.setLineDash([]);const g=b.x-d,f=b.y-u,m=Math.sqrt(g*g+f*f);if(t.fillStyle=m<50?"#0f0":"#f55",t.fillText(`Hit deviation: ${m.toFixed(0)}px from center`,i,s),s+=l,m>50){t.fillStyle="#f00",t.fillText("‚ö† DDA BUG: Hit block not on ray path!",i,s),s+=l,t.fillStyle="#ff0",t.font="12px monospace",t.fillText(`Ray dir: (${O.toFixed(4)}, ${H.toFixed(4)}, ${W.toFixed(4)})`,i,s),s+=14;const d=Math.sqrt((r+.5-o)**2+(h+.5-a)**2+(c+.5-n)**2),u=o+O*d,g=a+H*d,f=n+W*d;t.fillText(`Expected at dist ${d.toFixed(1)}: (${u.toFixed(1)}, ${g.toFixed(1)}, ${f.toFixed(1)})`,i,s),s+=14;const m=Math.floor(u),p=Math.floor(g),y=Math.floor(f),b=this.world[`${m},${p},${y}`]||"air";t.fillText(`Expected voxel [${m},${p},${y}] = ${b}`,i,s),s+=14,t.fillText(`Actual hit: (${r+.5}, ${h+.5}, ${c+.5})`,i,s),s+=14;const v=r+.5-o,x=h+.5-a,k=c+.5-n,M=Math.sqrt(v*v+x*x+k*k),S=O*(v/M)+H*(x/M)+W*(k/M),w=180*Math.acos(Math.min(1,Math.max(-1,S)))/Math.PI;if(t.fillStyle="#f55",t.fillText(`Angular error: ${w.toFixed(1)}¬∞ off ray direction`,i,s),s+=l,t.font="bold 14px monospace",t.fillStyle="#aaa",t.font="11px monospace",e.debugSteps&&e.debugSteps.length>0){t.fillStyle="#0ff",t.fillText("ACTUAL RAYCAST STEPS:",i,s),s+=14,t.fillStyle="#aaa";for(let o=0;o<Math.min(e.debugSteps.length,8);o++){const a=e.debugSteps[o];t.fillText(`t=${a.t.toFixed(1)}: (${a.px.toFixed(1)},${a.py.toFixed(1)},${a.pz.toFixed(1)}) ‚Üí [${a.voxelX},${a.voxelY},${a.voxelZ}] = ${a.block}`,i,s),s+=12}if(e.debugDir&&(t.fillStyle="#f0f",t.fillText(`ACTUAL dir: (${e.debugDir.x.toFixed(4)}, ${e.debugDir.y.toFixed(4)}, ${e.debugDir.z.toFixed(4)})`,i,s),s+=14),e.debugOrigin){t.fillStyle="#f0f",t.fillText(`ACTUAL origin: (${e.debugOrigin.x.toFixed(2)}, ${e.debugOrigin.y.toFixed(2)}, ${e.debugOrigin.z.toFixed(2)})`,i,s),s+=14;const l=Math.abs(e.debugOrigin.x-o),r=Math.abs(e.debugOrigin.y-a),h=Math.abs(e.debugOrigin.z-n);(l>.01||r>.01||h>.01)&&(t.fillStyle="#f00",t.fillText(`‚ö† ORIGIN MISMATCH! Diff: (${l.toFixed(2)}, ${r.toFixed(2)}, ${h.toFixed(2)})`,i,s),s+=14)}}else{const e=5;for(let l=1;l<=e;l++){const e=.8*l,r=o+O*e,h=a+H*e,c=n+W*e,d=Math.floor(r),u=Math.floor(h),g=Math.floor(c),f=this.world[`${d},${u},${g}`]||"air";t.fillText(`t=${e.toFixed(1)}: (${r.toFixed(1)},${h.toFixed(1)},${c.toFixed(1)}) ‚Üí [${d},${u},${g}] = ${f}`,i,s),s+=12}}t.font="bold 14px monospace"}}}}if(e.block&&!f?(t.fillStyle="#f00",t.fillText("‚ö† GHOST BLOCK: raycast sees block not in world!",i,s),s+=l):!k&&f&&(t.fillStyle="#ff0",t.fillText("‚ö† CULLED: block exists but not rendering",i,s),s+=l),f){const e=this.blockColors[f];e&&e.transparent&&(t.fillStyle="#ff0",t.fillText(`Note: "${f}" is transparent`,i,s))}}else t.fillStyle="#888",t.fillText("No raycast hit (air or out of range)",i,s)}if(this.debugSettings.showTreeDiag){const e=E.filter(t=>"leaves"===t.type||"sakura_leaves"===t.type||"cherry_leaves"===t.type||t.type.includes("leaf")),i={};e.forEach((t,e)=>{const s=Math.floor(100*t.dist)/100;i[s]||(i[s]=[]),i[s].push({block:t,idx:e})});const s=Object.entries(i).filter(([t,e])=>e.length>1);e.forEach((e,s)=>{const o=p(e.x+.5,e.y+.5,e.z+.5);if(!o)return;const a=Math.floor(100*e.dist)/100,n=i[a]&&i[a].length>1;n&&(t.strokeStyle="rgba(255, 0, 0, 0.9)",t.lineWidth=3,t.setLineDash([4,4]),t.strokeRect(o.x-15,o.y-15,30,30),t.setLineDash([])),t.fillStyle=n?"#f00":"#0f0",t.font="bold 10px monospace",t.fillText(`${s}`,o.x-5,o.y+3)}),t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(this.canvas.width-260,80,250,140),t.fillStyle="#ff69b4",t.font="bold 14px monospace",t.fillText("üå≥ TREE DIAGNOSTIC",this.canvas.width-250,100),t.fillStyle="#fff",t.font="12px monospace",t.fillText(`Foliage blocks: ${e.length}`,this.canvas.width-250,120),t.fillText(`Z-fighting groups: ${s.length}`,this.canvas.width-250,135),s.length>0?(t.fillStyle="#f55",t.fillText(`‚ö† ${s.reduce((t,[e,i])=>t+i.length,0)} blocks at risk`,this.canvas.width-250,150),t.fillStyle="#888",t.fillText("Red boxes = same distance",this.canvas.width-250,165)):(t.fillStyle="#0f0",t.fillText("‚úì No Z-fighting detected",this.canvas.width-250,150)),t.fillStyle="#888",t.fillText(`Algo: ${this.debugSettings.renderAlgorithm}`,this.canvas.width-250,180),t.fillText("Numbers = render order",this.canvas.width-250,195)}if(this.debugSettings.showDistanceHeatmap){const e=Math.max(...E.map(t=>t.dist),1),i=Math.min(...E.map(t=>t.dist),0);E.forEach((s,o)=>{const a=p(s.x+.5,s.y+.5,s.z+.5);if(!a)return;const n=(s.dist-i)/(e-i),l=Math.floor(255*(1-n)),r=Math.floor(255*n),h=Math.floor(100*(1-2*Math.abs(n-.5)));t.fillStyle=`rgba(${l}, ${h}, ${r}, 0.5)`,t.fillRect(a.x-8,a.y-8,16,16)}),t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(this.canvas.width-150,80,140,60),t.font="bold 12px monospace",t.fillStyle="#f00",t.fillText("‚ñ† Close",this.canvas.width-140,100),t.fillStyle="#00f",t.fillText("‚ñ† Far",this.canvas.width-140,120),t.fillStyle="#888",t.fillText(`Range: ${i.toFixed(1)}-${e.toFixed(1)}`,this.canvas.width-140,135)}if(this.debugSettings.highlightBlockType){const e=this.debugSettings.highlightBlockType,i=E.filter(t=>t.type.toLowerCase().includes(e.toLowerCase()));i.forEach(e=>{const i=p(e.x+.5,e.y+.5,e.z+.5);i&&(t.strokeStyle="#ff0",t.lineWidth=2,t.strokeRect(i.x-12,i.y-12,24,24))}),t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(10,this.canvas.height-60,200,50),t.fillStyle="#ff0",t.font="bold 12px monospace",t.fillText(`Highlighting: ${e}`,20,this.canvas.height-40),t.fillStyle="#fff",t.fillText(`Found: ${i.length} blocks`,20,this.canvas.height-22)}if(this.debugSettings.showRenderStats){const e={};E.forEach(t=>{e[t.type]=(e[t.type]||0)+1});const i=Object.entries(e).sort((t,e)=>e[1]-t[1]).slice(0,10),s=E.reduce((t,e)=>t+e.dist,0)/E.length||0,o=Math.min(...E.map(t=>t.dist)),a=Math.max(...E.map(t=>t.dist)),n=180+15*i.length;t.fillStyle="rgba(0, 0, 0, 0.9)",t.fillRect(this.canvas.width-220,80,210,n);let l=100;t.fillStyle="#ff69b4",t.font="bold 14px monospace",t.fillText("üìä RENDER STATS",this.canvas.width-210,l),l+=20,t.fillStyle="#fff",t.font="11px monospace",t.fillText(`Total Blocks: ${E.length}`,this.canvas.width-210,l),l+=15,t.fillText(`Algorithm: ${this.debugSettings.renderAlgorithm}`,this.canvas.width-210,l),l+=15,t.fillText(`Dist Range: ${o.toFixed(1)} - ${a.toFixed(1)}`,this.canvas.width-210,l),l+=15,t.fillText(`Avg Dist: ${s.toFixed(1)}`,this.canvas.width-210,l),l+=20,t.fillStyle="#888",t.fillText("Top Block Types:",this.canvas.width-210,l),l+=15,i.forEach(([e,i])=>{const s=(i/E.length*100).toFixed(0);t.fillStyle=e.includes("leaves")?"#f55":"#0f0",t.fillText(`  ${e}: ${i} (${s}%)`,this.canvas.width-210,l),l+=15});const r=E.filter(t=>t.type.includes("leaves")||t.type.includes("leaf")).length;l+=10,t.fillStyle=r>50?"#f55":"#0f0",t.fillText(`Foliage: ${r} (${(r/E.length*100).toFixed(0)}%)`,this.canvas.width-210,l)}if(this.debugSettings.showCameraAngle){t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,100,280,150),t.strokeStyle="#0ff",t.lineWidth=2,t.strokeRect(10,100,280,150),t.font="bold 14px monospace",t.fillStyle="#0ff",t.fillText("CAMERA ANGLES",20,120),t.font="12px monospace",t.fillStyle="#fff";const e=(180*this.camera.rotX/Math.PI).toFixed(2),i=(180*this.camera.rotY/Math.PI).toFixed(2);t.fillText(`Pitch (rotX): ${e}¬∞ (${this.camera.rotX.toFixed(4)} rad)`,20,140),t.fillText(`Yaw (rotY): ${i}¬∞ (${this.camera.rotY.toFixed(4)} rad)`,20,158);const s=-Math.sin(this.camera.rotY)*Math.cos(this.camera.rotX),o=Math.sin(this.camera.rotX),a=Math.cos(this.camera.rotY)*Math.cos(this.camera.rotX);t.fillText(`Look Dir: (${s.toFixed(3)}, ${o.toFixed(3)}, ${a.toFixed(3)})`,20,176);const n=Math.cos(this.camera.rotX),l=Math.sin(this.camera.rotX),r=Math.cos(this.camera.rotY),h=Math.sin(this.camera.rotY);t.fillText(`cos(X): ${n.toFixed(4)}, sin(X): ${l.toFixed(4)}`,20,194),t.fillText(`cos(Y): ${r.toFixed(4)}, sin(Y): ${h.toFixed(4)}`,20,212);const c=this.camera.rotX>.5,d=this.camera.rotX<-.5;t.fillStyle=c||d?"#ff0":"#0f0",t.fillText("Direction: "+(c?"‚¨ÜÔ∏è UP":d?"‚¨áÔ∏è DOWN":"‚û°Ô∏è LEVEL"),20,230)}if(this.debugSettings.showSwimDebug){t.fillStyle="rgba(0, 0, 80, 0.92)",t.fillRect(10,260,340,260),t.strokeStyle="#0af",t.lineWidth=2,t.strokeRect(10,260,340,260),t.font="bold 14px monospace",t.fillStyle="#0af",t.fillText("üèä SWIM DEBUG",20,280);const e=this.swimDebugInfo;if(e){t.font="10px monospace";const i=(e,i,s)=>{t.fillStyle="water"===i?"#0ff":"lava"===i?"#f80":"#666",t.fillText(`${e}: ${i}`,20,s)};i("Head",e.headBlock,298),i("Waist",e.waistBlock,312),i("Feet",e.feetBlock,326),i("Below",e.belowFeetBlock,340),t.fillStyle="#fff",t.fillText(`feetInWater: ${e.feetInWater}`,150,312),t.fillText(`waistInWater: ${e.waistInWater}`,150,326),t.fillText(`headInWater: ${e.headInWater}`,150,340),t.font="bold 11px monospace",t.fillStyle=e.swimming?"#0f0":"#f00",t.fillText(`swimming: ${e.swimming}`,20,358),t.fillStyle=e.submerged?"#08f":"#666",t.fillText(`submerged: ${e.submerged}`,150,358),t.fillStyle=e.stableAtSurface?"#ff0":"#666",t.fillText(`stableAtSurface: ${e.stableAtSurface}`,20,374),t.fillStyle=e.atFluidSurface?"#0ff":"#666",t.fillText(`atFluidSurface: ${e.atFluidSurface}`,180,374),t.font="bold 14px monospace";const s={FLOAT:"#0ff",SINK:"#f55",SWIM_UP:"#0f0",DIVE:"#f80",JUMP:"#ff0",GRAVITY:"#888",none:"#444"};t.fillStyle=s[e.physicsBranch]||"#fff",t.fillText(`BRANCH: ${e.physicsBranch}`,20,398),t.font="11px monospace",t.fillStyle=e.velocityY>.001?"#0f0":e.velocityY<-.001?"#f55":"#ff0",t.fillText(`velocityY: ${e.velocityY.toFixed(5)} ${e.velocityY>0?"‚Üë":e.velocityY<0?"‚Üì":"‚Äî"}`,20,418),t.fillStyle="#aaa",t.fillText(`feetY: ${e.playerFeetY.toFixed(3)}`,180,418);const o=this.getGroundHeightBelow(this.camera.x,this.camera.z,this.camera.y);t.fillStyle="#888",t.fillText(`ground: Y=${o}`,20,436),t.fillStyle=this.keys[" "]?"#0f0":"#444",t.fillText("[SPACE]",20,456),t.fillStyle=this.keys.shift?"#f80":"#444",t.fillText("[SHIFT]",90,456),t.fillStyle="#888",t.font="9px monospace",t.fillText("Float requires: waistInWater && !headInWater && velY>-0.02",20,476),t.fillText(`Current velY check: ${this.velocity.y>-.02?"PASS":"FAIL"} (${this.velocity.y.toFixed(3)} > -0.02)`,20,490),t.font="bold 10px monospace",e.swimming?"FLOAT"===e.physicsBranch?(t.fillStyle="#0ff",t.fillText("‚ö†Ô∏è FLOATING - this prevents sinking!",20,508)):"SINK"===e.physicsBranch&&(t.fillStyle="#0f0",t.fillText("‚úì Sinking correctly",20,508)):(t.fillStyle="#888",t.fillText("Not in water",20,508))}else t.fillStyle="#f00",t.fillText("No swim debug info (not in update loop)",20,300)}if(this.worldBounds){const e=this.worldBounds,i=.003*Date.now(),s=5,l=[{axis:"x",value:e.minX,dir:1},{axis:"x",value:e.maxX,dir:-1},{axis:"z",value:e.minZ,dir:1},{axis:"z",value:e.maxZ,dir:-1}];for(const h of l){let l;if(l="x"===h.axis?Math.abs(o-h.value):Math.abs(n-h.value),l>1.5*f)continue;for(let r=Math.max(e.minY,a-10);r<e.maxY;r+=s){const l="x"===h.axis?e.minZ:e.minX,c="x"===h.axis?e.maxZ:e.maxX;for(let d=l;d<c;d+=s){let l,u;"x"===h.axis?(l=h.value,u=d+s/2):(l=d+s/2,u=h.value);if(Math.sqrt((l-o)**2+(u-n)**2)>f)continue;let g;const m=Math.min(r+s,e.maxY),y=Math.min(d+s,c);g="x"===h.axis?[[h.value,r,d],[h.value,r,y],[h.value,m,y],[h.value,m,d]]:[[d,r,h.value],[y,r,h.value],[y,m,h.value],[d,m,h.value]];const b=[];let v=!0;for(const t of g){const e=p(t[0],t[1],t[2]);if(!e){v=!1;break}b.push(e)}if(!v||b.length<4)continue;const x=(g[0][0]+g[2][0])/2,k=(g[0][1]+g[2][1])/2,M=(g[0][2]+g[2][2])/2,S=x-o,w=k-a,T=M-n,B=Math.sqrt(S*S+w*w+T*T);let P=!1;const C=Math.max(8,Math.floor(B/2));for(let t=1;t<C;t++){const e=t/C,i=Math.floor(o+S*e),s=Math.floor(a+w*e),l=Math.floor(n+T*e),r=this.world[`${i},${s},${l}`];if(r&&!this.fluidBlocks.includes(r)){const t=this.blockColors[r];if(!t||!t.transparent){P=!0;break}}}if(P)continue;const I=(.2*(d+r)+i)%(2*Math.PI),z=.15+.1*Math.sin(I);t.fillStyle=`hsla(${180+20*Math.sin(i+.1*d)}, 100%, 60%, ${z})`,t.beginPath(),t.moveTo(b[0].x,b[0].y),t.lineTo(b[1].x,b[1].y),t.lineTo(b[2].x,b[2].y),t.lineTo(b[3].x,b[3].y),t.closePath(),t.fill(),t.strokeStyle=`hsla(180, 100%, 70%, ${2*z})`,t.lineWidth=1,t.stroke()}}}const r=e.minY;if(a>r+3)for(let h=e.minX;h<e.maxX;h+=s)for(let l=e.minZ;l<e.maxZ;l+=s){if(Math.sqrt((h+s/2-o)**2+(l+s/2-n)**2)>f)continue;const c=Math.min(h+s,e.maxX),d=Math.min(l+s,e.maxZ),u=[[h,r,l],[c,r,l],[c,r,d],[h,r,d]],g=[];let m=!0;for(const t of u){const e=p(t[0],t[1],t[2]);if(!e){m=!1;break}g.push(e)}if(!m||g.length<4)continue;const y=h+s/2-o,b=r-a,v=l+s/2-n,x=Math.sqrt(y*y+b*b+v*v);let k=!1;const M=Math.max(8,Math.floor(x/2));for(let t=1;t<M;t++){const e=t/M,i=Math.floor(o+y*e),s=Math.floor(a+b*e),l=Math.floor(n+v*e),r=this.world[`${i},${s},${l}`];if(r&&!this.fluidBlocks.includes(r)){const t=this.blockColors[r];if(!t||!t.transparent){k=!0;break}}}if(k)continue;const S=(.2*(h+l)+i)%(2*Math.PI),w=.1+.08*Math.sin(S);t.fillStyle=`hsla(${280+20*Math.sin(i+.1*h)}, 100%, 50%, ${w})`,t.beginPath(),t.moveTo(g[0].x,g[0].y),t.lineTo(g[1].x,g[1].y),t.lineTo(g[2].x,g[2].y),t.lineTo(g[3].x,g[3].y),t.closePath(),t.fill(),t.strokeStyle=`hsla(280, 100%, 60%, ${2*w})`,t.lineWidth=1,t.stroke()}}for(const D of this.birds){const e=D.x-o,i=D.y-a,s=D.z-n;if(e*b+s*v<0)continue;if(e*e+i*i+s*s>m)continue;const l=p(D.x,D.y,D.z);if(!l)continue;const r=D.size*g/l.z;if(r<2)continue;const h=.5*Math.sin(D.wingPhase);D.angle,Math.PI,t.fillStyle="#d85a8a",t.beginPath(),t.ellipse(l.x,l.y,.8*r,.4*r,0,0,2*Math.PI),t.fill(),t.fillStyle="#ff9ec4";const c=1.5*r,d=.6*r*(1+h);t.beginPath(),t.moveTo(l.x,l.y),t.quadraticCurveTo(l.x-.5*c,l.y-d,l.x-c,l.y+.2*r),t.quadraticCurveTo(l.x-.5*c,l.y+.1*r,l.x,l.y),t.fill(),t.beginPath(),t.moveTo(l.x,l.y),t.quadraticCurveTo(l.x+.5*c,l.y-d,l.x+c,l.y+.2*r),t.quadraticCurveTo(l.x+.5*c,l.y+.1*r,l.x,l.y),t.fill(),t.fillStyle="#d85a8a",t.beginPath(),t.arc(l.x+.6*r,l.y-.1*r,.3*r,0,2*Math.PI),t.fill(),t.fillStyle="#ffaa00",t.beginPath(),t.moveTo(l.x+.9*r,l.y-.1*r),t.lineTo(l.x+1.2*r,l.y),t.lineTo(l.x+.9*r,l.y+.1*r),t.fill()}for(const D of this.pestBirds){const e=p(D.x,D.y,D.z);if(!e)continue;const i=D.size*g/e.z;if(i<1)continue;const s=.7*Math.sin(D.wingPhase),o=D.anger||0,a=Math.min(255,107+30*o),n=Math.max(0,68-10*o),l=Math.max(0,35-7*o),r="swooping"===D.state,h=o>0?`rgb(${a}, ${n}, ${l})`:r?"#8b4513":"#6b4423",c=o>0?`rgb(${Math.min(255,a+30)}, ${n+20}, ${l+10})`:r?"#a0522d":"#8b7355";t.fillStyle=h,t.beginPath(),t.ellipse(e.x,e.y,.6*i,.5*i,0,0,2*Math.PI),t.fill(),o>=3&&(t.shadowColor="#ff0000",t.shadowBlur=3*o),t.fillStyle=c;const d=1.2*i,u=.8*i*(1+s);t.beginPath(),t.moveTo(e.x,e.y),t.quadraticCurveTo(e.x-.4*d,e.y-u,e.x-d,e.y),t.quadraticCurveTo(e.x-.4*d,e.y+.2*i,e.x,e.y),t.fill(),t.beginPath(),t.moveTo(e.x,e.y),t.quadraticCurveTo(e.x+.4*d,e.y-u,e.x+d,e.y),t.quadraticCurveTo(e.x+.4*d,e.y+.2*i,e.x,e.y),t.fill(),t.fillStyle=h,t.beginPath(),t.arc(e.x+.4*i,e.y-.15*i,.25*i,0,2*Math.PI),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(e.x+.45*i,e.y-.2*i,.08*i,0,2*Math.PI),t.fill(),t.fillStyle="#ff6600",t.beginPath(),t.moveTo(e.x+.6*i,e.y-.15*i),t.lineTo(e.x+.85*i,e.y-.1*i),t.lineTo(e.x+.6*i,e.y-.05*i),t.fill(),t.fillStyle=c,t.beginPath(),t.moveTo(e.x-.4*i,e.y),t.lineTo(e.x-.9*i,e.y-.1*i),t.lineTo(e.x-.95*i,e.y+.05*i),t.lineTo(e.x-.85*i,e.y+.15*i),t.lineTo(e.x-.4*i,e.y+.1*i),t.fill(),t.shadowBlur=0,t.shadowColor="transparent"}if(this.blueBirds)for(const D of this.blueBirds){const e=p(D.x,D.y,D.z);if(!e)continue;const i=Math.max(8,25/e.z),s=.5*i*(1+.6*Math.sin(D.wingPhase));t.fillStyle="#1e90ff",t.beginPath(),t.ellipse(e.x,e.y,.5*i,.3*i,0,0,2*Math.PI),t.fill(),t.fillStyle="#00bfff";const o=1.2*i;t.beginPath(),t.moveTo(e.x,e.y),t.quadraticCurveTo(e.x-.5*o,e.y-s,e.x-o,e.y),t.quadraticCurveTo(e.x-.5*o,e.y+.2*i,e.x,e.y),t.fill(),t.beginPath(),t.moveTo(e.x,e.y),t.quadraticCurveTo(e.x+.5*o,e.y-s,e.x+o,e.y),t.quadraticCurveTo(e.x+.5*o,e.y+.2*i,e.x,e.y),t.fill(),t.fillStyle="#ff0000",t.beginPath(),t.arc(e.x+.3*i,e.y-.1*i,.15*i,0,2*Math.PI),t.fill()}if(this.fish)for(const D of this.fish){const e=p(D.x,D.y,D.z);if(!e)continue;const i=Math.max(4,30*D.size/e.z),s=.2*Math.sin(D.swimPhase);t.save(),t.translate(e.x,e.y),t.rotate(Math.atan2(D.vz,D.vx)+s),t.fillStyle=D.color,t.beginPath(),t.ellipse(0,0,i,.4*i,0,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(.8*-i,0),t.lineTo(1.5*-i,.4*-i),t.lineTo(1.5*-i,.4*i),t.closePath(),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(.5*i,.1*-i,.15*i,0,2*Math.PI),t.fill(),t.restore()}if(this.cats)for(const D of this.cats){const e=p(D.x,D.y+.3,D.z);if(!e)continue;const i=Math.max(10,40/e.z),s=Math.sin(D.walkPhase)*i*.05;t.fillStyle=D.color,t.beginPath(),t.ellipse(e.x,e.y+s,.6*i,.4*i,0,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(e.x+.5*i,e.y-.2*i+s,.35*i,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(e.x+.3*i,e.y-.5*i+s),t.lineTo(e.x+.4*i,e.y-.2*i+s),t.lineTo(e.x+.5*i,e.y-.5*i+s),t.fill(),t.beginPath(),t.moveTo(e.x+.6*i,e.y-.5*i+s),t.lineTo(e.x+.7*i,e.y-.2*i+s),t.lineTo(e.x+.5*i,e.y-.5*i+s),t.fill(),t.fillStyle="#00ff00",t.beginPath(),t.ellipse(e.x+.4*i,e.y-.25*i+s,.08*i,.12*i,0,0,2*Math.PI),t.fill(),t.beginPath(),t.ellipse(e.x+.6*i,e.y-.25*i+s,.08*i,.12*i,0,0,2*Math.PI),t.fill(),t.strokeStyle=D.color,t.lineWidth=.1*i,t.lineCap="round",t.beginPath(),t.moveTo(e.x-.5*i,e.y+s),t.quadraticCurveTo(e.x-.8*i,e.y-.3*i,e.x-.7*i,e.y-.5*i),t.stroke()}if(this.creepers)for(const D of this.creepers){const e=p(D.x,D.y+.8,D.z);if(!e)continue;const i=Math.max(15,50/e.z),s="fusing"===D.state&&D.flashing?"#ffffff":"#00aa00";t.fillStyle=s,t.fillRect(e.x-.3*i,e.y-.5*i,.6*i,i),t.fillRect(e.x-.35*i,e.y-.9*i,.7*i,.5*i),t.fillStyle="#000",t.fillRect(e.x-.25*i,e.y-.8*i,.15*i,.15*i),t.fillRect(e.x+.1*i,e.y-.8*i,.15*i,.15*i),t.fillRect(e.x-.2*i,e.y-.55*i,.1*i,.15*i),t.fillRect(e.x+.1*i,e.y-.55*i,.1*i,.15*i),t.fillRect(e.x-.1*i,e.y-.5*i,.2*i,.1*i),t.fillStyle=s,t.fillRect(e.x-.3*i,e.y+.4*i,.2*i,.3*i),t.fillRect(e.x+.1*i,e.y+.4*i,.2*i,.3*i)}if(this.repairNPC){const e=this.repairNPC,i=p(e.x,e.y+1.2,e.z);if(i){const s=2*g/i.z,o=Math.min(400,Math.max(20,s));t.fillStyle="#4169e1",t.fillRect(i.x-.175*o,i.y-.15*o,.35*o,.4*o),t.fillStyle="#d2b48c",t.beginPath(),t.arc(i.x,i.y-.3*o,.15*o,0,2*Math.PI),t.fill(),t.fillStyle="#191970",t.beginPath(),t.moveTo(i.x-.175*o,i.y-.4*o),t.lineTo(i.x,i.y-.65*o),t.lineTo(i.x+.175*o,i.y-.4*o),t.closePath(),t.fill(),t.fillRect(i.x-.2*o,i.y-.425*o,.4*o,.05*o),t.fillStyle="#ddd",t.beginPath(),t.moveTo(i.x-.1*o,i.y-.25*o),t.lineTo(i.x-.075*o,i.y-.1*o),t.lineTo(i.x+.075*o,i.y-.1*o),t.lineTo(i.x+.1*o,i.y-.25*o),t.closePath(),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(i.x-.06*o,i.y-.325*o,.025*o,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i.x+.06*o,i.y-.325*o,.025*o,0,2*Math.PI),t.fill(),e.showPrompt&&(t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(i.x-80,i.y-.5*o-40,160,30),t.fillStyle="#ffd700",t.font="14px Arial",t.textAlign="center",t.fillText("[E] Talk to Gunsmith",i.x,i.y-.5*o-22))}}for(const D of this.particles){const e=p(D.x,D.y,D.z);if(e)if("bullet"===D.type){const i=D.x-this.camera.x,s=D.y-this.camera.y,o=D.z-this.camera.z;let a=!1;for(let t=.3;t<.95;t+=.2){const e=this.camera.x+i*t,n=this.camera.y+s*t,l=this.camera.z+o*t,r=this.getBlock(Math.floor(e),Math.floor(n),Math.floor(l));if(r&&!this.fluidBlocks.includes(r)){a=!0;break}}if(a)continue;if(D.trail.length>1){t.strokeStyle="rgba(255, 200, 50, 0.8)",t.lineWidth=2,t.beginPath();let i=!1;for(let e=0;e<D.trail.length;e++){const s=p(D.trail[e].x,D.trail[e].y,D.trail[e].z);s&&(i?t.lineTo(s.x,s.y):(t.moveTo(s.x,s.y),i=!0))}i&&(t.lineTo(e.x,e.y),t.stroke())}const n=Math.max(2,8/e.z);t.fillStyle="#ffcc00",t.beginPath(),t.arc(e.x,e.y,n,0,2*Math.PI),t.fill()}else if("ricochet"===D.type||"spark"===D.type){const i=Math.max(1,20*(D.size||3)/e.z),s=Math.min(1,D.life/15);t.fillStyle=`rgba(255, ${150+100*Math.random()}, 50, ${s})`,t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill()}else if("blessing"===D.type){const i=Math.max(2,20*(D.size||4)/e.z),s=Math.min(1,D.life/30),o=.5*Math.sin(.3*D.life)+.5;t.fillStyle=`rgba(255, 215, 0, ${.3*s})`,t.beginPath(),t.arc(e.x,e.y,2*i,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, ${200+55*o}, ${100+155*o}, ${s})`,t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, 255, 255, ${s*o})`,t.beginPath(),t.arc(e.x,e.y,.3*i,0,2*Math.PI),t.fill()}else if("explosion"===D.type){const i=Math.max(3,25*(D.size||5)/e.z),s=Math.min(1,D.life/20),o=.3*Math.random()+.7;t.fillStyle=`rgba(255, 100, 0, ${.4*s})`,t.beginPath(),t.arc(e.x,e.y,1.5*i,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, ${150+100*Math.random()}, 0, ${s*o})`,t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, 255, ${100*Math.random()}, ${.8*s})`,t.beginPath(),t.arc(e.x,e.y,.4*i,0,2*Math.PI),t.fill()}else if("feather"===D.type){const i=Math.max(2,15/e.z),s=Math.min(1,D.life/20);t.save(),t.translate(e.x,e.y),t.rotate(D.rotation),t.fillStyle=`rgba(139, 90, 43, ${s})`,t.beginPath(),t.ellipse(0,0,2*i,.5*i,0,0,2*Math.PI),t.fill(),t.strokeStyle=`rgba(100, 60, 30, ${s})`,t.lineWidth=1,t.beginPath(),t.moveTo(2*-i,0),t.lineTo(2*i,0),t.stroke(),t.restore()}else if("petal"===D.type){const i=D.x-this.camera.x,s=D.y-this.camera.y,o=D.z-this.camera.z;let a=!1;for(let t=.2;t<.9;t+=.25){const e=this.camera.x+i*t,n=this.camera.y+s*t,l=this.camera.z+o*t,r=this.getBlock(Math.floor(e),Math.floor(n),Math.floor(l));if(r&&!this.fluidBlocks.includes(r)){a=!0;break}}if(a)continue;const n=Math.max(2,15*(D.size||4)/e.z),l=Math.min(1,D.life/50);t.save(),t.translate(e.x,e.y),t.rotate(D.rotation),t.fillStyle=`rgba(255, 183, 197, ${l})`,t.beginPath(),t.ellipse(0,0,1.5*n,.7*n,0,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, 150, 170, ${l})`,t.beginPath(),t.ellipse(0,0,.5*n,.3*n,0,0,2*Math.PI),t.fill(),t.restore()}else if("burger"===D.type){const i=Math.max(3,20*(D.size||8)/e.z);t.save(),t.translate(e.x,e.y),t.fillStyle="#D2691E",t.beginPath(),t.ellipse(0,.3*-i,i,.5*i,0,Math.PI,0),t.fill(),t.fillStyle="#654321",t.fillRect(-i,.2*-i,2*i,.4*i),t.fillStyle="#228B22",t.fillRect(.9*-i,.1*i,1.8*i,.15*i),t.fillStyle="#DEB887",t.beginPath(),t.ellipse(0,.3*i,i,.4*i,0,0,Math.PI),t.fill(),t.restore()}else if("burgerSplat"===D.type){const i=Math.max(2,10*(D.size||4)/e.z),s=Math.min(1,D.life/10),o=["#D2691E","#654321","#228B22","#FF6347"];t.fillStyle=o[Math.floor(Math.random()*o.length)].replace(")",`, ${s})`).replace("rgb","rgba"),t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill()}else if("apple"===D.type){const i=Math.max(3,18*(D.size||6)/e.z);t.save(),t.translate(e.x,e.y),t.fillStyle="#dc143c",t.beginPath(),t.arc(0,0,i,0,2*Math.PI),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(.3*-i,.3*-i,.4*i,0,2*Math.PI),t.fill(),t.fillStyle="#654321",t.fillRect(-1,-i-3,2,4),t.fillStyle="#228b22",t.beginPath(),t.ellipse(3,-i-1,4,2,.3,0,2*Math.PI),t.fill(),t.restore()}else if("appleSplat"===D.type){const i=Math.max(2,8*(D.size||3)/e.z),s=Math.min(1,D.life/10);t.fillStyle=`rgba(220, 20, 60, ${s})`,t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill()}}if(this.droppedItems){const e=400;for(const i of this.droppedItems){const s=i.x-o,l=i.y-a,r=i.z-n;if(s*s+l*l+r*r>e)continue;let h=!1;for(let t=.15;t<.9;t+=.2){const e=o+s*t,i=a+l*t,c=n+r*t,d=this.getBlock(Math.floor(e),Math.floor(i),Math.floor(c));if(d&&!this.fluidBlocks.includes(d)){h=!0;break}}if(h)continue;const c=.08*Math.sin(.8*i.bobPhase),d=p(i.x,i.y+c+.15,i.z);if(!d||d.z<=0)continue;const u=Math.max(6,30/d.z);this.drawDroppedItem3D(t,d.x,d.y,u,i.type,.5*i.bobPhase),i.count>1&&(t.font=`bold ${Math.max(8,.5*u)}px monospace`,t.fillStyle="#fff",t.strokeStyle="#000",t.lineWidth=2,t.textAlign="center",t.strokeText(i.count.toString(),d.x+.5*u,d.y+.4*u),t.fillText(i.count.toString(),d.x+.5*u,d.y+.4*u))}}if(!this.isPaused&&this.pointerLocked){const e=this.raycast();if(e&&e.hit){const i=e.hit.x,s=e.hit.y,o=e.hit.z,a=.005,n=[[i-a,s-a,o-a],[i+1+a,s-a,o-a],[i+1+a,s+1+a,o-a],[i-a,s+1+a,o-a],[i-a,s-a,o+1+a],[i+1+a,s-a,o+1+a],[i+1+a,s+1+a,o+1+a],[i-a,s+1+a,o+1+a]].map(t=>p(t[0],t[1],t[2]));if(this.debugSettings.showTargetInfo&&n.every(t=>null!==t)){const e=n.reduce((t,e)=>t+e.x,0)/8,a=n.reduce((t,e)=>t+e.y,0)/8;t.strokeStyle="#f0f",t.lineWidth=4,t.beginPath(),t.arc(e,a,25,0,2*Math.PI),t.stroke(),t.fillStyle="#f0f",t.font="bold 12px monospace",t.fillText("WIREFRAME",e+30,a-5),t.fillText(`(${i},${s},${o})`,e+30,a+10)}if(n.every(t=>null!==t)){let i="rgba(0, 0, 0, 0.8)",s=2;e.throughWater?(i="rgba(74, 144, 217, 0.7)",s=3):e.throughLava&&(i="rgba(255, 100, 0, 0.7)",s=3),t.strokeStyle=i,t.lineWidth=s;const o=[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];t.beginPath();for(const[e,a]of o)t.moveTo(n[e].x,n[e].y),t.lineTo(n[a].x,n[a].y);t.stroke()}const l=this.getBlock(i,s,o);this.updateBlockTooltip(l)}else this.updateBlockTooltip(null)}if(this.debugSettings.showCoords&&(t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(e-200,10,190,80),t.fillStyle="#0f0",t.font="12px monospace",t.textAlign="left",t.fillText(`X: ${this.camera.x.toFixed(2)}`,e-190,28),t.fillText(`Y: ${this.camera.y.toFixed(2)}`,e-190,43),t.fillText(`Z: ${this.camera.z.toFixed(2)}`,e-190,58),t.fillText(`Blocks: ${Object.keys(this.world).length}`,e-190,73),t.fillText(`Birds: ${this.pestBirds.length}`,e-190,88)),this.renderPlayerModel(t,d,u,e,i),!this.isPaused&&this.pointerLocked&&(t.strokeStyle="#fff",t.lineWidth=2,t.beginPath(),t.moveTo(d-10,u),t.lineTo(d+10,u),t.moveTo(d,u-10),t.lineTo(d,u+10),t.stroke()),this.birdEvent&&this.birdEvent.alertMessage&&this.birdEvent.alertFade>0){const i=Math.min(1,this.birdEvent.alertFade/1e3),s=.8+.2*Math.sin(.01*Date.now());t.save(),t.globalAlpha=i,t.fillStyle=`rgba(0, 0, 0, ${.7*s})`;const o=Math.min(.8*e,500),a=60,n=(e-o)/2,l=80;t.fillRect(n,l,o,a),t.strokeStyle=`rgba(255, 100, 100, ${s})`,t.lineWidth=3,t.strokeRect(n,l,o,a),t.fillStyle=`rgba(255, 255, 255, ${s})`,t.font="bold 20px monospace",t.textAlign="center",t.fillText(this.birdEvent.alertMessage,e/2,l+38),t.restore()}if(this.birdEvent&&!this.isPaused){const i=Math.max(0,this.birdEvent.timer),s=`üê¶ ${Math.floor(i/6e4)}:${Math.floor(i%6e4/1e3).toString().padStart(2,"0")}`;t.save(),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(e-100,10,90,25),t.fillStyle=i<6e4?"#ff6666":"#fff",t.font="14px monospace",t.textAlign="right",t.fillText(s,e-15,28),t.restore()}if("ka69"===this.selectedItem&&!this.isPaused){const s=.0055*Math.min(e,i),o=.75*e,a=.78*i;t.save(),t.translate(o,a),t.rotate(-.1),t.fillStyle="#d4a574",t.beginPath(),t.ellipse(45*s,25*s,18*s,12*s,.3,0,2*Math.PI),t.fill(),t.fillStyle="#c49a6c";for(let e=0;e<4;e++)t.beginPath(),t.ellipse((35+7*e)*s,35*s,4*s,8*s,.2,0,2*Math.PI),t.fill();t.fillStyle="#d4a574",t.beginPath(),t.ellipse(30*s,15*s,6*s,10*s,-.5,0,2*Math.PI),t.fill(),t.fillStyle="#5a3d2b",t.beginPath(),t.moveTo(80*s,-5*s),t.lineTo(160*s,0*s),t.lineTo(165*s,25*s),t.lineTo(155*s,30*s),t.lineTo(80*s,25*s),t.closePath(),t.fill(),t.fillStyle="#6b4d3b",t.fillRect(100*s,2*s,50*s,8*s),t.fillRect(95*s,15*s,55*s,6*s),t.fillStyle="#333",t.fillRect(155*s,-2*s,8*s,30*s),t.fillStyle="#2a2a2a",t.fillRect(-30*s,-8*s,115*s,30*s),t.fillStyle="#3a3a3a",t.fillRect(-25*s,-12*s,100*s,8*s),t.fillStyle="#1a1a1a",t.fillRect(15*s,-6*s,25*s,12*s),t.fillStyle="#1a1a1a",t.fillRect(-140*s,-4*s,115*s,14*s),t.fillStyle="#111",t.fillRect(-180*s,0*s,45*s,8*s),t.fillStyle="#000",t.beginPath(),t.ellipse(-182*s,4*s,3*s,3*s,0,0,2*Math.PI),t.fill(),t.fillStyle="#333",t.fillRect(-130*s,-10*s,100*s,5*s),t.fillStyle="#111";for(let e=0;e<4;e++)t.beginPath(),t.ellipse((22*e-120)*s,3*s,6*s,3*s,0,0,2*Math.PI),t.fill();t.fillStyle="#1a1a1a",t.fillRect(-145*s,-20*s,6*s,18*s),t.fillRect(-148*s,-22*s,12*s,4*s),t.fillRect(-5*s,-18*s,15*s,8*s),t.fillStyle="#333",t.beginPath(),t.moveTo(10*s,22*s),t.lineTo(35*s,22*s),t.quadraticCurveTo(45*s,50*s,35*s,80*s),t.lineTo(15*s,85*s),t.quadraticCurveTo(5*s,55*s,10*s,22*s),t.closePath(),t.fill(),t.strokeStyle="#222",t.lineWidth=1.5*s;for(let e=0;e<4;e++)t.beginPath(),t.moveTo((12+2*e)*s,(35+12*e)*s),t.lineTo((32+1*e)*s,(38+12*e)*s),t.stroke();t.fillStyle="#5a3d2b",t.beginPath(),t.moveTo(45*s,22*s),t.lineTo(65*s,22*s),t.lineTo(70*s,65*s),t.lineTo(45*s,70*s),t.closePath(),t.fill(),t.fillStyle="#4a2d1b";for(let e=0;e<5;e++)t.fillRect(50*s,(28+8*e)*s,12*s,3*s);if(t.strokeStyle="#2a2a2a",t.lineWidth=3*s,t.beginPath(),t.arc(25*s,35*s,15*s,-.8,2.2),t.stroke(),t.fillStyle="#222",t.fillRect(22*s,28*s,4*s,12*s),this.muzzleFlash>0){const e=25+20*Math.random(),i=-190*s,o=4*s;t.fillStyle="rgba(255, 100, 0, 0.5)",t.beginPath(),t.arc(i,o,e*s*1.5,0,2*Math.PI),t.fill(),t.fillStyle="rgba(255, 150, 0, 0.8)",t.beginPath(),t.arc(i,o,e*s,0,2*Math.PI),t.fill(),t.fillStyle="#ffff00",t.beginPath(),t.arc(i,o,e*s*.4,0,2*Math.PI),t.fill(),t.strokeStyle="#ffff88",t.lineWidth=2;for(let a=0;a<6;a++){const e=Math.PI+1.5*(Math.random()-.5),a=(20+35*Math.random())*s;t.beginPath(),t.moveTo(i,o),t.lineTo(i+Math.cos(e)*a,o+Math.sin(e)*a),t.stroke()}}t.restore()}if(this.hotbarTooltip.visible){const s=Date.now()-this.hotbarTooltip.timestamp,o=1e3,a=500;let n=1;if(s>o&&(n=1-Math.min(1,(s-o)/a)),n>0){const o=24*(1+.1*Math.sin(.01*s)),a=e/2,l=i-120;t.save(),t.textAlign="center",t.textBaseline="middle",t.shadowColor="rgba(0, 0, 0, 0.8)",t.shadowBlur=8,t.shadowOffsetX=2,t.shadowOffsetY=2,t.font=`bold ${o}px Arial`,t.fillStyle=`rgba(255, 255, 255, ${n})`,t.fillText(this.hotbarTooltip.text,a,l),t.restore()}}if(this.headSubmergedWater&&(t.fillStyle="rgba(0, 100, 200, 0.25)",t.fillRect(0,0,e,i)),this.headSubmergedLava){const s=.005*Date.now();t.fillStyle="rgba(255, 80, 0, 0.4)",t.fillRect(0,0,e,i),t.fillStyle="rgba(255, 50, 0, 0.6)";for(let a=0;a<12;a++){const o=a/12*e,n=60+30*Math.sin(s+.8*a)+20*Math.sin(1.5*s+a);t.beginPath(),t.moveTo(o-30,i),t.quadraticCurveTo(o,i-n,o+30,i),t.fill()}t.fillStyle="rgba(255, 100, 0, 0.5)";for(let i=0;i<8;i++){const o=i/8*e+40,a=40+25*Math.sin(.8*s+1.2*i);t.beginPath(),t.moveTo(o-25,0),t.quadraticCurveTo(o,a,o+25,0),t.fill()}t.fillStyle="rgba(255, 60, 0, 0.5)";for(let a=0;a<6;a++){const o=a/6*i,n=40+20*Math.sin(s+a);t.beginPath(),t.moveTo(0,o-30),t.quadraticCurveTo(n,o,0,o+30),t.fill(),t.beginPath(),t.moveTo(e,o-30),t.quadraticCurveTo(e-n,o,e,o+30),t.fill()}const o=t.createRadialGradient(e/2,i/2,0,e/2,i/2,.7*e);o.addColorStop(0,"rgba(255, 50, 0, 0)"),o.addColorStop(.7,"rgba(255, 30, 0, 0.3)"),o.addColorStop(1,"rgba(200, 0, 0, 0.6)"),t.fillStyle=o,t.fillRect(0,0,e,i)}},project(t,e,i){const s=t-this.camera.x,o=e-this.camera.y,a=i-this.camera.z,n=Math.cos(-this.camera.rotY),l=Math.sin(-this.camera.rotY),r=s*n-a*l,h=s*l+a*n,c=Math.cos(-this.camera.rotX),d=Math.sin(-this.camera.rotX),u=o*c-h*d,g=o*d+h*c;if(g<=.1)return null;return{x:this.canvas.width/2+r/g*400,y:this.canvas.height/2-u/g*400,z:g}},updateBlockTooltip(t){const e=document.getElementById("blockTooltip");if(!e)return;const i=t?{petalSocket:{name:"Petal Socket",item:"Requires: Sakura Petal",desc:"Place a cherry blossom petal here"},ropeSocket:{name:"Rope Socket",item:"Requires: Sacred Rope",desc:"Place a shimenawa rope here"},charmSocket:{name:"Charm Socket",item:"Requires: Omamori",desc:"Place the protective charm here"},plaqueSocket:{name:"Plaque Socket",item:"Requires: Wish Plaque",desc:"Place a wooden ema here"},incenseSocket:{name:"Incense Socket",item:"Requires: Incense",desc:"Place purifying incense here"},petalSocketFilled:{name:"Petal Socket ‚úì",item:"FILLED",desc:"Cherry petal placed!"},ropeSocketFilled:{name:"Rope Socket ‚úì",item:"FILLED",desc:"Sacred rope placed!"},charmSocketFilled:{name:"Charm Socket ‚úì",item:"FILLED",desc:"Charm placed!"},plaqueSocketFilled:{name:"Plaque Socket ‚úì",item:"FILLED",desc:"Wish plaque placed!"},incenseSocketFilled:{name:"Incense Socket ‚úì",item:"FILLED",desc:"Incense placed!"}}[t]:null;if(i){e.classList.add("active"),e.querySelector(".tooltip-title").textContent=i.name;const t="FILLED"===i.item;e.querySelector(".tooltip-desc").innerHTML=`<span style="color:${t?"#4f4":"#ffd700"}">${i.item}</span><br>${i.desc}`}else e.classList.remove("active")},renderPlayerModel(t,e,i,s,o){const a=Math.max(0,2*this.camera.rotX);if(a<.05)return void this.renderHeldItem(t,e,i,s,o);const n=Math.min(1,a);t.save();const l=o-50+200*(1-a);this.drawPlayerBody3D(t,e,l,n,a),t.restore(),this.renderHeldItem(t,e,i,s,o)},renderHeldItem(t,e,i,s,o){const a=this.inventory.hotbar[this.selectedSlot];if(!a)return;const n=a.id,l=s-120,r=o-100+3*Math.sin(.003*Date.now());t.save(),t.translate(l,r),t.rotate(-.2),t.fillStyle="#ffdab9",t.beginPath(),t.ellipse(0,20,25,35,.3,0,2*Math.PI),t.fill();const h=this.blockColors[n];if(h){const e=30;t.translate(0,-10),t.fillStyle=h.top,t.beginPath(),t.moveTo(0,-e),t.lineTo(e,-e/2),t.lineTo(0,0),t.lineTo(-e,-e/2),t.closePath(),t.fill(),t.fillStyle=h.side,t.beginPath(),t.moveTo(-e,-e/2),t.lineTo(0,0),t.lineTo(0,e),t.lineTo(-e,e/2),t.closePath(),t.fill(),t.fillStyle=this.darkenColor(h.side,.7),t.beginPath(),t.moveTo(0,0),t.lineTo(e,-e/2),t.lineTo(e,e/2),t.lineTo(0,e),t.closePath(),t.fill()}else if("ka69"===n)t.fillStyle="#333",t.fillRect(-30,-20,80,15),t.fillStyle="#8b4513",t.fillRect(-10,-5,25,25),t.fillStyle="#222",t.fillRect(10,-5,8,20);else if("berdger"===n)t.fillStyle="#daa520",t.beginPath(),t.ellipse(0,-15,25,12,0,Math.PI,0),t.fill(),t.fillStyle="#8b4513",t.fillRect(-22,-8,44,10),t.fillStyle="#228b22",t.fillRect(-20,0,40,5),t.fillStyle="#daa520",t.beginPath(),t.ellipse(0,10,23,10,0,0,Math.PI),t.fill();else if("apple"===n)t.fillStyle="#dc143c",t.beginPath(),t.arc(0,-5,20,0,2*Math.PI),t.fill(),t.fillStyle="#654321",t.fillRect(-2,-30,4,10),t.fillStyle="#228b22",t.beginPath(),t.ellipse(5,-28,8,4,.5,0,2*Math.PI),t.fill();else if("water_bucket"===n||"lava_bucket"===n)t.fillStyle="#888",t.beginPath(),t.moveTo(-20,-25),t.lineTo(20,-25),t.lineTo(15,15),t.lineTo(-15,15),t.closePath(),t.fill(),t.fillStyle="water_bucket"===n?"#4a90d9":"#ff6600",t.fillRect(-15,-15,30,25);else if("seeds"===n){t.fillStyle="#daa520";for(let e=0;e<5;e++)t.beginPath(),t.ellipse(10*Math.cos(e),8*Math.sin(e)-10,4,6,e,0,2*Math.PI),t.fill()}t.restore()},drawPlayerBody3D(t,e,i,s,o){t.save();const a=t.createLinearGradient(e-50,i,e+50,i);a.addColorStop(0,`rgba(180, 130, 150, ${s})`),a.addColorStop(.3,`rgba(255, 183, 197, ${s})`),a.addColorStop(.7,`rgba(255, 183, 197, ${s})`),a.addColorStop(1,`rgba(180, 130, 150, ${s})`),t.fillStyle=a,t.beginPath(),t.moveTo(e-35,i+5),t.lineTo(e+35,i+5),t.quadraticCurveTo(e+50,i+40,e+45,i+80),t.lineTo(e-45,i+80),t.quadraticCurveTo(e-50,i+40,e-35,i+5),t.closePath(),t.fill(),t.fillStyle=`rgba(255, 240, 245, ${.8*s})`,t.beginPath(),t.moveTo(e-20,i+5),t.lineTo(e,i+25),t.lineTo(e+20,i+5),t.closePath(),t.fill();const n=t.createRadialGradient(e-55,i+30,0,e-55,i+30,30);n.addColorStop(0,`rgba(255, 228, 205, ${s})`),n.addColorStop(1,`rgba(220, 180, 160, ${s})`),t.fillStyle=n,t.beginPath(),t.ellipse(e-52,i+35,14,28,-.2,0,2*Math.PI),t.fill();const l=t.createRadialGradient(e+55,i+30,0,e+55,i+30,30);l.addColorStop(0,`rgba(255, 228, 205, ${s})`),l.addColorStop(1,`rgba(220, 180, 160, ${s})`),t.fillStyle=l,t.beginPath(),t.ellipse(e+52,i+35,14,28,.2,0,2*Math.PI),t.fill(),t.fillStyle=`rgba(255, 218, 195, ${s})`,t.beginPath(),t.arc(e-55,i+60,12,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(e+55,i+60,12,0,2*Math.PI),t.fill();const r=t.createLinearGradient(e-40,i+75,e+40,i+75);r.addColorStop(0,`rgba(50, 70, 100, ${s})`),r.addColorStop(.3,`rgba(70, 90, 120, ${s})`),r.addColorStop(.7,`rgba(70, 90, 120, ${s})`),r.addColorStop(1,`rgba(50, 70, 100, ${s})`),t.fillStyle=r,t.beginPath(),t.roundRect(e-38,i+78,28,55,3),t.fill(),t.beginPath(),t.roundRect(e+10,i+78,28,55,3),t.fill(),t.fillStyle=`rgba(100, 60, 30, ${s})`,t.beginPath(),t.roundRect(e-42,i+128,35,20,4),t.fill(),t.beginPath(),t.roundRect(e+7,i+128,35,20,4),t.fill(),t.fillStyle=`rgba(255, 255, 255, ${.2*s})`,t.beginPath(),t.ellipse(e-30,i+133,8,3,0,0,2*Math.PI),t.fill(),t.beginPath(),t.ellipse(e+20,i+133,8,3,0,0,2*Math.PI),t.fill(),t.restore()},generateTexture(t,e,i){const s=`${t}_${i}_${e}`;if(this.textureCache[s])return this.textureCache[s];const o=32,a=document.createElement("canvas");a.width=o,a.height=o;const n=a.getContext("2d"),l=(t=>{if(t.startsWith("rgba")){const e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);return{r:parseInt(e[1]),g:parseInt(e[2]),b:parseInt(e[3])}}return{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16)}})(e),r=t=>{const e=1e4*Math.sin(t);return e-Math.floor(e)};if("grass"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=.3*r(1e3*e+t)-.15,s=Math.max(0,Math.min(255,l.r+l.r*i)),o=Math.max(0,Math.min(255,l.g+l.g*i)),a=Math.max(0,Math.min(255,l.b+l.b*i));n.fillStyle=`rgb(${Math.floor(s)},${Math.floor(o)},${Math.floor(a)})`,n.fillRect(e,t,1,1)}if("top"===i){n.fillStyle="rgba(90, 160, 70, 0.4)";for(let t=0;t<12;t++){const e=Math.floor(r(123*t)*o),i=Math.floor(r(456*t)*o);n.fillRect(e,i,2,3)}}}else if("dirt"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=1e3*e+t,s=.25*r(i)-.125+(.15*r(i+999)-.075),o=Math.max(0,Math.min(255,l.r+l.r*s)),a=Math.max(0,Math.min(255,l.g+l.g*s)),h=Math.max(0,Math.min(255,l.b+l.b*s));n.fillStyle=`rgb(${Math.floor(o)},${Math.floor(a)},${Math.floor(h)})`,n.fillRect(e,t,1,1)}n.fillStyle="rgba(100, 80, 60, 0.3)";for(let t=0;t<8;t++){const e=Math.floor(r(789*t)*o),i=Math.floor(r(321*t)*o);n.fillRect(e,i,2,2)}}else if("brick"===t){const t=8,e=16,i=2;n.fillStyle=`rgb(${Math.floor(.6*l.r)},${Math.floor(.6*l.g)},${Math.floor(.6*l.b)})`,n.fillRect(0,0,o,o);for(let s=0;s<Math.ceil(o/t);s++){const a=s%2*(e/2);for(let h=-1;h<Math.ceil(o/e)+1;h++){const o=h*e+a,c=s*t,d=100*s+h,u=.15*r(d)-.075,g=Math.max(0,Math.min(255,l.r+l.r*u)),f=Math.max(0,Math.min(255,l.g+l.g*u)),m=Math.max(0,Math.min(255,l.b+l.b*u));n.fillStyle=`rgb(${Math.floor(g)},${Math.floor(f)},${Math.floor(m)})`,n.fillRect(o,c,e-i,t-i),n.fillStyle=`rgba(0,0,0,${.1*r(d+50)})`,n.fillRect(o,c,e-i,t-i)}}}else if("leaves"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=.4*r(1e3*e+t)-.2,s=Math.max(0,Math.min(255,l.r+l.r*i)),o=Math.max(0,Math.min(255,l.g+l.g*i)),a=Math.max(0,Math.min(255,l.b+l.b*i));n.fillStyle=`rgb(${Math.floor(s)},${Math.floor(o)},${Math.floor(a)})`,n.fillRect(e,t,1,1)}n.fillStyle="rgba(0, 50, 0, 0.3)";for(let t=0;t<15;t++){const e=Math.floor(r(234*t)*o),i=Math.floor(r(567*t)*o),s=2+Math.floor(3*r(890*t)),a=2+Math.floor(3*r(345*t));n.fillRect(e,i,s,a)}}else if("sakuraLeaves"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=.35*r(1e3*e+t)-.175,s=Math.max(0,Math.min(255,l.r+l.r*i)),o=Math.max(0,Math.min(255,l.g+l.g*i)),a=Math.max(0,Math.min(255,l.b+l.b*i));n.fillStyle=`rgb(${Math.floor(s)},${Math.floor(o)},${Math.floor(a)})`,n.fillRect(e,t,1,1)}for(let t=0;t<12;t++){const e=Math.floor(r(111*t)*o),i=Math.floor(r(222*t)*o),s=2+Math.floor(3*r(333*t));n.fillStyle="rgba(255, 220, 230, 0.5)",n.beginPath(),n.ellipse(e,i,s,.6*s,r(444*t)*Math.PI,0,2*Math.PI),n.fill()}n.fillStyle="rgba(180, 100, 120, 0.4)";for(let t=0;t<10;t++){const e=Math.floor(r(555*t)*o),i=Math.floor(r(666*t)*o),s=1+Math.floor(2*r(777*t)),a=1+Math.floor(2*r(888*t));n.fillRect(e,i,s,a)}n.fillStyle="rgba(255, 255, 255, 0.3)";for(let t=0;t<5;t++){const e=Math.floor(r(999*t)*o),i=Math.floor(r(1111*t)*o);n.fillRect(e,i,1,1)}}else if("water"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=1e3*e+t,s=.15*Math.sin(.4*(e+5*r(i)))+.1*Math.cos(.3*(t+5*r(i+500)))+.2*r(i)-.1,o=Math.max(0,Math.min(255,l.r+l.r*s)),a=Math.max(0,Math.min(255,l.g+l.g*s)),h=Math.max(0,Math.min(255,l.b+l.b*s));n.fillStyle=`rgb(${Math.floor(o)},${Math.floor(a)},${Math.floor(h)})`,n.fillRect(e,t,1,1)}for(let t=0;t<25;t++){const e=Math.floor(r(123*t)*o),i=Math.floor(r(456*t)*o),s=1+Math.floor(2*r(789*t));n.fillStyle="rgba(200, 230, 255, 0.6)",n.beginPath(),n.arc(e,i,s,0,2*Math.PI),n.fill(),n.fillStyle="rgba(255, 255, 255, 0.8)",n.fillRect(e,i,1,1)}n.fillStyle="rgba(150, 220, 255, 0.25)";for(let t=0;t<8;t++){const e=Math.floor(r(321*t)*o),i=Math.floor(r(654*t)*o),s=3+Math.floor(4*r(987*t));n.fillRect(e,i,s,1)}}else if("lava"===t){for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=1e3*e+t,s=.2*Math.sin(.3*e+.2*t+3*r(i))+(r(i+100)>.85?.3:0)+.15*r(i)-.075,o=r(i+200)>.7?30:0,a=Math.max(0,Math.min(255,l.r+l.r*s+o)),h=Math.max(0,Math.min(255,l.g+l.g*s+.8*o)),c=Math.max(0,Math.min(255,l.b+l.b*s));n.fillStyle=`rgb(${Math.floor(a)},${Math.floor(h)},${Math.floor(c)})`,n.fillRect(e,t,1,1)}for(let t=0;t<12;t++){const e=Math.floor(r(111*t)*o),i=Math.floor(r(222*t)*o),s=2+Math.floor(3*r(333*t));n.fillStyle="rgba(255, 200, 50, 0.7)",n.beginPath(),n.arc(e,i,s,0,2*Math.PI),n.fill(),n.fillStyle="rgba(255, 255, 200, 0.9)",n.fillRect(e-1,i-1,2,2)}n.strokeStyle="rgba(80, 20, 0, 0.4)",n.lineWidth=1;for(let t=0;t<6;t++){const e=Math.floor(r(444*t)*o),i=Math.floor(r(555*t)*o);n.beginPath(),n.moveTo(e,i),n.lineTo(e+8*r(666*t)-4,i+6*r(777*t)),n.stroke()}}else if("wood"===t)if("top"===i){for(let i=0;i<o;i++)for(let t=0;t<o;t++){const e=.15*r(1e3*t+i)-.075,s=Math.max(0,Math.min(255,l.r+l.r*e)),o=Math.max(0,Math.min(255,l.g+l.g*e)),a=Math.max(0,Math.min(255,l.b+l.b*e));n.fillStyle=`rgb(${Math.floor(s)},${Math.floor(o)},${Math.floor(a)})`,n.fillRect(t,i,1,1)}const t=16,e=16;for(let i=1;i<6;i++){const s=4*i+3*r(50*i);n.strokeStyle=`rgba(0, 0, 0, ${.1+.1*r(100*i)})`,n.lineWidth=.5+1*r(200*i),n.beginPath(),n.arc(t,e,s,0,2*Math.PI),n.stroke()}}else{for(let t=0;t<o;t++)for(let e=0;e<o;e++){const i=.2*r(10*e+1e3*t)-.1,s=Math.max(0,Math.min(255,l.r+l.r*i)),o=Math.max(0,Math.min(255,l.g+l.g*i)),a=Math.max(0,Math.min(255,l.b+l.b*i));n.fillStyle=`rgb(${Math.floor(s)},${Math.floor(o)},${Math.floor(a)})`,n.fillRect(e,t,1,1)}n.strokeStyle="rgba(0, 0, 0, 0.15)",n.lineWidth=1;for(let t=0;t<8;t++){const e=Math.floor(r(333*t)*o),i=3*r(444*t);n.beginPath(),n.moveTo(e,0);for(let s=0;s<o;s+=2){const o=Math.sin(.3*s+t)*i;n.lineTo(e+o,s)}n.stroke()}n.fillStyle="rgba(0, 0, 0, 0.2)";for(let t=0;t<3;t++)if(r(555*t)>.7){const e=Math.floor(r(666*t)*o),i=Math.floor(r(777*t)*o*.8);n.fillRect(i,e,4,1)}}const h=n.createPattern(a,"repeat");return this.textureCache[s]=h,h},darkenColor(t,e){const i=t+e;if(this.colorCache||(this.colorCache={}),this.colorCache[i])return this.colorCache[i];const s=`rgb(${Math.floor(parseInt(t.slice(1,3),16)*e)},${Math.floor(parseInt(t.slice(3,5),16)*e)},${Math.floor(parseInt(t.slice(5,7),16)*e)})`;return this.colorCache[i]=s,s},gameLoop(t){if(!this.isActive)return void(this.gameLoopId=null);this.lastFrameTime||(this.lastFrameTime=t);const e=1e3/this.settings.targetFps,i=t-this.lastFrameTime;if(i>=e){if(this.lastFrameTime=t-i%e,this.fpsCounter.frames++,t-this.fpsCounter.lastTime>=1e3){this.fpsCounter.fps=this.fpsCounter.frames,this.fpsCounter.frames=0,this.fpsCounter.lastTime=t;const e=document.getElementById("debugFps");e&&(e.textContent=`${this.fpsCounter.fps} FPS`)}if(!this.isPaused){this.update(),this.updateBirds(),this.updateParticles(),this.updateFluids(),this.updateWind(),this.updatePetals(),this.updateDroppedItems(),this.render(),this.settings.showFps&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(this.canvas.width-70,this.canvas.height-25,65,20),this.ctx.fillStyle="#00ff00",this.ctx.font="12px monospace",this.ctx.textAlign="right",this.ctx.fillText(`${this.fpsCounter.fps} FPS`,this.canvas.width-10,this.canvas.height-10),this.ctx.textAlign="left");const t=this.debugSettings.renderAlgorithm.toUpperCase(),e={PAINTER:"#00ff00",ZBUFFER:"#00ffff",BSP:"#ff00ff"};this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(this.canvas.width-90,5,85,20),this.ctx.fillStyle=e[t]||"#ffffff",this.ctx.font="bold 12px monospace",this.ctx.textAlign="right",this.ctx.fillText(t,this.canvas.width-10,18),this.ctx.textAlign="left"}}this.gameLoopId=requestAnimationFrame(t=>this.gameLoop(t))},async start(){document.getElementById("minecraftGame").classList.add("active"),document.getElementById("loadingScreen").classList.add("active"),document.getElementById("clickToPlay").classList.remove("active"),await this.fullInit(),window.game=this,this.isActive=!0,this.isPaused=!1,this.pointerLocked=!1,this.stats={blocksPlaced:0,blocksBroken:0,distance:0,jumps:0,startTime:Date.now()},document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("gameUI").style.display="flex";const t=(()=>{const t=(t,e)=>{let i=null;for(let f=40;f>=0;f--){const s=this.getBlock(t,f,e);if(s&&"water"!==s&&"lava"!==s){i=f;break}}if(null===i)return null;let s=!1;for(let f=i+1;f<=i+10;f++){const i=this.getBlock(t,f,e);if(i&&"water"!==i&&"lava"!==i){s=!0;break}}if(s)return null;let o=!1;for(let f=-2;f<=2;f++){for(let s=-2;s<=2;s++){for(let a=1;a<=5;a++){const n=this.getBlock(t+f,i+a,e+s);if(n&&"water"!==n&&"lava"!==n){o=!0;break}}if(o)break}if(o)break}if(o)return null;const a=i+1,n=i+2,l=this.getBlock(t,a,e),r=this.getBlock(t,n,e),h=!l||"water"===l||"lava"===l,c=!r||"water"===r||"lava"===r,d=this.getBlock(t,i,e),u="water"!==d&&"lava"!==d&&"sand"!==d;let g=!0;for(let f=-1;f<=1;f++){for(let s=-1;s<=1;s++){if(0===f&&0===s)continue;let o=null;for(let i=40;i>=0;i--){const a=this.getBlock(t+f,i,e+s);if(a&&"water"!==a&&"lava"!==a){o=i;break}}if(null===o||Math.abs(o-i)>1){g=!1;break}}if(!g)break}return h&&c&&g?{x:t,y:a+this.playerEyeHeight,z:e,priority:u?1:2}:null};let e=t(0,-8);if(e&&1===e.priority)return e;for(let i=1;i<=30;i++){for(let s=-i;s<=i;s++)for(let o=-i;o<=i;o++){if(Math.abs(s)!==i&&Math.abs(o)!==i)continue;const a=t(0+s,-8+o);if(a){if(1===a.priority)return a;(!e||a.priority<e.priority)&&(e=a)}}if(e&&i>5)return e}return{x:0,y:30,z:0}})();this.camera={x:t.x+.5,y:t.y,z:t.z+.5,rotX:-.3,rotY:0},this.canvas.style.filter="",this.velocity={x:0,y:0,z:0},this.isJumping=!1,this.inWater=!1,this.inLava=!1,this.swimming=!1,this.lastSwimTime=0,this.headSubmergedWater=!1,this.headSubmergedLava=!1,this.particles=[],this.fluidUpdates=[],this.birdEvent={timer:3e5,lastUpdate:Date.now(),currentEvent:0,events:[{name:"SWARM",description:"the birds will swarm!",action:()=>this.triggerBirdSwarm()},{name:"RAGE",description:"the birds will rage!",action:()=>this.triggerBirdRage()},{name:"MULTIPLY",description:"the birds will multiply!",action:()=>this.triggerBirdMultiply()},{name:"CREEPER INVASION",description:"creepers will stalk you!",action:()=>this.triggerCreeperInvasion()}],alertShown:{five:!1,three:!1,one:!1,thirty:!1,ten:!1},alertMessage:null,alertFade:0},this.survivalStats={score:0,wave:1,birdsDefeated:0,objectiveTimer:0,currentObjective:null,objectives:[{text:"Survive the bird apocalypse!",type:"survive"},{text:"Find the Ritual Temple",type:"find_temple"},{text:"Collect 5 apples",type:"collect",item:"apple",count:5},{text:"Knock back 10 birds",type:"knockback",count:10},{text:"Complete the Omamori ritual",type:"ritual"}]},this.survivalStats.currentObjective=this.survivalStats.objectives[0],this.updateSurvivalHUD();const e=document.getElementById("petalCanvas");e&&(e.style.display="none");const i=document.getElementById("flameParticles");i&&(i.style.visibility="hidden"),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",document.getElementById("clickToPlay").classList.add("active"),this.gameLoopId&&cancelAnimationFrame(this.gameLoopId),setTimeout(()=>{this.updateHotbarDisplay(),this.updateHotbar()},50),this.gameLoop()},pause(){this.isActive&&(this.isPaused=!0,document.getElementById("pauseMenu").classList.add("active"),document.getElementById("gameUI").style.display="none",document.getElementById("clickToPlay").classList.remove("active"),this.showSubmenu("menuMain"),document.pointerLockElement&&document.exitPointerLock())},resume(){this.isPaused=!1,document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("gameUI").style.display="flex",document.getElementById("clickToPlay").classList.add("active")},updateFullscreenButton(){const t=document.getElementById("btnFullscreen"),e=document.fullscreenElement||document.webkitFullscreenElement;t.textContent=e?"Windowed":"Fullscreen",e?(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight):(this.canvas.width=800,this.canvas.height=450)},stop(){if(this.gameLoopId&&(cancelAnimationFrame(this.gameLoopId),this.gameLoopId=null),this.isActive=!1,this.isPaused=!1,this.pointerLocked=!1,this.particles=[],this.fluidUpdates=[],this.fluidUpdateTimer=0,this.birdPruneTimer=0,this.inWater=!1,this.inLava=!1,this.swimming=!1,this.lastSwimTime=0,this.headSubmergedWater=!1,this.headSubmergedLava=!1,this.pestBirds)for(const i of this.pestBirds)i.anger=0,i.timesShot=0,i.state="circling";this.canvas.width=800,this.canvas.height=450,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),document.getElementById("minecraftGame").classList.remove("active"),document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("clickToPlay").classList.remove("active"),document.getElementById("inventoryScreen").classList.remove("active"),this.inventoryOpen=!1,this.canvas.style.filter="",document.pointerLockElement&&document.exitPointerLock(),(document.fullscreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()),this.keys={},document.body.style.overflow="",document.documentElement.style.overflow="";const t=document.getElementById("petalCanvas");t&&(t.style.display="block");const e=document.getElementById("flameParticles");e&&(e.style.visibility="visible")}};window.minecraftGame=t;class e{_game;_initialized;constructor(){this._game=t,this._initialized=!1}init(t={}){if(!document.getElementById("minecraftGame")){let e=document.body;t.container&&(e="string"==typeof t.container?document.querySelector(t.container)||document.body:t.container),function(t=document.body){const e=document.createElement("div");for(e.innerHTML='\n\x3c!-- SakuraCraft Game HTML Template --\x3e\n\x3c!-- This file is inserted into the DOM when the game initializes --\x3e\n\n<div class="minecraft-overlay" id="minecraftGame">\n  <div class="minecraft-title">üå∏ SakuraCraft üå∏</div>\n  <div class="minecraft-container">\n    <button class="minecraft-close" id="closeMinecraft">‚úï Close</button>\n    <canvas id="gameCanvas" class="minecraft-canvas" width="800" height="500"></canvas>\n    \n    \x3c!-- World Generation Loading Screen --\x3e\n    <div class="loading-screen active" id="loadingScreen">\n      <div class="loading-content">\n        <div class="loading-title">üå∏ Generating World üå∏</div>\n        <div class="loading-phase" id="loadingPhase">Initializing...</div>\n        <div class="loading-bar-container">\n          <div class="loading-bar" id="loadingBar"></div>\n        </div>\n        <div class="loading-percent" id="loadingPercent">0%</div>\n        <div class="loading-details" id="loadingDetails"></div>\n        <div class="loading-biome-preview" id="biomePreview">\n          <div class="biome-icon" id="biomeIcon">üå≤</div>\n          <div class="biome-name" id="biomeName">Forest</div>\n        </div>\n        <div class="loading-tips" id="loadingTips">\n          <div class="tip-text">üí° Tip: Press E to open your inventory</div>\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Click to Play Overlay (required for pointer lock) --\x3e\n    <div class="click-to-play" id="clickToPlay">\n      <div class="click-to-play-text">üéÆ Click to Play</div>\n      <div class="click-to-play-hint">Mouse will be captured ‚Ä¢ Press ESC to pause</div>\n    </div>\n    \n    \x3c!-- Pause Menu --\x3e\n    <div class="pause-menu" id="pauseMenu">\n      \x3c!-- Main Menu --\x3e\n      <div class="pause-submenu active" id="menuMain">\n        <div class="pause-title">‚è∏ Paused</div>\n        <div class="pause-buttons">\n          <button class="pause-btn resume" id="btnResume">Resume</button>\n          <button class="pause-btn fullscreen" id="btnFullscreen">Fullscreen</button>\n          <button class="pause-btn disabled" id="btnAccount">Sign In</button>\n          <button class="pause-btn" id="btnStats">Stats</button>\n          <button class="pause-btn" id="btnOptions">Options</button>\n          <button class="pause-btn quit" id="btnQuit">Quit Game</button>\n        </div>\n      </div>\n      \n      \x3c!-- Stats Menu --\x3e\n      <div class="pause-submenu" id="menuStats">\n        <div class="submenu-title">üìä Statistics</div>\n        <div class="submenu-content">\n          <div class="stat-row">\n            <span>Blocks Placed</span>\n            <span class="stat-value" id="statPlaced">0</span>\n          </div>\n          <div class="stat-row">\n            <span>Blocks Broken</span>\n            <span class="stat-value" id="statBroken">0</span>\n          </div>\n          <div class="stat-row">\n            <span>Distance Walked</span>\n            <span class="stat-value" id="statDistance">0m</span>\n          </div>\n          <div class="stat-row">\n            <span>Jumps</span>\n            <span class="stat-value" id="statJumps">0</span>\n          </div>\n          <div class="stat-row">\n            <span>Play Time</span>\n            <span class="stat-value" id="statTime">0:00</span>\n          </div>\n        </div>\n        <button class="back-btn" id="statsBack">‚Üê Back</button>\n      </div>\n      \n      \x3c!-- Options Menu --\x3e\n      <div class="pause-submenu" id="menuOptions">\n        <div class="submenu-title">‚öôÔ∏è Options</div>\n        <div class="submenu-content">\n          <div class="option-row">\n            <span>Brightness</span>\n            <input type="range" class="option-slider" id="optBrightness" min="50" max="150" value="100">\n          </div>\n          <div class="option-row">\n            <span>Color Filter</span>\n            <select class="option-select" id="optFilter">\n              <option value="none">Normal</option>\n              <option value="sepia">Sepia</option>\n              <option value="grayscale">Black & White</option>\n              <option value="trippy">Trippy Hyperbolic</option>\n            </select>\n          </div>\n          <div class="option-row">\n            <span>Render Distance</span>\n            <select class="option-select" id="optRenderDist">\n              <option value="12">Near (Fast)</option>\n              <option value="18">Medium</option>\n              <option value="25" selected>Far</option>\n              <option value="35">Ultra</option>\n            </select>\n          </div>\n          <div class="option-row">\n            <span>Shadows</span>\n            <div class="option-toggle on" id="optShadows" data-on="true"></div>\n          </div>\n          <div class="option-row">\n            <span>Enhanced Lighting</span>\n            <div class="option-toggle on" id="optLighting" data-on="true"></div>\n          </div>\n          <div class="option-row">\n            <span>Anti-Aliasing</span>\n            <div class="option-toggle" id="optAA" data-on="false"></div>\n          </div>\n          <div class="option-row">\n            <span>Tree Style</span>\n            <select class="option-select" id="optTreeStyle">\n              <option value="simple" selected>Simple (Fast)</option>\n              <option value="transparent">Fancy</option>\n              <option value="bushy">Fancy + Wind</option>\n            </select>\n          </div>\n          <div class="option-row">\n            <span>Texture Mode</span>\n            <select class="option-select" id="optTextureMode">\n              <option value="fixed" selected>Fixed (Stable)</option>\n              <option value="trippy">Trippy (Chowder)</option>\n              <option value="vacuum">Trippy (Vacuum)</option>\n            </select>\n          </div>\n          <div class="option-row">\n            <span>Show FPS</span>\n            <div class="option-toggle on" id="optShowFps" data-on="true"></div>\n          </div>\n          <div class="option-row">\n            <span>Target FPS: <span id="targetFpsValue">60</span></span>\n            <input type="range" min="15" max="240" value="60" class="option-slider" id="optTargetFps">\n          </div>\n        </div>\n        <button class="back-btn" id="optionsBack">‚Üê Back</button>\n      </div>\n    </div>\n    \n    \x3c!-- Inventory Screen --\x3e\n    <div class="inventory-screen" id="inventoryScreen">\n      \x3c!-- Content populated by JavaScript --\x3e\n    </div>\n    \n    \x3c!-- Container Screen (Chests, Barrels, etc) --\x3e\n    <div class="container-screen" id="containerScreen">\n      <div class="container-ui">\n        <div class="container-header">\n          <span class="container-title" id="containerTitle">Chest</span>\n          <button class="container-close" id="containerClose">‚úï</button>\n        </div>\n        <div class="container-content">\n          <div class="container-slots" id="containerSlots">\n            \x3c!-- Container slots populated by JS --\x3e\n          </div>\n          <div class="container-divider"></div>\n          <div class="player-inventory-mini">\n            <div class="inventory-label">Your Inventory</div>\n            <div class="player-slots" id="playerSlotsInContainer">\n              \x3c!-- Player inventory slots populated by JS --\x3e\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <div class="minecraft-ui" id="gameUI">\n      <div class="hotbar-slot selected" data-block="grass"></div>\n      <div class="hotbar-slot" data-block="dirt"></div>\n      <div class="hotbar-slot" data-block="stone"></div>\n      <div class="hotbar-slot" data-block="wood"></div>\n      <div class="hotbar-slot" data-block="brick"></div>\n      <div class="hotbar-slot" data-item="water_bucket"></div>\n      <div class="hotbar-slot" data-item="lava_bucket"></div>\n      <div class="hotbar-slot" data-item="ka69"></div>\n      <div class="hotbar-slot" data-empty="true"></div>\n    </div>\n    <div class="pickup-notification" id="pickupNotification"></div>\n    \n    \x3c!-- Survival HUD --\x3e\n    <div id="survivalHUD" style="position:absolute;top:10px;left:10px;color:#fff;font-family:monospace;font-size:14px;text-shadow:1px 1px 2px #000;pointer-events:none;">\n      <div id="scoreDisplay">Score: 0</div>\n      <div id="waveDisplay">Wave: 1</div>\n      <div id="objectiveDisplay"></div>\n    </div>\n    \n    \x3c!-- Debug Console --\x3e\n    <div class="debug-console" id="debugConsole">\n      <div class="debug-console-header">\n        <span>Debug Console (` to toggle)</span>\n        <span id="debugFps">0 FPS</span>\n      </div>\n      <div class="debug-console-output" id="debugOutput"></div>\n      <div class="debug-console-input">\n        <span>&gt;</span>\n        <input type="text" id="debugInput" placeholder="Type command...">\n      </div>\n    </div>\n    \n    \x3c!-- Block Tooltip --\x3e\n    <div class="block-tooltip" id="blockTooltip">\n      <div class="tooltip-title"></div>\n      <div class="tooltip-desc"></div>\n    </div>\n  </div>\n  <div class="minecraft-instructions">\n    WASD move | SPACE jump/swim | SHIFT swim down | Q drop | R ritual | SCROLL hotbar | LEFT break | RIGHT use/place | E inventory | ` debug\n  </div>\n</div>\n';e.firstChild;)t.appendChild(e.firstChild)}(e)}if(this._game.init(),this._initialized=!0,t.trigger){const e="string"==typeof t.trigger?document.querySelector(t.trigger):t.trigger;e&&(e.addEventListener("click",()=>this.start()),e.style.cursor="pointer")}return document.getElementById("closeMinecraft")?.addEventListener("click",()=>this.stop()),document.getElementById("clickToPlay")?.addEventListener("click",()=>{this._game.isActive&&!this._game.isPaused&&this._game.canvas&&this._game.canvas.requestPointerLock()}),window.addEventListener("beforeunload",()=>{this._game.isActive&&this.stop()}),this}start(){return this._initialized||this.init(),this._game.start(),this}stop(){return this._game.stop(),this}pause(){return this._game.pause(),this}resume(){return this._game.resume(),this}getStats(){return{...this._game.stats}}get settings(){return this._game.settings}set settings(t){Object.assign(this._game.settings,t)}get isActive(){return this._game.isActive}get isPaused(){return this._game.isPaused}get engine(){return this._game}}if("undefined"!=typeof window){window.SakuraCraft=e,window.SakuraCraftGame=e;const t=document.currentScript;if(t?.hasAttribute("data-auto-init")){const i=t.getAttribute("data-trigger");document.addEventListener("DOMContentLoaded",()=>{const t=new e;t.init({trigger:i??void 0}),window.sakuraCraft=t})}}export{e as SakuraCraftGame,e as default,t as minecraftGame};
